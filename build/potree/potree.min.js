"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Potree(){}function updateVisibilityStructures(e,t,i){for(var o=[],n=[],r=new BinaryHeap(function(e){return 1/e.weight}),s=0;s<e.length;s++){var a=e[s];if(a.initialized()){a.numVisibleNodes=0,a.numVisiblePoints=0,a.visibleNodes=[],a.visibleGeometry=[],t.updateMatrixWorld();var l=new THREE.Frustum,d=t.matrixWorldInverse,c=a.matrixWorld,u=t.projectionMatrix,h=(new THREE.Matrix4).multiply(u).multiply(d).multiply(c);l.setFromMatrix(h),o.push(l);var p=t.matrixWorld,m=(new THREE.Matrix4).getInverse(c),f=(new THREE.Matrix4).multiply(m).multiply(p),v=(new THREE.Vector3).setFromMatrixPosition(f);n.push(v),a.visible&&null!==a.root&&r.push({pointcloud:s,node:a.root,weight:Number.MAX_VALUE}),a.root.isTreeNode()&&a.hideDescendants(a.root.sceneNode);for(var g=0;g<a.boundingBoxNodes.length;g++)a.boundingBoxNodes[g].visible=!1}}return{frustums:o,camObjPositions:n,priorityQueue:r}}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function LRUItem(e){this.previous=null,this.next=null,this.node=e}function LRU(){this.first=null,this.last=null,this.items={},this.elements=0,this.numPoints=0}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Potree.version={major:1,minor:4,suffix:"RC"},console.log("Potree "+Potree.version.major+"."+Potree.version.minor+Potree.version.suffix),Potree.pointBudget=1e6,Potree.workers={},Potree.Shaders={},Potree.webgl={shaders:{},vaos:{},vbos:{}},Potree.scriptPath=null,document.currentScript.src?Potree.scriptPath=new URL(document.currentScript.src+"/..").href:console.error("Potree was unable to find its script path using document.currentScript. Is Potree included with a script tag? Does your browser support this function?"),Potree.resourcePath=Potree.scriptPath+"/resources",Potree.timerQueries={},Potree.timerQueriesEnabled=!1,Potree.startQuery=function(e,t){if(!Potree.timerQueriesEnabled)return null;void 0===Potree.timerQueries[e]&&(Potree.timerQueries[e]=[]);var i=t.getExtension("EXT_disjoint_timer_query"),o=i.createQueryEXT();return i.beginQueryEXT(i.TIME_ELAPSED_EXT,o),Potree.timerQueries[e].push(o),o},Potree.endQuery=function(e,t){if(Potree.timerQueriesEnabled){var i=t.getExtension("EXT_disjoint_timer_query");i.endQueryEXT(i.TIME_ELAPSED_EXT)}},Potree.resolveQueries=function(e){if(Potree.timerQueriesEnabled){var t=e.getExtension("EXT_disjoint_timer_query");for(var i in Potree.timerQueries){var o=Potree.timerQueries[i];if(o.length>0){var n=o[0],r=t.getQueryObjectEXT(n,t.QUERY_RESULT_AVAILABLE_EXT),s=viewer.renderer.getContext().getParameter(t.GPU_DISJOINT_EXT);if(r&&!s){var a=t.getQueryObjectEXT(n,t.QUERY_RESULT_EXT),l=a/1e6;console.log(i+": "+l+"ms"),o.shift()}}0===o.length&&delete Potree.timerQueries[i]}}},Potree.loadPointCloud=function(e,t,i){var o=function(e){e.name=t,i({type:"pointcloud_loaded",pointcloud:e})};e&&(e.indexOf("cloud.js")>0?Potree.POCLoader.load(e,function(e){if(e){var t=new Potree.PointCloudOctree(e);o(t)}else i({type:"loading_failed"})}.bind(this)):e.indexOf(".vpc")>0?Potree.PointCloudArena4DGeometry.load(e,function(e){if(e){var t=new Potree.PointCloudArena4D(e);o(t)}else i({type:"loading_failed"})}):i({type:"loading_failed"}))},Potree.updatePointClouds=function(e,t,i){Potree.lru||(Potree.lru=new LRU);for(var o=0;o<e.length;o++)for(var n=e[o],r=0;r<n.profileRequests.length;r++)n.profileRequests[r].update();for(var s=Potree.updateVisibility(e,t,i),a=0;a<e.length;a++){var l=e[a];l.updateMaterial(l.material,l.visibleNodes,t,i),l.updateVisibleBounds()}return Potree.getLRU().freeMemory(),s},Potree.getLRU=function(){return Potree.lru||(Potree.lru=new LRU),Potree.lru},Potree.updateVisibility=function(e,t,i){for(var o=0,n=0,r=[],s=[],a=[],l=updateVisibilityStructures(e,t,i),d=l.frustums,c=l.camObjPositions,u=l.priorityQueue;u.size()>0;){var h=u.pop(),p=h.node,m=h.parent,f=e[h.pointcloud],v=p.getBoundingBox(),g=d[h.pointcloud],y=c[h.pointcloud],E=g.intersectsBox(v),b=E;b=b&&!(n+p.getNumPoints()>Potree.pointBudget);var T=f.maxLevel||1/0;if(b=b&&p.getLevel()<T,n+p.getNumPoints()>Potree.pointBudget)break;if(b){if(o++,n+=p.getNumPoints(),f.numVisibleNodes++,f.numVisiblePoints+=p.getNumPoints(),!p.isGeometryNode()||m&&!m.isTreeNode()||(p.isLoaded()?p=f.toTreeNode(p,m):(a.push(p),s.push(p))),p.isTreeNode())if(Potree.getLRU().touch(p.geometryNode),p.sceneNode.visible=!0,p.sceneNode.material=f.material,r.push(p),f.visibleNodes.push(p),p.parent?p.sceneNode.matrixWorld.multiplyMatrices(p.parent.sceneNode.matrixWorld,p.sceneNode.matrix):p.sceneNode.matrixWorld.multiplyMatrices(f.matrixWorld,p.sceneNode.matrix),f.showBoundingBox&&!p.boundingBoxNode){var P=new THREE.BoxHelper(p.sceneNode);f.add(P),f.boundingBoxNodes.push(P),p.boundingBoxNode=P,p.boundingBoxNode.matrixWorld.copy(p.sceneNode.matrixWorld)}else f.showBoundingBox?(p.boundingBoxNode.visible=!0,p.boundingBoxNode.matrixWorld.copy(p.sceneNode.matrixWorld)):!f.showBoundingBox&&p.boundingBoxNode&&(p.boundingBoxNode.visible=!1);for(var R=p.getChildren(),C=0;C<R.length;C++){var w=R[C],x=w.getBoundingSphere(),S=x.center.distanceTo(y),H=x.radius,B=t.fov*Math.PI/180,V=Math.tan(B/2),I=.5*i.domElement.clientHeight/(V*S),A=H*I;if(!(A<f.minimumNodePixelSize)){var M=A;S-H<0&&(M=Number.MAX_VALUE),u.push({pointcloud:h.pointcloud,node:w,parent:p,weight:M})}}}}for(var k=0;k<Math.min(5,a.length);k++)a[k].load();return{visibleNodes:r,numVisiblePoints:n}},Potree.Shader=function e(t,i,o,n){_classCallCheck(this,e),this.vertexShader=t,this.fragmentShader=i,this.program=o,this.uniforms=n},Potree.VBO=function e(t,i,o){_classCallCheck(this,e),this.name=t,this.id=i,this.attribute=o},Potree.VAO=function e(t,i,o){_classCallCheck(this,e),this.id=t,this.geometry=i,this.vbos=o},Potree.compileShader=function(e,t,i){var o=e.createShader(e.VERTEX_SHADER);e.shaderSource(o,t),e.compileShader(o);var n=e.getShaderParameter(o,e.COMPILE_STATUS);if(!n){console.error("could not compile vertex shader:");var r=e.getShaderInfoLog(o);return void console.error(r,t)}var s=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(s,i),e.compileShader(s);var a=e.getShaderParameter(s,e.COMPILE_STATUS);if(!a)return console.error("could not compile fragment shader:"),void console.error(i);var l=e.createProgram();e.attachShader(l,o),e.attachShader(l,s),e.linkProgram(l);var d=e.getProgramParameter(l,e.LINK_STATUS);if(!d)return console.error("could not compile shader:"),console.error(t),void console.error(i);e.useProgram(l);for(var c={},u=e.getProgramParameter(l,e.ACTIVE_UNIFORMS),h=0;h<u;h++){var p=e.getActiveUniform(l,h),m=p.name,f=e.getUniformLocation(l,m);c[m]=f}var v=new Potree.Shader(t,i,l,c);return v},Potree.createVAO=function(e,t){if(1==Potree.vaos[t.uuid])return Potree.vaos[t.uuid];var i=e.getExtension("OES_vertex_array_object"),o=i.createVertexArrayOES();i.bindVertexArrayOES(o);var n={};for(var r in t.attributes){var s=t.attributes[r],a=e.FLOAT;s.array instanceof Uint8Array?a=e.UNSIGNED_BYTE:s.array instanceof Uint16Array?a=e.UNSIGNED_SHORT:s.array instanceof Uint32Array?a=e.UNSIGNED_INT:s.array instanceof Int8Array?a=e.BYTE:s.array instanceof Int16Array?a=e.SHORT:s.array instanceof Int32Array?a=e.INT:s.array instanceof Float32Array&&(a=e.FLOAT);var l=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferData(e.ARRAY_BUFFER,s.array,e.STATIC_DRAW),n[r]=new Potree.VBO(r,l,s)}i.bindVertexArrayOES(null);var d=new Potree.VAO(o,t,n);return Potree.vaos[t.uuid]=d,d},Potree.renderPointcloud=function(e,t,i){var o=i.context,n=(Potree.webgl,e.material);if(null===o.getExtension("OES_vertex_array_object"))return void console.error("OES_vertex_array_object extension not supported");n.needsUpdate&&(Potree.pointcloudShader=Potree.compileShader(o,n.vertexShader,n.fragmentShader),n.needsUpdate=!1);var r=Potree.pointcloudShader,s=r.uniforms;o.useProgram(r.program),o.uniformMatrix4fv(s.projectionMatrix,!1,t.projectionMatrix.elements),o.uniformMatrix4fv(s.viewMatrix,!1,t.matrixWorldInverse.elements),o.uniform1f(s.fov,this.material.fov),o.uniform1f(s.screenWidth,n.screenWidth),o.uniform1f(s.screenHeight,n.screenHeight),o.uniform1f(s.spacing,n.spacing),o.uniform1f(s.near,n.near),o.uniform1f(s.far,n.far),o.uniform1f(s.size,n.size),o.uniform1f(s.minSize,n.minSize),o.uniform1f(s.maxSize,n.maxSize),o.uniform1f(s.octreeSize,e.pcoGeometry.boundingBox.getSize().x);var a=o.getAttribLocation(program,"position"),l=o.getAttribLocation(program,"color"),d=o.getAttribLocation(program,"normal"),c=o.getAttribLocation(program,"classification"),u=o.getAttribLocation(program,"indices");o.enableVertexAttribArray(a),o.enableVertexAttribArray(l),o.enableVertexAttribArray(d),o.enableVertexAttribArray(c),o.enableVertexAttribArray(u);var h=e.visibleNodes,p=!0,m=!1,f=void 0;try{for(var v,g=h[Symbol.iterator]();!(p=(v=g.next()).done);p=!0){var y=v.value,E=y.sceneNode;E.geometry}}catch(e){m=!0,f=e}finally{try{!p&&g.return&&g.return()}finally{if(m)throw f}}},Potree.PointCloudTreeNode=function(){this.getChildren=function(){throw"override function"},this.getBoundingBox=function(){throw"override function"},this.isLoaded=function(){throw"override function"},this.isGeometryNode=function(){throw"override function"},this.isTreeNode=function(){throw"override function"},this.getLevel=function(){throw"override function"},this.getBoundingSphere=function(){throw"override function"}},Potree.PointCloudTree=function(){THREE.Object3D.call(this),this.initialized=function(){return null!==this.root}},Potree.PointCloudTree.prototype=Object.create(THREE.Object3D.prototype),Potree.WorkerManager=function(e){this.code=e,this.instances=[],this.createdInstances=0},Potree.WorkerManager.prototype.getWorker=function(){var e=this.instances.pop();return void 0===e&&(e=Potree.utils.createWorker(this.code),this.createdInstances++),e},Potree.WorkerManager.prototype.returnWorker=function(e){this.instances.push(e)},Potree.WorkerManager.fromUrls=function(e){for(var t="",i=0;i<e.length;i++){var o=e[i],n=new XMLHttpRequest;n.open("GET",o,!1),n.responseType="text",n.overrideMimeType("text/plain; charset=x-user-defined"),n.send(null),200===n.status&&(t+=n.responseText+"\n")}return new Potree.WorkerManager(t)},Potree.workers.binaryDecoder=new Potree.WorkerManager(atob("Ci8vIGh0dHA6Ly9qc3BlcmYuY29tL3VpbnQ4YXJyYXktdnMtZGF0YXZpZXczLzMKZnVuY3Rpb24gQ3VzdG9tVmlldyhidWZmZXIpIHsKCXRoaXMuYnVmZmVyID0gYnVmZmVyOwoJdGhpcy51OCA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlcik7CgkKCXZhciB0bXAgPSBuZXcgQXJyYXlCdWZmZXIoNCk7Cgl2YXIgdG1wZiA9IG5ldyBGbG9hdDMyQXJyYXkodG1wKTsKCXZhciB0bXB1OCA9IG5ldyBVaW50OEFycmF5KHRtcCk7CgkKCXRoaXMuZ2V0VWludDMyID0gZnVuY3Rpb24gKGkpIHsKCQlyZXR1cm4gKHRoaXMudThbaSszXSA8PCAyNCkgfCAodGhpcy51OFtpKzJdIDw8IDE2KSB8ICh0aGlzLnU4W2krMV0gPDwgOCkgfCB0aGlzLnU4W2ldOwoJfTsKCQoJdGhpcy5nZXRVaW50MTYgPSBmdW5jdGlvbiAoaSkgewoJCXJldHVybiAodGhpcy51OFtpKzFdIDw8IDgpIHwgdGhpcy51OFtpXTsKCX07CgkKCXRoaXMuZ2V0RmxvYXQgPSBmdW5jdGlvbihpKXsKCQl0bXB1OFswXSA9IHRoaXMudThbaSswXTsKCQl0bXB1OFsxXSA9IHRoaXMudThbaSsxXTsKCQl0bXB1OFsyXSA9IHRoaXMudThbaSsyXTsKCQl0bXB1OFszXSA9IHRoaXMudThbaSszXTsKCQkKCQlyZXR1cm4gdG1wZlswXTsKCX07CgkKCXRoaXMuZ2V0VWludDggPSBmdW5jdGlvbihpKXsKCQlyZXR1cm4gdGhpcy51OFtpXTsKCX07Cn0KClBvdHJlZSA9IHt9OwoKCm9ubWVzc2FnZSA9IGZ1bmN0aW9uKGV2ZW50KXsKCXZhciBidWZmZXIgPSBldmVudC5kYXRhLmJ1ZmZlcjsKCXZhciBwb2ludEF0dHJpYnV0ZXMgPSBldmVudC5kYXRhLnBvaW50QXR0cmlidXRlczsKCXZhciBudW1Qb2ludHMgPSBidWZmZXIuYnl0ZUxlbmd0aCAvIHBvaW50QXR0cmlidXRlcy5ieXRlU2l6ZTsKCXZhciBjdiA9IG5ldyBDdXN0b21WaWV3KGJ1ZmZlcik7Cgl2YXIgdmVyc2lvbiA9IG5ldyBQb3RyZWUuVmVyc2lvbihldmVudC5kYXRhLnZlcnNpb24pOwoJdmFyIG1pbiA9IGV2ZW50LmRhdGEubWluOwoJdmFyIG5vZGVPZmZzZXQgPSBldmVudC5kYXRhLm9mZnNldDsKCXZhciBzY2FsZSA9IGV2ZW50LmRhdGEuc2NhbGU7Cgl2YXIgdGlnaHRCb3hNaW4gPSBbIE51bWJlci5QT1NJVElWRV9JTkZJTklUWSwgTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLCBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFldOwoJdmFyIHRpZ2h0Qm94TWF4ID0gWyBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkgLCBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkgLCBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkgXTsKCQoJdmFyIGF0dHJpYnV0ZUJ1ZmZlcnMgPSB7fTsKCQoJdmFyIG9mZnNldCA9IDA7Cglmb3IodmFyIGkgPSAwOyBpIDwgcG9pbnRBdHRyaWJ1dGVzLmF0dHJpYnV0ZXMubGVuZ3RoOyBpKyspewoJCXZhciBwb2ludEF0dHJpYnV0ZSA9IHBvaW50QXR0cmlidXRlcy5hdHRyaWJ1dGVzW2ldOwoJCgkJaWYocG9pbnRBdHRyaWJ1dGUubmFtZSA9PT0gUG90cmVlLlBvaW50QXR0cmlidXRlLlBPU0lUSU9OX0NBUlRFU0lBTi5uYW1lKXsKCQkJCgkJCXZhciBidWZmID0gbmV3IEFycmF5QnVmZmVyKG51bVBvaW50cyo0KjMpOwoJCQl2YXIgcG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShidWZmKTsKCQkJCgkJCWZvcih2YXIgaiA9IDA7IGogPCBudW1Qb2ludHM7IGorKyl7CgkJCQlpZih2ZXJzaW9uLm5ld2VyVGhhbigiMS4zIikpewoJCQkJCXBvc2l0aW9uc1szKmorMF0gPSAoY3YuZ2V0VWludDMyKG9mZnNldCArIGoqcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplKzApICogc2NhbGUpICsgbWluWzBdOwoJCQkJCXBvc2l0aW9uc1szKmorMV0gPSAoY3YuZ2V0VWludDMyKG9mZnNldCArIGoqcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplKzQpICogc2NhbGUpICsgbWluWzFdOwoJCQkJCXBvc2l0aW9uc1szKmorMl0gPSAoY3YuZ2V0VWludDMyKG9mZnNldCArIGoqcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplKzgpICogc2NhbGUpICsgbWluWzJdOwoJCQkJfWVsc2V7CgkJCQkJcG9zaXRpb25zWzMqaiswXSA9IGN2LmdldEZsb2F0KGoqcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplKzApICsgbm9kZU9mZnNldFswXTsKCQkJCQlwb3NpdGlvbnNbMypqKzFdID0gY3YuZ2V0RmxvYXQoaipwb2ludEF0dHJpYnV0ZXMuYnl0ZVNpemUrNCkgKyBub2RlT2Zmc2V0WzFdOwoJCQkJCXBvc2l0aW9uc1szKmorMl0gPSBjdi5nZXRGbG9hdChqKnBvaW50QXR0cmlidXRlcy5ieXRlU2l6ZSs4KSArIG5vZGVPZmZzZXRbMl07CgkJCQl9CgkJCQkKCQkJCXRpZ2h0Qm94TWluWzBdID0gTWF0aC5taW4odGlnaHRCb3hNaW5bMF0sIHBvc2l0aW9uc1szKmorMF0pOwoJCQkJdGlnaHRCb3hNaW5bMV0gPSBNYXRoLm1pbih0aWdodEJveE1pblsxXSwgcG9zaXRpb25zWzMqaisxXSk7CgkJCQl0aWdodEJveE1pblsyXSA9IE1hdGgubWluKHRpZ2h0Qm94TWluWzJdLCBwb3NpdGlvbnNbMypqKzJdKTsKCQkJCQoJCQkJdGlnaHRCb3hNYXhbMF0gPSBNYXRoLm1heCh0aWdodEJveE1heFswXSwgcG9zaXRpb25zWzMqaiswXSk7CgkJCQl0aWdodEJveE1heFsxXSA9IE1hdGgubWF4KHRpZ2h0Qm94TWF4WzFdLCBwb3NpdGlvbnNbMypqKzFdKTsKCQkJCXRpZ2h0Qm94TWF4WzJdID0gTWF0aC5tYXgodGlnaHRCb3hNYXhbMl0sIHBvc2l0aW9uc1szKmorMl0pOwoJCQl9CgkJCQoJCQlhdHRyaWJ1dGVCdWZmZXJzW3BvaW50QXR0cmlidXRlLm5hbWVdID0geyBidWZmZXI6IGJ1ZmYsIGF0dHJpYnV0ZTogcG9pbnRBdHRyaWJ1dGV9OwoJCQkKCQl9ZWxzZSBpZihwb2ludEF0dHJpYnV0ZS5uYW1lID09PSBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuQ09MT1JfUEFDS0VELm5hbWUpewoJCQkKCQkJdmFyIGJ1ZmYgPSBuZXcgQXJyYXlCdWZmZXIobnVtUG9pbnRzKjMpOwoJCQl2YXIgY29sb3JzID0gbmV3IFVpbnQ4QXJyYXkoYnVmZik7CgkJCQoJCQlmb3IodmFyIGogPSAwOyBqIDwgbnVtUG9pbnRzOyBqKyspewoJCQkJY29sb3JzWzMqaiswXSA9IGN2LmdldFVpbnQ4KG9mZnNldCArIGoqcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplICsgMCk7CgkJCQljb2xvcnNbMypqKzFdID0gY3YuZ2V0VWludDgob2Zmc2V0ICsgaipwb2ludEF0dHJpYnV0ZXMuYnl0ZVNpemUgKyAxKTsKCQkJCWNvbG9yc1szKmorMl0gPSBjdi5nZXRVaW50OChvZmZzZXQgKyBqKnBvaW50QXR0cmlidXRlcy5ieXRlU2l6ZSArIDIpOwoJCQl9CgkJCQoJCQlhdHRyaWJ1dGVCdWZmZXJzW3BvaW50QXR0cmlidXRlLm5hbWVdID0geyBidWZmZXI6IGJ1ZmYsIGF0dHJpYnV0ZTogcG9pbnRBdHRyaWJ1dGV9OwoJCQkKCQl9ZWxzZSBpZihwb2ludEF0dHJpYnV0ZS5uYW1lID09PSBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuSU5URU5TSVRZLm5hbWUpewoKCQkJdmFyIGJ1ZmYgPSBuZXcgQXJyYXlCdWZmZXIobnVtUG9pbnRzKjQpOwoJCQl2YXIgaW50ZW5zaXRpZXMgPSBuZXcgRmxvYXQzMkFycmF5KGJ1ZmYpOwoJCQkKCQkJZm9yKHZhciBqID0gMDsgaiA8IG51bVBvaW50czsgaisrKXsKCQkJCXZhciBpbnRlbnNpdHkgPSBjdi5nZXRVaW50MTYob2Zmc2V0ICsgaipwb2ludEF0dHJpYnV0ZXMuYnl0ZVNpemUpOwoJCQkJaW50ZW5zaXRpZXNbal0gPSBpbnRlbnNpdHk7CgkJCX0KCQkJCgkJCWF0dHJpYnV0ZUJ1ZmZlcnNbcG9pbnRBdHRyaWJ1dGUubmFtZV0gPSB7IGJ1ZmZlcjogYnVmZiwgYXR0cmlidXRlOiBwb2ludEF0dHJpYnV0ZX07CgkJCgkJfWVsc2UgaWYocG9pbnRBdHRyaWJ1dGUubmFtZSA9PT0gUG90cmVlLlBvaW50QXR0cmlidXRlLkNMQVNTSUZJQ0FUSU9OLm5hbWUpewoKCQkJdmFyIGJ1ZmYgPSBuZXcgQXJyYXlCdWZmZXIobnVtUG9pbnRzKTsKCQkJdmFyIGNsYXNzaWZpY2F0aW9ucyA9IG5ldyBVaW50OEFycmF5KGJ1ZmYpOwoJCQkKCQkJZm9yKHZhciBqID0gMDsgaiA8IG51bVBvaW50czsgaisrKXsKCQkJCXZhciBjbGFzc2lmaWNhdGlvbiA9IGN2LmdldFVpbnQ4KG9mZnNldCArIGoqcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplKTsKCQkJCWNsYXNzaWZpY2F0aW9uc1tqXSA9IGNsYXNzaWZpY2F0aW9uOwoJCQl9CgkJCQoJCQlhdHRyaWJ1dGVCdWZmZXJzW3BvaW50QXR0cmlidXRlLm5hbWVdID0geyBidWZmZXI6IGJ1ZmYsIGF0dHJpYnV0ZTogcG9pbnRBdHRyaWJ1dGV9OwoJCQoJCX1lbHNlIGlmKHBvaW50QXR0cmlidXRlLm5hbWUgPT09IFBvdHJlZS5Qb2ludEF0dHJpYnV0ZS5OT1JNQUxfU1BIRVJFTUFQUEVELm5hbWUpewoKCQkJdmFyIGJ1ZmYgPSBuZXcgQXJyYXlCdWZmZXIobnVtUG9pbnRzKjQqMyk7CgkJCXZhciBub3JtYWxzID0gbmV3IEZsb2F0MzJBcnJheShidWZmKTsKCQkJCgkJCWZvcih2YXIgaiA9IDA7IGogPCBudW1Qb2ludHM7IGorKyl7CgkJCQl2YXIgYnggPSBjdi5nZXRVaW50OChvZmZzZXQgKyBqICogcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplICsgMCk7CgkJCQl2YXIgYnkgPSBjdi5nZXRVaW50OChvZmZzZXQgKyBqICogcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplICsgMSk7CgkJCQoJCQkJdmFyIGV4ID0gYnggLyAyNTU7CgkJCQl2YXIgZXkgPSBieSAvIDI1NTsKCQkJCQoJCQkJdmFyIG54ID0gZXggKiAyIC0gMTsKCQkJCXZhciBueSA9IGV5ICogMiAtIDE7CgkJCQl2YXIgbnogPSAxOwoJCQkJdmFyIG53ID0gLTE7CgkJCQkKCQkJCXZhciBsID0gKG54ICogKC1ueCkpICsgKG55ICogKC1ueSkpICsgKG56ICogKC1udykpOwoJCQkJbnogPSBsOwoJCQkJbnggPSBueCAqIE1hdGguc3FydChsKTsKCQkJCW55ID0gbnkgKiBNYXRoLnNxcnQobCk7CgkJCQkKCQkJCW54ID0gbnggKiAyOwoJCQkJbnkgPSBueSAqIDI7CgkJCQlueiA9IG56ICogMiAtIDE7CgkJCQkKCQkJCW5vcm1hbHNbMypqICsgMF0gPSBueDsKCQkJCW5vcm1hbHNbMypqICsgMV0gPSBueTsKCQkJCW5vcm1hbHNbMypqICsgMl0gPSBuejsKCQkJfQoJCQkKCQkJYXR0cmlidXRlQnVmZmVyc1twb2ludEF0dHJpYnV0ZS5uYW1lXSA9IHsgYnVmZmVyOiBidWZmLCBhdHRyaWJ1dGU6IHBvaW50QXR0cmlidXRlfTsKCQl9ZWxzZSBpZihwb2ludEF0dHJpYnV0ZS5uYW1lID09PSBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuTk9STUFMX09DVDE2Lm5hbWUpewoJCQkKCQkJdmFyIGJ1ZmYgPSBuZXcgQXJyYXlCdWZmZXIobnVtUG9pbnRzKjQqMyk7CgkJCXZhciBub3JtYWxzID0gbmV3IEZsb2F0MzJBcnJheShidWZmKTsKCQkJZm9yKHZhciBqID0gMDsgaiA8IG51bVBvaW50czsgaisrKXsKCQkJCXZhciBieCA9IGN2LmdldFVpbnQ4KG9mZnNldCArIGogKiBwb2ludEF0dHJpYnV0ZXMuYnl0ZVNpemUgKyAwKTsKCQkJCXZhciBieSA9IGN2LmdldFVpbnQ4KG9mZnNldCArIGogKiBwb2ludEF0dHJpYnV0ZXMuYnl0ZVNpemUgKyAxKTsKCQkJCQoJCQkJdmFyIHUgPSAoYnggLyAyNTUpICogMiAtIDE7CgkJCQl2YXIgdiA9IChieSAvIDI1NSkgKiAyIC0gMTsKCQkJCQoJCQkJdmFyIHogPSAxIC0gTWF0aC5hYnModSkgLSBNYXRoLmFicyh2KTsKCQkJCQoJCQkJdmFyIHggPSAwOwoJCQkJdmFyIHkgPSAwOwoJCQkJaWYoeiA+PSAwKXsKCQkJCQl4ID0gdTsKCQkJCQl5ID0gdjsKCQkJCX1lbHNlewoJCQkJCXggPSAtICh2L01hdGguc2lnbih2KSAtIDEpIC8gTWF0aC5zaWduKHUpOwoJCQkJCXkgPSAtICh1L01hdGguc2lnbih1KSAtIDEpIC8gTWF0aC5zaWduKHYpOwoJCQkJfQoJCQkJCgkJCQl2YXIgbGVuZ3RoID0gTWF0aC5zcXJ0KHgqeCArIHkqeSArIHoqeik7CgkJCQl4ID0geCAvIGxlbmd0aDsKCQkJCXkgPSB5IC8gbGVuZ3RoOwoJCQkJeiA9IHogLyBsZW5ndGg7CgkJCQkKCQkJCW5vcm1hbHNbMypqICsgMF0gPSB4OwoJCQkJbm9ybWFsc1szKmogKyAxXSA9IHk7CgkJCQlub3JtYWxzWzMqaiArIDJdID0gejsKCQkJfQoJCQlhdHRyaWJ1dGVCdWZmZXJzW3BvaW50QXR0cmlidXRlLm5hbWVdID0geyBidWZmZXI6IGJ1ZmYsIGF0dHJpYnV0ZTogcG9pbnRBdHRyaWJ1dGV9OwoJCX1lbHNlIGlmKHBvaW50QXR0cmlidXRlLm5hbWUgPT09IFBvdHJlZS5Qb2ludEF0dHJpYnV0ZS5OT1JNQUwubmFtZSl7CgkJCgkJCXZhciBidWZmID0gbmV3IEFycmF5QnVmZmVyKG51bVBvaW50cyo0KjMpOwoJCQl2YXIgbm9ybWFscyA9IG5ldyBGbG9hdDMyQXJyYXkoYnVmZik7CgkJCWZvcih2YXIgaiA9IDA7IGogPCBudW1Qb2ludHM7IGorKyl7CgkJCQl2YXIgeCA9IGN2LmdldEZsb2F0KG9mZnNldCArIGogKiBwb2ludEF0dHJpYnV0ZXMuYnl0ZVNpemUgKyAwKTsKCQkJCXZhciB5ID0gY3YuZ2V0RmxvYXQob2Zmc2V0ICsgaiAqIHBvaW50QXR0cmlidXRlcy5ieXRlU2l6ZSArIDQpOwoJCQkJdmFyIHogPSBjdi5nZXRGbG9hdChvZmZzZXQgKyBqICogcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplICsgOCk7CgkJCQkKCQkJCW5vcm1hbHNbMypqICsgMF0gPSB4OwoJCQkJbm9ybWFsc1szKmogKyAxXSA9IHk7CgkJCQlub3JtYWxzWzMqaiArIDJdID0gejsKCQkJfQoJCQlhdHRyaWJ1dGVCdWZmZXJzW3BvaW50QXR0cmlidXRlLm5hbWVdID0geyBidWZmZXI6IGJ1ZmYsIGF0dHJpYnV0ZTogcG9pbnRBdHRyaWJ1dGV9OwoJCX0KCQkKCQlvZmZzZXQgKz0gcG9pbnRBdHRyaWJ1dGUuYnl0ZVNpemU7Cgl9CgkKCXZhciBpbmRpY2VzID0gbmV3IEFycmF5QnVmZmVyKG51bVBvaW50cyo0KTsKCXZhciBpSW5kaWNlcyA9IG5ldyBVaW50MzJBcnJheShpbmRpY2VzKTsKCWZvcih2YXIgaSA9IDA7IGkgPCBudW1Qb2ludHM7IGkrKyl7CgkJaUluZGljZXNbaV0gPSBpOwoJfQoJCglpZihhdHRyaWJ1dGVCdWZmZXJzW1BvdHJlZS5Qb2ludEF0dHJpYnV0ZS5DTEFTU0lGSUNBVElPTi5uYW1lXSA9PT0gdW5kZWZpbmVkKXsKCQl2YXIgYnVmZiA9IG5ldyBBcnJheUJ1ZmZlcihudW1Qb2ludHMqNCk7CgkJdmFyIGNsYXNzaWZpY2F0aW9ucyA9IG5ldyBGbG9hdDMyQXJyYXkoYnVmZik7CgkJCgkJZm9yKHZhciBqID0gMDsgaiA8IG51bVBvaW50czsgaisrKXsKCQkJY2xhc3NpZmljYXRpb25zW2pdID0gMDsKCQl9CgkJCgkJYXR0cmlidXRlQnVmZmVyc1tQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuQ0xBU1NJRklDQVRJT04ubmFtZV0gPSB7IGJ1ZmZlcjogYnVmZiwgYXR0cmlidXRlOiBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuQ0xBU1NJRklDQVRJT059OwoJfQoJCgkKCXZhciBtZXNzYWdlID0gewoJCWF0dHJpYnV0ZUJ1ZmZlcnM6IGF0dHJpYnV0ZUJ1ZmZlcnMsCgkJdGlnaHRCb3VuZGluZ0JveDogeyBtaW46IHRpZ2h0Qm94TWluLCBtYXg6IHRpZ2h0Qm94TWF4IH0sCgkJaW5kaWNlczogaW5kaWNlcwoJfTsKCQkKCXZhciB0cmFuc2ZlcmFibGVzID0gW107CgkKCWZvcih2YXIgcHJvcGVydHkgaW4gbWVzc2FnZS5hdHRyaWJ1dGVCdWZmZXJzKXsKCQlpZihtZXNzYWdlLmF0dHJpYnV0ZUJ1ZmZlcnMuaGFzT3duUHJvcGVydHkocHJvcGVydHkpKXsKCQkJdHJhbnNmZXJhYmxlcy5wdXNoKG1lc3NhZ2UuYXR0cmlidXRlQnVmZmVyc1twcm9wZXJ0eV0uYnVmZmVyKTsKCQl9Cgl9CgkKCXRyYW5zZmVyYWJsZXMucHVzaChtZXNzYWdlLmluZGljZXMpOwoJCQoJcG9zdE1lc3NhZ2UobWVzc2FnZSwgdHJhbnNmZXJhYmxlcyk7CgkKfTsKUG90cmVlLlZlcnNpb24gPSBmdW5jdGlvbih2ZXJzaW9uKXsKCXRoaXMudmVyc2lvbiA9IHZlcnNpb247Cgl2YXIgdm1MZW5ndGggPSAodmVyc2lvbi5pbmRleE9mKCIuIikgPT09IC0xKSA/IHZlcnNpb24ubGVuZ3RoIDogdmVyc2lvbi5pbmRleE9mKCIuIik7Cgl0aGlzLnZlcnNpb25NYWpvciA9IHBhcnNlSW50KHZlcnNpb24uc3Vic3RyKDAsIHZtTGVuZ3RoKSk7Cgl0aGlzLnZlcnNpb25NaW5vciA9IHBhcnNlSW50KHZlcnNpb24uc3Vic3RyKHZtTGVuZ3RoICsgMSkpOwoJaWYodGhpcy52ZXJzaW9uTWlub3IubGVuZ3RoID09PSAwKXsKCQl0aGlzLnZlcnNpb25NaW5vciA9IDA7Cgl9CgkKfTsKClBvdHJlZS5WZXJzaW9uLnByb3RvdHlwZS5uZXdlclRoYW4gPSBmdW5jdGlvbih2ZXJzaW9uKXsKCXZhciB2ID0gbmV3IFBvdHJlZS5WZXJzaW9uKHZlcnNpb24pOwoJCglpZiggdGhpcy52ZXJzaW9uTWFqb3IgPiB2LnZlcnNpb25NYWpvcil7CgkJcmV0dXJuIHRydWU7Cgl9ZWxzZSBpZiggdGhpcy52ZXJzaW9uTWFqb3IgPT09IHYudmVyc2lvbk1ham9yICYmIHRoaXMudmVyc2lvbk1pbm9yID4gdi52ZXJzaW9uTWlub3IpewoJCXJldHVybiB0cnVlOwoJfWVsc2V7CgkJcmV0dXJuIGZhbHNlOwoJfQp9OwoKUG90cmVlLlZlcnNpb24ucHJvdG90eXBlLmVxdWFsT3JIaWdoZXIgPSBmdW5jdGlvbih2ZXJzaW9uKXsKCXZhciB2ID0gbmV3IFBvdHJlZS5WZXJzaW9uKHZlcnNpb24pOwoJCglpZiggdGhpcy52ZXJzaW9uTWFqb3IgPiB2LnZlcnNpb25NYWpvcil7CgkJcmV0dXJuIHRydWU7Cgl9ZWxzZSBpZiggdGhpcy52ZXJzaW9uTWFqb3IgPT09IHYudmVyc2lvbk1ham9yICYmIHRoaXMudmVyc2lvbk1pbm9yID49IHYudmVyc2lvbk1pbm9yKXsKCQlyZXR1cm4gdHJ1ZTsKCX1lbHNlewoJCXJldHVybiBmYWxzZTsKCX0KfTsKClBvdHJlZS5WZXJzaW9uLnByb3RvdHlwZS51cFRvID0gZnVuY3Rpb24odmVyc2lvbil7CglyZXR1cm4gIXRoaXMubmV3ZXJUaGFuKHZlcnNpb24pOwp9OwpQb3RyZWUuUG9pbnRBdHRyaWJ1dGVOYW1lcyA9IHt9OwoKUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuUE9TSVRJT05fQ0FSVEVTSUFOIAk9IDA7CS8vIGZsb2F0IHgsIHksIHo7ClBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLkNPTE9SX1BBQ0tFRAkJPSAxOwkvLyBieXRlIHIsIGcsIGIsIGE7IAlJID0gWzAsMV0KUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuQ09MT1JfRkxPQVRTXzEJCT0gMjsJLy8gZmxvYXQgciwgZywgYjsgCQlJID0gWzAsMV0KUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuQ09MT1JfRkxPQVRTXzI1NQk9IDM7CS8vIGZsb2F0IHIsIGcsIGI7IAkJSSA9IFswLDI1NV0KUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuTk9STUFMX0ZMT0FUUwkJPSA0OyAgCS8vIGZsb2F0IHgsIHksIHo7ClBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLkZJTExFUgkJCQk9IDU7ClBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLklOVEVOU0lUWQkJCT0gNjsKUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuQ0xBU1NJRklDQVRJT04JCT0gNzsKUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuTk9STUFMX1NQSEVSRU1BUFBFRAk9IDg7ClBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLk5PUk1BTF9PQ1QxNgkJPSA5OwpQb3RyZWUuUG9pbnRBdHRyaWJ1dGVOYW1lcy5OT1JNQUwJCQkJPSAxMDsKCi8qKgogKiBTb21lIHR5cGVzIG9mIHBvc3NpYmxlIHBvaW50IGF0dHJpYnV0ZSBkYXRhIGZvcm1hdHMKICogCiAqIEBjbGFzcwogKi8KUG90cmVlLlBvaW50QXR0cmlidXRlVHlwZXMgPSB7CglEQVRBX1RZUEVfRE9VQkxFCToge29yZGluYWwgOiAwLCBzaXplOiA4fSwKCURBVEFfVFlQRV9GTE9BVAkJOiB7b3JkaW5hbCA6IDEsIHNpemU6IDR9LAoJREFUQV9UWVBFX0lOVDgJCToge29yZGluYWwgOiAyLCBzaXplOiAxfSwKCURBVEFfVFlQRV9VSU5UOAkJOiB7b3JkaW5hbCA6IDMsIHNpemU6IDF9LAoJREFUQV9UWVBFX0lOVDE2CQk6IHtvcmRpbmFsIDogNCwgc2l6ZTogMn0sCglEQVRBX1RZUEVfVUlOVDE2CToge29yZGluYWwgOiA1LCBzaXplOiAyfSwKCURBVEFfVFlQRV9JTlQzMgkJOiB7b3JkaW5hbCA6IDYsIHNpemU6IDR9LAoJREFUQV9UWVBFX1VJTlQzMgk6IHtvcmRpbmFsIDogNywgc2l6ZTogNH0sCglEQVRBX1RZUEVfSU5UNjQJCToge29yZGluYWwgOiA4LCBzaXplOiA4fSwKCURBVEFfVFlQRV9VSU5UNjQJOiB7b3JkaW5hbCA6IDksIHNpemU6IDh9Cn07Cgp2YXIgaSA9IDA7CmZvcih2YXIgb2JqIGluIFBvdHJlZS5Qb2ludEF0dHJpYnV0ZVR5cGVzKXsKCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZVR5cGVzW2ldID0gUG90cmVlLlBvaW50QXR0cmlidXRlVHlwZXNbb2JqXTsKCWkrKzsKfQoKLyoqCiAqIEEgc2luZ2xlIHBvaW50IGF0dHJpYnV0ZSBzdWNoIGFzIGNvbG9yL25vcm1hbC8uLiBhbmQgaXRzIGRhdGEgZm9ybWF0L251bWJlciBvZiBlbGVtZW50cy8uLi4gCiAqIAogKiBAY2xhc3MKICogQHBhcmFtIG5hbWUgCiAqIEBwYXJhbSB0eXBlCiAqIEBwYXJhbSBzaXplCiAqIEByZXR1cm5zCiAqLwpQb3RyZWUuUG9pbnRBdHRyaWJ1dGUgPSBmdW5jdGlvbihuYW1lLCB0eXBlLCBudW1FbGVtZW50cyl7Cgl0aGlzLm5hbWUgPSBuYW1lOwoJdGhpcy50eXBlID0gdHlwZTsgCgl0aGlzLm51bUVsZW1lbnRzID0gbnVtRWxlbWVudHM7Cgl0aGlzLmJ5dGVTaXplID0gdGhpcy5udW1FbGVtZW50cyAqIHRoaXMudHlwZS5zaXplOwp9OwoKUG90cmVlLlBvaW50QXR0cmlidXRlLlBPU0lUSU9OX0NBUlRFU0lBTiA9IG5ldyBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUoCgkJUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuUE9TSVRJT05fQ0FSVEVTSUFOLAoJCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZVR5cGVzLkRBVEFfVFlQRV9GTE9BVCwgMyk7CgpQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuUkdCQV9QQUNLRUQgPSBuZXcgUG90cmVlLlBvaW50QXR0cmlidXRlKAoJCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLkNPTE9SX1BBQ0tFRCwKCQlQb3RyZWUuUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfSU5UOCwgNCk7CgpQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuQ09MT1JfUEFDS0VEID0gUG90cmVlLlBvaW50QXR0cmlidXRlLlJHQkFfUEFDS0VEOwoKUG90cmVlLlBvaW50QXR0cmlidXRlLlJHQl9QQUNLRUQgPSBuZXcgUG90cmVlLlBvaW50QXR0cmlidXRlKAoJCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLkNPTE9SX1BBQ0tFRCwKCQlQb3RyZWUuUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfSU5UOCwgMyk7CgpQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuTk9STUFMX0ZMT0FUUyA9IG5ldyBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUoCgkJUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuTk9STUFMX0ZMT0FUUywKCQlQb3RyZWUuUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfRkxPQVQsIDMpOwoKUG90cmVlLlBvaW50QXR0cmlidXRlLkZJTExFUl8xQiA9IG5ldyBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUoCgkJUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuRklMTEVSLAoJCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZVR5cGVzLkRBVEFfVFlQRV9VSU5UOCwgMSk7CgkJClBvdHJlZS5Qb2ludEF0dHJpYnV0ZS5JTlRFTlNJVFkgPSBuZXcgUG90cmVlLlBvaW50QXR0cmlidXRlKAoJCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLklOVEVOU0lUWSwKCQlQb3RyZWUuUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfVUlOVDE2LCAxKTsJCQoJCQpQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuQ0xBU1NJRklDQVRJT04gPSBuZXcgUG90cmVlLlBvaW50QXR0cmlidXRlKAoJCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLkNMQVNTSUZJQ0FUSU9OLAoJCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZVR5cGVzLkRBVEFfVFlQRV9VSU5UOCwgMSk7CQoJCQpQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuTk9STUFMX1NQSEVSRU1BUFBFRCA9IG5ldyBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUoCgkJUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuTk9STUFMX1NQSEVSRU1BUFBFRCwKCQlQb3RyZWUuUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfVUlOVDgsIDIpOwkJCgkJClBvdHJlZS5Qb2ludEF0dHJpYnV0ZS5OT1JNQUxfT0NUMTYgPSBuZXcgUG90cmVlLlBvaW50QXR0cmlidXRlKAoJCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLk5PUk1BTF9PQ1QxNiwKCQlQb3RyZWUuUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfVUlOVDgsIDIpOwkKCQkKUG90cmVlLlBvaW50QXR0cmlidXRlLk5PUk1BTCA9IG5ldyBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUoCgkJUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuTk9STUFMLAoJCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZVR5cGVzLkRBVEFfVFlQRV9GTE9BVCwgMyk7CgovKioKICogT3JkZXJlZCBsaXN0IG9mIFBvaW50QXR0cmlidXRlcyB1c2VkIHRvIGlkZW50aWZ5IGhvdyBwb2ludHMgYXJlIGFsaWduZWQgaW4gYSBidWZmZXIuCiAqIAogKiBAY2xhc3MKICogCiAqLwpQb3RyZWUuUG9pbnRBdHRyaWJ1dGVzID0gZnVuY3Rpb24ocG9pbnRBdHRyaWJ1dGVzKXsKCXRoaXMuYXR0cmlidXRlcyA9IFtdOwoJdGhpcy5ieXRlU2l6ZSA9IDA7Cgl0aGlzLnNpemUgPSAwOwoJCglpZihwb2ludEF0dHJpYnV0ZXMgIT0gbnVsbCl7CQoJCWZvcih2YXIgaSA9IDA7IGkgPCBwb2ludEF0dHJpYnV0ZXMubGVuZ3RoOyBpKyspewoJCQl2YXIgcG9pbnRBdHRyaWJ1dGVOYW1lID0gcG9pbnRBdHRyaWJ1dGVzW2ldOwoJCQl2YXIgcG9pbnRBdHRyaWJ1dGUgPSBQb3RyZWUuUG9pbnRBdHRyaWJ1dGVbcG9pbnRBdHRyaWJ1dGVOYW1lXTsKCQkJdGhpcy5hdHRyaWJ1dGVzLnB1c2gocG9pbnRBdHRyaWJ1dGUpOwoJCQl0aGlzLmJ5dGVTaXplICs9IHBvaW50QXR0cmlidXRlLmJ5dGVTaXplOwoJCQl0aGlzLnNpemUrKzsKCQl9Cgl9Cn07CgpQb3RyZWUuUG9pbnRBdHRyaWJ1dGVzLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbihwb2ludEF0dHJpYnV0ZSl7Cgl0aGlzLmF0dHJpYnV0ZXMucHVzaChwb2ludEF0dHJpYnV0ZSk7Cgl0aGlzLmJ5dGVTaXplICs9IHBvaW50QXR0cmlidXRlLmJ5dGVTaXplOwoJdGhpcy5zaXplKys7Cn07CgpQb3RyZWUuUG9pbnRBdHRyaWJ1dGVzLnByb3RvdHlwZS5oYXNDb2xvcnMgPSBmdW5jdGlvbigpewoJZm9yKHZhciBuYW1lIGluIHRoaXMuYXR0cmlidXRlcyl7CgkJdmFyIHBvaW50QXR0cmlidXRlID0gdGhpcy5hdHRyaWJ1dGVzW25hbWVdOwoJCWlmKHBvaW50QXR0cmlidXRlLm5hbWUgPT09IFBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLkNPTE9SX1BBQ0tFRCl7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCQoJcmV0dXJuIGZhbHNlOwp9OwoKUG90cmVlLlBvaW50QXR0cmlidXRlcy5wcm90b3R5cGUuaGFzTm9ybWFscyA9IGZ1bmN0aW9uKCl7Cglmb3IodmFyIG5hbWUgaW4gdGhpcy5hdHRyaWJ1dGVzKXsKCQl2YXIgcG9pbnRBdHRyaWJ1dGUgPSB0aGlzLmF0dHJpYnV0ZXNbbmFtZV07CgkJaWYoCgkJCXBvaW50QXR0cmlidXRlID09PSBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuTk9STUFMX1NQSEVSRU1BUFBFRCB8fCAKCQkJcG9pbnRBdHRyaWJ1dGUgPT09IFBvdHJlZS5Qb2ludEF0dHJpYnV0ZS5OT1JNQUxfRkxPQVRTIHx8CgkJCXBvaW50QXR0cmlidXRlID09PSBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuTk9STUFMIHx8CgkJCXBvaW50QXR0cmlidXRlID09PSBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuTk9STUFMX09DVDE2KXsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoJCglyZXR1cm4gZmFsc2U7Cn07CgoK")),Potree.Shaders["pointcloud.vs"]=["","precision mediump float;","precision mediump int;","","","","","#define max_clip_boxes 30","","attribute vec3 position;","attribute vec3 color;","attribute vec3 normal;","attribute float intensity;","attribute float classification;","attribute float returnNumber;","attribute float numberOfReturns;","attribute float pointSourceID;","attribute vec4 indices;","","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","","","uniform float screenWidth;","uniform float screenHeight;","uniform float fov;","uniform float spacing;","uniform float near;","uniform float far;","","#if defined use_clip_box","\tuniform mat4 clipBoxes[max_clip_boxes];","\tuniform vec3 clipBoxPositions[max_clip_boxes];","#endif","","","uniform float heightMin;","uniform float heightMax;","uniform float intensityMin;","uniform float intensityMax;","uniform float size;\t\t\t\t// pixel size factor","uniform float minSize;\t\t\t// minimum pixel size","uniform float maxSize;\t\t\t// maximum pixel size","uniform float octreeSize;","uniform vec3 bbSize;","uniform vec3 uColor;","uniform float opacity;","uniform float clipBoxCount;","","uniform vec2 intensityRange;","uniform float intensityGamma;","uniform float intensityContrast;","uniform float intensityBrightness;","uniform float rgbGamma;","uniform float rgbContrast;","uniform float rgbBrightness;","uniform float transition;","uniform float wRGB;","uniform float wIntensity;","uniform float wElevation;","uniform float wClassification;","uniform float wReturnNumber;","uniform float wSourceID;","","","uniform sampler2D visibleNodes;","uniform sampler2D gradient;","uniform sampler2D classificationLUT;","uniform sampler2D depthMap;","","varying float\tvOpacity;","varying vec3\tvColor;","varying float\tvLinearDepth;","varying float\tvLogDepth;","varying vec3\tvViewPosition;","varying float \tvRadius;","varying vec3\tvWorldPosition;","varying vec3\tvNormal;","","","// ---------------------","// OCTREE","// ---------------------","","#if (defined(adaptive_point_size) || defined(color_type_lod)) && defined(tree_type_octree)","/**"," * number of 1-bits up to inclusive index position"," * number is treated as if it were an integer in the range 0-255"," *"," */","float numberOfOnes(float number, float index){","\tfloat tmp = mod(number, pow(2.0, index + 1.0));","\tfloat numOnes = 0.0;","\tfor(float i = 0.0; i < 8.0; i++){","\t\tif(mod(tmp, 2.0) != 0.0){","\t\t\tnumOnes++;","\t\t}","\t\ttmp = floor(tmp / 2.0);","\t}","\treturn numOnes;","}","","","/**"," * checks whether the bit at index is 1"," * number is treated as if it were an integer in the range 0-255"," *"," */","bool isBitSet(float number, float index){","\treturn mod(floor(number / pow(2.0, index)), 2.0) != 0.0;","}","","","/**"," * find the LOD at the point position"," */","float getLOD(){","\tvec3 offset = vec3(0.0, 0.0, 0.0);","\tfloat iOffset = 0.0;","\tfloat depth = 0.0;","\tfor(float i = 0.0; i <= 1000.0; i++){","\t\tfloat nodeSizeAtLevel = octreeSize  / pow(2.0, i);","\t\tvec3 index3d = (position - offset) / nodeSizeAtLevel;","\t\tindex3d = floor(index3d + 0.5);","\t\tfloat index = 4.0*index3d.x + 2.0*index3d.y + index3d.z;","\t\t","\t\tvec4 value = texture2D(visibleNodes, vec2(iOffset / 2048.0, 0.0));","\t\tfloat mask = value.r * 255.0;","\t\tif(isBitSet(mask, index)){","\t\t\t// there are more visible child nodes at this position","\t\t\tiOffset = iOffset + value.g * 255.0 + numberOfOnes(mask, index - 1.0);","\t\t\tdepth++;","\t\t}else{","\t\t\t// no more visible child nodes at this position","\t\t\treturn depth;","\t\t}","\t\toffset = offset + (vec3(1.0, 1.0, 1.0) * nodeSizeAtLevel * 0.5) * index3d;","\t}","\t\t","\treturn depth;","}","","float getPointSizeAttenuation(){","\treturn pow(1.9, getLOD());","}","","","#endif","","","// ---------------------","// KD-TREE","// ---------------------","","#if (defined(adaptive_point_size) || defined(color_type_lod)) && defined(tree_type_kdtree)","","float getLOD(){","\tvec3 offset = vec3(0.0, 0.0, 0.0);","\tfloat iOffset = 0.0;","\tfloat depth = 0.0;","\t\t","\t\t","\tvec3 size = bbSize;\t","\tvec3 pos = position;","\t\t","\tfor(float i = 0.0; i <= 1000.0; i++){","\t\t","\t\tvec4 value = texture2D(visibleNodes, vec2(iOffset / 2048.0, 0.0));","\t\t","\t\tint children = int(value.r * 255.0);","\t\tfloat next = value.g * 255.0;","\t\tint split = int(value.b * 255.0);","\t\t","\t\tif(next == 0.0){","\t\t \treturn depth;","\t\t}","\t\t","\t\tvec3 splitv = vec3(0.0, 0.0, 0.0);","\t\tif(split == 1){","\t\t\tsplitv.x = 1.0;","\t\t}else if(split == 2){","\t\t \tsplitv.y = 1.0;","\t\t}else if(split == 4){","\t\t \tsplitv.z = 1.0;","\t\t}","\t\t","\t\tiOffset = iOffset + next;","\t\t","\t\tfloat factor = length(pos * splitv / size);","\t\tif(factor < 0.5){","\t\t \t// left","\t\t    if(children == 0 || children == 2){","\t\t    \treturn depth;","\t\t    }","\t\t}else{","\t\t  \t// right","\t\t    pos = pos - size * splitv * 0.5;","\t\t    if(children == 0 || children == 1){","\t\t    \treturn depth;","\t\t    }","\t\t    if(children == 3){","\t\t    \tiOffset = iOffset + 1.0;","\t\t    }","\t\t}","\t\tsize = size * ((1.0 - (splitv + 1.0) / 2.0) + 0.5);","\t\t","\t\tdepth++;","\t}","\t\t","\t\t","\treturn depth;\t","}","","float getPointSizeAttenuation(){","\treturn pow(1.3, getLOD());","}","","#endif","","// formula adapted from: http://www.dfstudios.co.uk/articles/programming/image-programming-algorithms/image-processing-algorithms-part-5-contrast-adjustment/","float getContrastFactor(float contrast){","\treturn (1.0158730158730156 * (contrast + 1.0)) / (1.0158730158730156 - contrast);","}","","vec3 getRGB(){","\tvec3 rgb = color;","\t","\trgb = pow(rgb, vec3(rgbGamma));","\trgb = rgb + rgbBrightness;","\trgb = (rgb - 0.5) * getContrastFactor(rgbContrast) + 0.5;","\trgb = clamp(rgb, 0.0, 1.0);","\t","\treturn rgb;","}","","float getIntensity(){","\tfloat w = (intensity - intensityRange.x) / (intensityRange.y - intensityRange.x);","\tw = pow(w, intensityGamma);","\tw = w + intensityBrightness;","\tw = (w - 0.5) * getContrastFactor(intensityContrast) + 0.5;","\tw = clamp(w, 0.0, 1.0);","\t","\treturn w;","}","","vec3 getElevation(){","\tvec4 world = modelMatrix * vec4( position, 1.0 );","\tfloat w = (world.z - heightMin) / (heightMax-heightMin);","\tvec3 cElevation = texture2D(gradient, vec2(w,1.0-w)).rgb;","\t","\treturn cElevation;","}","","vec4 getClassification(){","\tfloat c = mod(classification, 16.0);","\tvec2 uv = vec2(c / 255.0, 0.5);","\tvec4 classColor = texture2D(classificationLUT, uv);","\t","\treturn classColor;","}","","vec3 getReturnNumber(){","\tif(numberOfReturns == 1.0){","\t\treturn vec3(1.0, 1.0, 0.0);","\t}else{","\t\tif(returnNumber == 1.0){","\t\t\treturn vec3(1.0, 0.0, 0.0);","\t\t}else if(returnNumber == numberOfReturns){","\t\t\treturn vec3(0.0, 0.0, 1.0);","\t\t}else{","\t\t\treturn vec3(0.0, 1.0, 0.0);","\t\t}","\t}","}","","vec3 getSourceID(){","\tfloat w = mod(pointSourceID, 10.0) / 10.0;","\treturn texture2D(gradient, vec2(w,1.0 - w)).rgb;","}","","vec3 getCompositeColor(){","\tvec3 c;","\tfloat w;","","\tc += wRGB * getRGB();","\tw += wRGB;","\t","\tc += wIntensity * getIntensity() * vec3(1.0, 1.0, 1.0);","\tw += wIntensity;","\t","\tc += wElevation * getElevation();","\tw += wElevation;","\t","\tc += wReturnNumber * getReturnNumber();","\tw += wReturnNumber;","\t","\tc += wSourceID * getSourceID();","\tw += wSourceID;","\t","\tvec4 cl = wClassification * getClassification();","    c += cl.a * cl.rgb;","\tw += wClassification * cl.a;","","\tc = c / w;","\t","\tif(w == 0.0){","\t\t//c = color;","\t\tgl_Position = vec4(100.0, 100.0, 100.0, 0.0);","\t}","\t","\treturn c;","}","","void main() {","\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","\tvViewPosition = mvPosition.xyz;","\tgl_Position = projectionMatrix * mvPosition;","\tvOpacity = opacity;","\tvLinearDepth = gl_Position.w;","\tvLogDepth = log2(gl_Position.w);","\tvNormal = normalize(normalMatrix * normal);","","\t// ---------------------","\t// POINT COLOR","\t// ---------------------","\tvec4 cl = getClassification(); ","\t","\t#ifdef color_type_rgb","\t\tvColor = getRGB();","\t#elif defined color_type_height","\t\tvColor = getElevation();","\t#elif defined color_type_rgb_height","\t\tvec3 cHeight = getElevation();","\t\tvColor = (1.0 - transition) * getRGB() + transition * cHeight;","\t#elif defined color_type_depth","\t\tfloat linearDepth = -mvPosition.z ;","\t\tfloat expDepth = (gl_Position.z / gl_Position.w) * 0.5 + 0.5;","\t\tvColor = vec3(linearDepth, expDepth, 0.0);","\t#elif defined color_type_intensity","\t\tfloat w = getIntensity();","\t\tvColor = vec3(w, w, w);","\t#elif defined color_type_intensity_gradient","\t\tfloat w = getIntensity();","\t\tvColor = texture2D(gradient, vec2(w,1.0-w)).rgb;","\t#elif defined color_type_color","\t\tvColor = uColor;","\t#elif defined color_type_lod","\t\tfloat depth = getLOD();","\t\tfloat w = depth / 10.0;","\t\tvColor = texture2D(gradient, vec2(w,1.0-w)).rgb;","\t#elif defined color_type_point_index","\t\tvColor = indices.rgb;","\t#elif defined color_type_classification","\t\tvColor = cl.rgb;","\t#elif defined color_type_return_number","\t\tvColor = getReturnNumber();","\t#elif defined color_type_source","\t\tvColor = getSourceID();","\t#elif defined color_type_normal","\t\tvColor = (modelMatrix * vec4(normal, 0.0)).xyz;","\t#elif defined color_type_phong","\t\tvColor = color;","\t#elif defined color_type_composite","\t\tvColor = getCompositeColor();","\t#endif","\t","\t#if !defined color_type_composite","\t\tif(cl.a == 0.0){","\t\t\tgl_Position = vec4(100.0, 100.0, 100.0, 0.0);","\t\t\t","\t\t\treturn;","\t\t}","\t#endif","\t","\t// ---------------------","\t// POINT SIZE","\t// ---------------------","\tfloat pointSize = 1.0;","\t","\tfloat slope = tan(fov / 2.0);","\tfloat projFactor =  -0.5 * screenHeight / (slope * vViewPosition.z);","\t","\tfloat r = spacing * 1.5;","\tvRadius = r;","\t#if defined fixed_point_size","\t\tpointSize = size;","\t#elif defined attenuated_point_size","\t\tpointSize = size * projFactor;","\t#elif defined adaptive_point_size","\t\tfloat worldSpaceSize = size * r / getPointSizeAttenuation();","\t\tpointSize = worldSpaceSize * projFactor;","\t#endif","","\tpointSize = max(minSize, pointSize);","\tpointSize = min(maxSize, pointSize);","\t","\tvRadius = pointSize / projFactor;","\t","\tgl_PointSize = pointSize;","\t","\t","\t// ---------------------","\t// CLIPPING","\t// ---------------------","\t","\t#if defined use_clip_box","\t\tbool insideAny = false;","\t\tfor(int i = 0; i < max_clip_boxes; i++){","\t\t\tif(i == int(clipBoxCount)){","\t\t\t\tbreak;","\t\t\t}","\t\t","\t\t\tvec4 clipPosition = clipBoxes[i] * modelMatrix * vec4( position, 1.0 );","\t\t\tbool inside = -0.5 <= clipPosition.x && clipPosition.x <= 0.5;","\t\t\tinside = inside && -0.5 <= clipPosition.y && clipPosition.y <= 0.5;","\t\t\tinside = inside && -0.5 <= clipPosition.z && clipPosition.z <= 0.5;","\t\t\tinsideAny = insideAny || inside;","\t\t}","\t\tif(!insideAny){","\t","\t\t\t#if defined clip_outside","\t\t\t\tgl_Position = vec4(1000.0, 1000.0, 1000.0, 1.0);","\t\t\t#elif defined clip_highlight_inside && !defined(color_type_depth)","\t\t\t\tfloat c = (vColor.r + vColor.g + vColor.b) / 6.0;","\t\t\t#endif","\t\t}else{","\t\t\t#if defined clip_highlight_inside","\t\t\tvColor.r += 0.5;","\t\t\t#endif","\t\t}","\t","\t#endif","\t","}",""].join("\n"),
Potree.Shaders["pointcloud.fs"]=["","precision mediump float;","precision mediump int;","","#if defined use_interpolation","\t#extension GL_EXT_frag_depth : enable","#endif","","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","","","uniform mat4 projectionMatrix;","uniform float opacity;","","uniform float blendHardness;","uniform float blendDepthSupplement;","uniform float fov;","uniform float spacing;","uniform float near;","uniform float far;","uniform float pcIndex;","uniform float screenWidth;","uniform float screenHeight;","","uniform sampler2D depthMap;","","varying vec3\tvColor;","varying float\tvOpacity;","varying float\tvLinearDepth;","varying float\tvLogDepth;","varying vec3\tvViewPosition;","varying float\tvRadius;","varying vec3\tvNormal;","","float specularStrength = 1.0;","","void main() {","","\tvec3 color = vColor;","\tfloat depth = gl_FragCoord.z;","","\t#if defined(circle_point_shape) || defined(use_interpolation) || defined (weighted_splats)","\t\tfloat u = 2.0 * gl_PointCoord.x - 1.0;","\t\tfloat v = 2.0 * gl_PointCoord.y - 1.0;","\t#endif","\t","\t#if defined(circle_point_shape) || defined (weighted_splats)","\t\tfloat cc = u*u + v*v;","\t\tif(cc > 1.0){","\t\t\tdiscard;","\t\t}","\t#endif","\t","\t#if defined weighted_splats","\t\tvec2 uv = gl_FragCoord.xy / vec2(screenWidth, screenHeight);","\t\tfloat sDepth = texture2D(depthMap, uv).r;","\t\tif(vLinearDepth > sDepth + vRadius + blendDepthSupplement){","\t\t\tdiscard;","\t\t}","\t#endif","\t\t","\t#if defined color_type_point_index","\t\tgl_FragColor = vec4(color, pcIndex / 255.0);","\t#else","\t\tgl_FragColor = vec4(color, vOpacity);","\t#endif","","\tvec3 normal = normalize( vNormal );","\tnormal.z = abs(normal.z);","\tvec3 viewPosition = normalize( vViewPosition );","\t","\t#if defined(color_type_phong)","","\t// code taken from three.js phong light fragment shader","\t","\t\t#if MAX_POINT_LIGHTS > 0","","\t\t\tvec3 pointDiffuse = vec3( 0.0 );","\t\t\tvec3 pointSpecular = vec3( 0.0 );","","\t\t\tfor ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","","\t\t\t\tvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","\t\t\t\tvec3 lVector = lPosition.xyz + vViewPosition.xyz;","","\t\t\t\tfloat lDistance = 1.0;","\t\t\t\tif ( pointLightDistance[ i ] > 0.0 )","\t\t\t\t\tlDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","","\t\t\t\tlVector = normalize( lVector );","","\t\t\t\t\t\t// diffuse","","\t\t\t\tfloat dotProduct = dot( normal, lVector );","","\t\t\t\t#ifdef WRAP_AROUND","","\t\t\t\t\tfloat pointDiffuseWeightFull = max( dotProduct, 0.0 );","\t\t\t\t\tfloat pointDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","","\t\t\t\t\tvec3 pointDiffuseWeight = mix( vec3( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","","\t\t\t\t#else","","\t\t\t\t\tfloat pointDiffuseWeight = max( dotProduct, 0.0 );","","\t\t\t\t#endif","","\t\t\t\tpointDiffuse += diffuse * pointLightColor[ i ] * pointDiffuseWeight * lDistance;","","\t\t\t\t\t\t// specular","","\t\t\t\tvec3 pointHalfVector = normalize( lVector + viewPosition );","\t\t\t\tfloat pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","\t\t\t\tfloat pointSpecularWeight = specularStrength * max( pow( pointDotNormalHalf, shininess ), 0.0 );","","\t\t\t\tfloat specularNormalization = ( shininess + 2.0 ) / 8.0;","","\t\t\t\tvec3 schlick = specular + vec3( 1.0 - specular ) * pow( max( 1.0 - dot( lVector, pointHalfVector ), 0.0 ), 5.0 );","\t\t\t\tpointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance * specularNormalization;","\t\t\t\tpointSpecular = vec3(0.0, 0.0, 0.0);","\t\t\t}","\t\t","\t\t#endif","\t\t","\t\t#if MAX_DIR_LIGHTS > 0","","\t\t\tvec3 dirDiffuse = vec3( 0.0 );","\t\t\tvec3 dirSpecular = vec3( 0.0 );","","\t\t\tfor( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","","\t\t\t\tvec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","\t\t\t\tvec3 dirVector = normalize( lDirection.xyz );","","\t\t\t\t\t\t// diffuse","","\t\t\t\tfloat dotProduct = dot( normal, dirVector );","","\t\t\t\t#ifdef WRAP_AROUND","","\t\t\t\t\tfloat dirDiffuseWeightFull = max( dotProduct, 0.0 );","\t\t\t\t\tfloat dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","","\t\t\t\t\tvec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );","","\t\t\t\t#else","","\t\t\t\t\tfloat dirDiffuseWeight = max( dotProduct, 0.0 );","","\t\t\t\t#endif","","\t\t\t\tdirDiffuse += diffuse * directionalLightColor[ i ] * dirDiffuseWeight;","","\t\t\t\t// specular","","\t\t\t\tvec3 dirHalfVector = normalize( dirVector + viewPosition );","\t\t\t\tfloat dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","\t\t\t\tfloat dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininess ), 0.0 );","","\t\t\t\tfloat specularNormalization = ( shininess + 2.0 ) / 8.0;","","\t\t\t\tvec3 schlick = specular + vec3( 1.0 - specular ) * pow( max( 1.0 - dot( dirVector, dirHalfVector ), 0.0 ), 5.0 );","\t\t\t\tdirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;","\t\t\t}","","\t\t#endif","\t\t","\t\tvec3 totalDiffuse = vec3( 0.0 );","\t\tvec3 totalSpecular = vec3( 0.0 );","\t\t","\t\t#if MAX_POINT_LIGHTS > 0","","\t\t\ttotalDiffuse += pointDiffuse;","\t\t\ttotalSpecular += pointSpecular;","","\t\t#endif","\t\t","\t\t#if MAX_DIR_LIGHTS > 0","","\t\t\ttotalDiffuse += dirDiffuse;","\t\t\ttotalSpecular += dirSpecular;","","\t\t#endif","\t\t","\t\tgl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient ) + totalSpecular;","","\t#endif","\t","\t#if defined weighted_splats","\t    //float w = pow(1.0 - (u*u + v*v), blendHardness);","\t\t","\t\tfloat wx = 2.0 * length(2.0 * gl_PointCoord - 1.0);","\t\tfloat w = exp(-wx * wx * 0.5);","\t\t","\t\t//float distance = length(2.0 * gl_PointCoord - 1.0);","\t\t//float w = exp( -(distance * distance) / blendHardness);","\t\t","\t\tgl_FragColor.rgb = gl_FragColor.rgb * w;","\t\tgl_FragColor.a = w;","\t#endif","\t","\t#if defined use_interpolation","\t\tfloat wi = 0.0 - ( u*u + v*v);","\t\tvec4 pos = vec4(vViewPosition, 1.0);","\t\tpos.z += wi * vRadius;","\t\tfloat linearDepth = -pos.z;","\t\tpos = projectionMatrix * pos;","\t\tpos = pos / pos.w;","\t\tfloat expDepth = pos.z;","\t\tdepth = (pos.z + 1.0) / 2.0;","\t\tgl_FragDepthEXT = depth;","\t\t","\t\t#if defined(color_type_depth)","\t\t\tcolor.r = linearDepth;","\t\t\tcolor.g = expDepth;","\t\t#endif","\t\t","\t\t#if defined(use_edl)","\t\t\tgl_FragColor.a = log2(linearDepth);","\t\t#endif","\t\t","\t#else","\t\t#if defined(use_edl)","\t\t\tgl_FragColor.a = vLogDepth;","\t\t#endif","\t#endif","\t","\t","\t\t","\t","\t","\t","\t","}","","",""].join("\n"),Potree.Shaders["normalize.vs"]=["","varying vec2 vUv;","","void main() {","    vUv = uv;","","    gl_Position =   projectionMatrix * modelViewMatrix * vec4(position,1.0);","}"].join("\n"),Potree.Shaders["normalize.fs"]=["","#extension GL_EXT_frag_depth : enable","","uniform sampler2D depthMap;","uniform sampler2D texture;","","varying vec2 vUv;","","void main() {","    float depth = texture2D(depthMap, vUv).g; ","\t","\tif(depth <= 0.0){","\t\tdiscard;","\t}","\t","    vec4 color = texture2D(texture, vUv); ","\tcolor = color / color.w;","    ","\tgl_FragColor = vec4(color.xyz, 1.0); ","\t","\tgl_FragDepthEXT = depth;","}"].join("\n"),Potree.Shaders["edl.vs"]=["","","varying vec2 vUv;","","void main() {","    vUv = uv;","\t","\tvec4 mvPosition = modelViewMatrix * vec4(position,1.0);","","    gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),Potree.Shaders["edl.fs"]=["// ","// adapted from the EDL shader code from Christian Boucheny in cloud compare:","// https://github.com/cloudcompare/trunk/tree/master/plugins/qEDL/shaders/EDL","//","","//#define NEIGHBOUR_COUNT 4","","uniform float screenWidth;","uniform float screenHeight;","uniform vec2 neighbours[NEIGHBOUR_COUNT];","uniform float edlStrength;","uniform float radius;","uniform float opacity;","","uniform sampler2D colorMap;","","varying vec2 vUv;","","const float infinity = 1.0 / 0.0;","","float response(float depth){","\tvec2 uvRadius = radius / vec2(screenWidth, screenHeight);","\t","\tfloat sum = 0.0;","\t","\tfor(int i = 0; i < NEIGHBOUR_COUNT; i++){","\t\tvec2 uvNeighbor = vUv + uvRadius * neighbours[i];","\t\t","\t\tfloat neighbourDepth = texture2D(colorMap, uvNeighbor).a;","\t\t","\t\tif(neighbourDepth == 0.0){","\t\t\tneighbourDepth = infinity;","\t\t}","\t\t","\t\tsum += max(0.0, depth - neighbourDepth);","\t}","\t","\treturn sum / float(NEIGHBOUR_COUNT);","}","","void main(){","\tvec4 color = texture2D(colorMap, vUv);","\t","\tfloat depth = color.a;","\tif(depth == 0.0){","\t\tdepth = infinity;","\t}","\t","\tfloat res = response(depth);","\tfloat shade = exp(-res * 300.0 * edlStrength);","\t","\tif(color.a == 0.0 && res == 0.0){","\t\tdiscard;","\t}","\t","\tgl_FragColor = vec4(color.rgb * shade, opacity);","}",""].join("\n"),Potree.Shaders["blur.vs"]=["","varying vec2 vUv;","","void main() {","    vUv = uv;","","    gl_Position =   projectionMatrix * modelViewMatrix * vec4(position,1.0);","}"].join("\n"),Potree.Shaders["blur.fs"]=["","uniform mat4 projectionMatrix;","","uniform float screenWidth;","uniform float screenHeight;","uniform float near;","uniform float far;","","uniform sampler2D map;","","varying vec2 vUv;","","void main() {","","\tfloat dx = 1.0 / screenWidth;","\tfloat dy = 1.0 / screenHeight;","","\tvec3 color = vec3(0.0, 0.0, 0.0);","\tcolor += texture2D(map, vUv + vec2(-dx, -dy)).rgb;","\tcolor += texture2D(map, vUv + vec2(  0, -dy)).rgb;","\tcolor += texture2D(map, vUv + vec2(+dx, -dy)).rgb;","\tcolor += texture2D(map, vUv + vec2(-dx,   0)).rgb;","\tcolor += texture2D(map, vUv + vec2(  0,   0)).rgb;","\tcolor += texture2D(map, vUv + vec2(+dx,   0)).rgb;","\tcolor += texture2D(map, vUv + vec2(-dx,  dy)).rgb;","\tcolor += texture2D(map, vUv + vec2(  0,  dy)).rgb;","\tcolor += texture2D(map, vUv + vec2(+dx,  dy)).rgb;","    ","\tcolor = color / 9.0;","\t","\tgl_FragColor = vec4(color, 1.0);","\t","\t","}"].join("\n"),THREE.PerspectiveCamera.prototype.zoomTo=function(e,t){if(e.geometry||e.boundingSphere||e.boundingBox){e.geometry&&null===e.geometry.boundingSphere&&e.geometry.computeBoundingSphere(),e.updateMatrixWorld();var i;i=e.boundingSphere?e.boundingSphere:e.geometry&&e.geometry.boundingSphere?e.geometry.boundingSphere:e.boundingBox.getBoundingSphere();var o=t||1;i=i.clone().applyMatrix4(e.matrixWorld);var n=i.radius,r=this.fov*Math.PI/180;this.aspect<1&&(r*=this.aspect);var s=Math.abs(n/Math.sin(r/2))*o,a=this.getWorldDirection().multiplyScalar(-s);this.position.copy(i.center.clone().add(a))}},THREE.Ray.prototype.distanceToPlaneWithNegative=function(e){var t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;var i=-(this.origin.dot(e.normal)+e.constant)/t;return i},Potree.POCLoader=function(){},Potree.POCLoader.load=function(e,t){try{var i=new Potree.PointCloudOctreeGeometry;i.url=e;var o=new XMLHttpRequest;o.open("GET",e,!0),o.onreadystatechange=function(){if(4===o.readyState&&(200===o.status||0===o.status)){var n=JSON.parse(o.responseText),r=new Potree.Version(n.version);0===n.octreeDir.indexOf("http")?i.octreeDir=n.octreeDir:i.octreeDir=e+"/../"+n.octreeDir,i.spacing=n.spacing,i.hierarchyStepSize=n.hierarchyStepSize,i.pointAttributes=n.pointAttributes;var s=new THREE.Vector3(n.boundingBox.lx,n.boundingBox.ly,n.boundingBox.lz),a=new THREE.Vector3(n.boundingBox.ux,n.boundingBox.uy,n.boundingBox.uz),l=new THREE.Box3(s,a),d=l.clone();n.tightBoundingBox&&(d.min.copy(new THREE.Vector3(n.tightBoundingBox.lx,n.tightBoundingBox.ly,n.tightBoundingBox.lz)),d.max.copy(new THREE.Vector3(n.tightBoundingBox.ux,n.tightBoundingBox.uy,n.tightBoundingBox.uz)));var c=new THREE.Vector3(0,0,0);c.set(-s.x,-s.y,-s.z),l.min.add(c),l.max.add(c),d.min.add(c),d.max.add(c),i.projection=n.projection,i.boundingBox=l,i.tightBoundingBox=d,i.boundingSphere=l.getBoundingSphere(),i.tightBoundingSphere=d.getBoundingSphere(),i.offset=c,"LAS"===n.pointAttributes?i.loader=new Potree.LasLazLoader(n.version):"LAZ"===n.pointAttributes?i.loader=new Potree.LasLazLoader(n.version):(i.loader=new Potree.BinaryLoader(n.version,l,n.scale),i.pointAttributes=new Potree.PointAttributes(i.pointAttributes));var u={},h="r",p=new Potree.PointCloudOctreeGeometryNode(h,i,l);if(p.level=0,p.hasChildren=!0,r.upTo("1.5")?p.numPoints=n.hierarchy[0][1]:p.numPoints=0,i.root=p,i.root.load(),u[h]=p,r.upTo("1.4"))for(var m=1;m<n.hierarchy.length;m++){var h=n.hierarchy[m][0],f=n.hierarchy[m][1],v=parseInt(h.charAt(h.length-1)),g=h.substring(0,h.length-1),y=u[g],E=h.length-1,l=Potree.POCLoader.createChildAABB(y.boundingBox,v),b=new Potree.PointCloudOctreeGeometryNode(h,i,l);b.level=E,b.numPoints=f,y.addChild(b),u[h]=b}i.nodes=u,t(i)}},o.send(null)}catch(i){console.log("loading failed: '"+e+"'"),console.log(i),t()}},Potree.POCLoader.loadPointAttributes=function(e){for(var t=e.pointAttributes,i=new Potree.PointAttributes,o=0;o<t.length;o++){var n=Potree.PointAttribute[t[o]];i.add(n)}return i},Potree.POCLoader.createChildAABB=function(e,t){var i,o,i=(THREE.Vector3,e.min),o=e.max,n=(new THREE.Vector3).copy(o).sub(i).multiplyScalar(.5),r=new THREE.Vector3(n.x,0,0),s=new THREE.Vector3(0,n.y,0),a=new THREE.Vector3(0,0,n.z),l=i,d=(new THREE.Vector3).add(i).add(n);return 1===t?(i=(new THREE.Vector3).copy(l).add(a),o=(new THREE.Vector3).copy(d).add(a)):3===t?(i=(new THREE.Vector3).copy(l).add(a).add(s),o=(new THREE.Vector3).copy(d).add(a).add(s)):0===t?(i=l,o=d):2===t?(i=(new THREE.Vector3).copy(l).add(s),o=(new THREE.Vector3).copy(d).add(s)):5===t?(i=(new THREE.Vector3).copy(l).add(a).add(r),o=(new THREE.Vector3).copy(d).add(a).add(r)):7===t?(i=(new THREE.Vector3).copy(l).add(n),o=(new THREE.Vector3).copy(d).add(n)):4===t?(i=(new THREE.Vector3).copy(l).add(r),o=(new THREE.Vector3).copy(d).add(r)):6===t&&(i=(new THREE.Vector3).copy(l).add(r).add(s),o=(new THREE.Vector3).copy(d).add(r).add(s)),new THREE.Box3(i,o)},Potree.PointAttributeNames={},Potree.PointAttributeNames.POSITION_CARTESIAN=0,Potree.PointAttributeNames.COLOR_PACKED=1,Potree.PointAttributeNames.COLOR_FLOATS_1=2,Potree.PointAttributeNames.COLOR_FLOATS_255=3,Potree.PointAttributeNames.NORMAL_FLOATS=4,Potree.PointAttributeNames.FILLER=5,Potree.PointAttributeNames.INTENSITY=6,Potree.PointAttributeNames.CLASSIFICATION=7,Potree.PointAttributeNames.NORMAL_SPHEREMAPPED=8,Potree.PointAttributeNames.NORMAL_OCT16=9,Potree.PointAttributeNames.NORMAL=10,Potree.PointAttributeTypes={DATA_TYPE_DOUBLE:{ordinal:0,size:8},DATA_TYPE_FLOAT:{ordinal:1,size:4},DATA_TYPE_INT8:{ordinal:2,size:1},DATA_TYPE_UINT8:{ordinal:3,size:1},DATA_TYPE_INT16:{ordinal:4,size:2},DATA_TYPE_UINT16:{ordinal:5,size:2},DATA_TYPE_INT32:{ordinal:6,size:4},DATA_TYPE_UINT32:{ordinal:7,size:4},DATA_TYPE_INT64:{ordinal:8,size:8},DATA_TYPE_UINT64:{ordinal:9,size:8}};var i=0;for(var obj in Potree.PointAttributeTypes)Potree.PointAttributeTypes[i]=Potree.PointAttributeTypes[obj],i++;Potree.PointAttribute=function(e,t,i){this.name=e,this.type=t,this.numElements=i,this.byteSize=this.numElements*this.type.size},Potree.PointAttribute.POSITION_CARTESIAN=new Potree.PointAttribute(Potree.PointAttributeNames.POSITION_CARTESIAN,Potree.PointAttributeTypes.DATA_TYPE_FLOAT,3),Potree.PointAttribute.RGBA_PACKED=new Potree.PointAttribute(Potree.PointAttributeNames.COLOR_PACKED,Potree.PointAttributeTypes.DATA_TYPE_INT8,4),Potree.PointAttribute.COLOR_PACKED=Potree.PointAttribute.RGBA_PACKED,Potree.PointAttribute.RGB_PACKED=new Potree.PointAttribute(Potree.PointAttributeNames.COLOR_PACKED,Potree.PointAttributeTypes.DATA_TYPE_INT8,3),Potree.PointAttribute.NORMAL_FLOATS=new Potree.PointAttribute(Potree.PointAttributeNames.NORMAL_FLOATS,Potree.PointAttributeTypes.DATA_TYPE_FLOAT,3),Potree.PointAttribute.FILLER_1B=new Potree.PointAttribute(Potree.PointAttributeNames.FILLER,Potree.PointAttributeTypes.DATA_TYPE_UINT8,1),Potree.PointAttribute.INTENSITY=new Potree.PointAttribute(Potree.PointAttributeNames.INTENSITY,Potree.PointAttributeTypes.DATA_TYPE_UINT16,1),Potree.PointAttribute.CLASSIFICATION=new Potree.PointAttribute(Potree.PointAttributeNames.CLASSIFICATION,Potree.PointAttributeTypes.DATA_TYPE_UINT8,1),Potree.PointAttribute.NORMAL_SPHEREMAPPED=new Potree.PointAttribute(Potree.PointAttributeNames.NORMAL_SPHEREMAPPED,Potree.PointAttributeTypes.DATA_TYPE_UINT8,2),Potree.PointAttribute.NORMAL_OCT16=new Potree.PointAttribute(Potree.PointAttributeNames.NORMAL_OCT16,Potree.PointAttributeTypes.DATA_TYPE_UINT8,2),Potree.PointAttribute.NORMAL=new Potree.PointAttribute(Potree.PointAttributeNames.NORMAL,Potree.PointAttributeTypes.DATA_TYPE_FLOAT,3),Potree.PointAttributes=function(e){if(this.attributes=[],this.byteSize=0,this.size=0,null!=e)for(var t=0;t<e.length;t++){var i=e[t],o=Potree.PointAttribute[i];this.attributes.push(o),this.byteSize+=o.byteSize,this.size++}},Potree.PointAttributes.prototype.add=function(e){this.attributes.push(e),this.byteSize+=e.byteSize,this.size++},Potree.PointAttributes.prototype.hasColors=function(){for(var e in this.attributes){var t=this.attributes[e];if(t.name===Potree.PointAttributeNames.COLOR_PACKED)return!0}return!1},Potree.PointAttributes.prototype.hasNormals=function(){for(var e in this.attributes){var t=this.attributes[e];if(t===Potree.PointAttribute.NORMAL_SPHEREMAPPED||t===Potree.PointAttribute.NORMAL_FLOATS||t===Potree.PointAttribute.NORMAL||t===Potree.PointAttribute.NORMAL_OCT16)return!0}return!1},Potree.BinaryLoader=function(e,t,i){"string"==typeof e?this.version=new Potree.Version(e):this.version=e,this.boundingBox=t,this.scale=i},Potree.BinaryLoader.prototype.load=function(e){if(!e.loaded){var t=this,i=e.getURL();this.version.equalOrHigher("1.4")&&(i+=".bin");var o=new XMLHttpRequest;o.open("GET",i,!0),o.responseType="arraybuffer",o.overrideMimeType("text/plain; charset=x-user-defined"),o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status||0===o.status){var n=o.response;t.parse(e,n)}else console.log("Failed to load file! HTTP status: "+o.status+", file: "+i)};try{o.send(null)}catch(e){console.log("fehler beim laden der punktwolke: "+e)}}},Potree.BinaryLoader.prototype.parse=function(e,t){var i=t.byteLength/e.pcoGeometry.pointAttributes.byteSize,o=e.pcoGeometry.pointAttributes;this.version.upTo("1.5")&&(e.numPoints=i);var n=Potree.workers.binaryDecoder.getWorker();n.onmessage=function(t){var o=t.data,r=o.attributeBuffers,s=new THREE.Box3((new THREE.Vector3).fromArray(o.tightBoundingBox.min),(new THREE.Vector3).fromArray(o.tightBoundingBox.max));Potree.workers.binaryDecoder.returnWorker(n);var a=new THREE.BufferGeometry;for(var l in r)if(r.hasOwnProperty(l)){var d=r[l].buffer,c=r[l].attribute;c.numElements;parseInt(l)===Potree.PointAttributeNames.POSITION_CARTESIAN?a.addAttribute("position",new THREE.BufferAttribute(new Float32Array(d),3)):parseInt(l)===Potree.PointAttributeNames.COLOR_PACKED?a.addAttribute("color",new THREE.BufferAttribute(new Uint8Array(d),3,(!0))):parseInt(l)===Potree.PointAttributeNames.INTENSITY?a.addAttribute("intensity",new THREE.BufferAttribute(new Float32Array(d),1)):parseInt(l)===Potree.PointAttributeNames.CLASSIFICATION?a.addAttribute("classification",new THREE.BufferAttribute(new Uint8Array(d),1)):parseInt(l)===Potree.PointAttributeNames.NORMAL_SPHEREMAPPED?a.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(d),3)):parseInt(l)===Potree.PointAttributeNames.NORMAL_OCT16?a.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(d),3)):parseInt(l)===Potree.PointAttributeNames.NORMAL&&a.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(d),3))}if(a.addAttribute("indices",new THREE.BufferAttribute(new Float32Array(o.indices),1)),!a.attributes.normal){var d=new Float32Array(3*i);a.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(d),3))}a.boundingBox=e.boundingBox,e.geometry=a,e.tightBoundingBox=s,e.loaded=!0,e.loading=!1,e.pcoGeometry.numNodesLoading--};var r={buffer:t,pointAttributes:o,version:this.version.version,min:[e.boundingBox.min.x,e.boundingBox.min.y,e.boundingBox.min.z],offset:[e.pcoGeometry.offset.x,e.pcoGeometry.offset.y,e.pcoGeometry.offset.z],scale:this.scale};n.postMessage(r,[r.buffer])},Potree.LasLazLoader=function(e){"string"==typeof e?this.version=new Potree.Version(e):this.version=e},Potree.LasLazLoader.prototype.load=function(e){if(!e.loaded){var t=e.pcoGeometry.pointAttributes,i=e.getURL();this.version.equalOrHigher("1.4")&&(i+="."+t.toLowerCase());var o=this,n=new XMLHttpRequest;n.open("GET",i,!0),n.responseType="arraybuffer",n.overrideMimeType("text/plain; charset=x-user-defined"),n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status){var t=n.response;o.parse(e,t)}else console.log("Failed to load file! HTTP status: "+n.status+", file: "+i)},n.send(null)}},Potree.LasLazLoader.progressCB=function(e){},Potree.LasLazLoader.prototype.parse=function(e,t){var i=new LASFile(t),o=new Potree.LasLazBatcher(e);return Promise.resolve(i).cancellable().then(function(e){return e.open().then(function(){return e.isOpen=!0,e}).catch(Promise.CancellationError,function(t){return e.close().then(function(){throw t})})}).then(function(e){return e.getHeader().then(function(t){return[e,t]})}).then(function(e){var t=e[0],i=e[1],n=1,r=0,s=n<=1?i.pointsCount:i.pointsCount/n,a=function e(){var a=t.readData(1e6,0,n);return a.then(function(n){return o.push(new LASDecoder(n.buffer,i.pointsFormatId,i.pointsStructSize,n.count,i.scale,i.offset,i.mins,i.maxs)),r+=n.count,Potree.LasLazLoader.progressCB(r/s),n.hasMoreData?e():(i.totalRead=r,i.versionAsString=t.versionAsString,i.isCompressed=t.isCompressed,[t,i,o])})};return a()}).then(function(e){var t=e[0];return Potree.LasLazLoader.progressCB(1),t.close().then(function(){return t.isOpen=!1,Promise.delay(200).cancellable()}).then(function(){return e.slice(1)})}).catch(Promise.CancellationError,function(e){if(i.isOpen)return i.close().then(function(){throw i.isOpen=!1,e});throw e})},Potree.LasLazLoader.prototype.handle=function(e,t){},Potree.LasLazBatcher=function(e){this.push=function(t){var i=Potree.workers.lasdecoder.getWorker(),o=new THREE.Vector3(t.mins[0],t.mins[1],t.mins[2]),n=new THREE.Vector3(t.maxs[0],t.maxs[1],t.maxs[2]);o.add(e.pcoGeometry.offset),n.add(e.pcoGeometry.offset),i.onmessage=function(r){for(var s=new THREE.BufferGeometry,a=t.pointsCount,l=r.data.position,d=new Uint8Array(r.data.color),c=r.data.intensity,u=new Uint8Array(r.data.classification),h=new Uint8Array(r.data.returnNumber),p=new Uint8Array(r.data.numberOfReturns),m=new Uint16Array(r.data.pointSourceID),f=new ArrayBuffer(4*a),v=new Uint32Array(f),g=new THREE.Box3,y=new Float32Array(l),E=0;E<a;E++)v[E]=E,g.expandByPoint(new THREE.Vector3(y[3*E+0],y[3*E+1],y[3*E+2]));s.addAttribute("position",new THREE.BufferAttribute(new Float32Array(l),3)),s.addAttribute("color",new THREE.BufferAttribute(d,3,(!0))),s.addAttribute("intensity",new THREE.BufferAttribute(new Float32Array(c),1)),s.addAttribute("classification",new THREE.BufferAttribute(u,1)),s.addAttribute("returnNumber",new THREE.BufferAttribute(h,1)),s.addAttribute("numberOfReturns",new THREE.BufferAttribute(p,1)),s.addAttribute("pointSourceID",new THREE.BufferAttribute(m,1)),s.addAttribute("indices",new THREE.BufferAttribute(f,1)),s.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(3*a),3));var b=new THREE.Box3((new THREE.Vector3).fromArray(r.data.tightBoundingBox.min),(new THREE.Vector3).fromArray(r.data.tightBoundingBox.max));s.boundingBox=new THREE.Box3(o,n),e.tightBoundingBox=b,e.geometry=s,e.loaded=!0,e.loading=!1,e.pcoGeometry.numNodesLoading--,Potree.workers.lasdecoder.returnWorker(i)};var r={buffer:t.arrayb,numPoints:t.pointsCount,pointSize:t.pointSize,pointFormatID:2,scale:t.scale,offset:t.offset,mins:[e.pcoGeometry.boundingBox.min.x,e.pcoGeometry.boundingBox.min.y,e.pcoGeometry.boundingBox.min.z],maxs:[e.pcoGeometry.boundingBox.max.x,e.pcoGeometry.boundingBox.max.y,e.pcoGeometry.boundingBox.max.z],bbOffset:[e.pcoGeometry.offset.x,e.pcoGeometry.offset.y,e.pcoGeometry.offset.z]};i.postMessage(r,[r.buffer])}},Potree.Gradients={RAINBOW:[[0,new THREE.Color(.278,0,.714)],[1/6,new THREE.Color(0,0,1)],[2/6,new THREE.Color(0,1,1)],[.5,new THREE.Color(0,1,0)],[4/6,new THREE.Color(1,1,0)],[5/6,new THREE.Color(1,.64,0)],[1,new THREE.Color(1,0,0)]],GRAYSCALE:[[0,new THREE.Color(0,0,0)],[1,new THREE.Color(1,1,1)]]},Potree.Classification={DEFAULT:{0:new THREE.Vector4(.5,.5,.5,1),1:new THREE.Vector4(.5,.5,.5,1),2:new THREE.Vector4(.63,.32,.18,1),3:new THREE.Vector4(0,1,0,1),4:new THREE.Vector4(0,.8,0,1),5:new THREE.Vector4(0,.6,0,1),6:new THREE.Vector4(1,.66,0,1),7:new THREE.Vector4(1,0,1,1),8:new THREE.Vector4(1,0,0,1),9:new THREE.Vector4(0,0,1,1),12:new THREE.Vector4(1,1,0,1),DEFAULT:new THREE.Vector4(.3,.6,.6,.5)}},Potree.PointSizeType={FIXED:0,ATTENUATED:1,ADAPTIVE:2},Potree.PointShape={SQUARE:0,CIRCLE:1},Potree.PointColorType={RGB:0,COLOR:1,DEPTH:2,HEIGHT:3,ELEVATION:3,INTENSITY:4,INTENSITY_GRADIENT:5,LOD:6,LEVEL_OF_DETAIL:6,POINT_INDEX:7,CLASSIFICATION:8,RETURN_NUMBER:9,SOURCE:10,NORMAL:11,PHONG:12,RGB_HEIGHT:13,COMPOSITE:50},Potree.ClipMode={DISABLED:0,CLIP_OUTSIDE:1,HIGHLIGHT_INSIDE:2},Potree.TreeType={OCTREE:0,KDTREE:1},Potree.PointCloudMaterial=function(e){THREE.Material.call(this),e=e||{},this.visibleNodesTexture=Potree.utils.generateDataTexture(2048,1,new THREE.Color(16777215)),this.visibleNodesTexture.minFilter=THREE.NearestFilter,this.visibleNodesTexture.magFilter=THREE.NearestFilter;var t=e.size||1,i=e.minSize||1,o=e.maxSize||50,n=e.treeType||Potree.TreeType.OCTREE;this._pointSizeType=Potree.PointSizeType.ATTENUATED,this._pointShape=Potree.PointShape.SQUARE,this._interpolate=!1,this._pointColorType=Potree.PointColorType.RGB,this._useClipBox=!1,this.numClipBoxes=0,this._clipMode=Potree.ClipMode.DISABLED,this._weighted=!1,this._depthMap=null,this._gradient=Potree.Gradients.RAINBOW,this._classification=Potree.Classification.DEFAULT,this.gradientTexture=Potree.PointCloudMaterial.generateGradientTexture(this._gradient),this.classificationTexture=Potree.PointCloudMaterial.generateClassificationTexture(this._classification),this.lights=!1,this.fog=!1,this._treeType=n,this._useEDL=!1,this.attributes=_defineProperty({position:{type:"fv",value:[]},color:{type:"fv",value:[]},normal:{type:"fv",value:[]},intensity:{type:"f",value:[]},classification:{type:"f",value:[]},returnNumber:{type:"f",value:[]},numberOfReturns:{type:"f",value:[]},pointSourceID:{type:"f",value:[]}},"normal",{type:"f",value:[]}),this.uniforms={spacing:{type:"f",value:1},blendHardness:{type:"f",value:2},blendDepthSupplement:{type:"f",value:0},fov:{type:"f",value:1},screenWidth:{type:"f",value:1},screenHeight:{type:"f",value:1},near:{type:"f",value:.1},far:{type:"f",value:1},uColor:{type:"c",value:new THREE.Color(16777215)},opacity:{type:"f",value:1},size:{type:"f",value:t},minSize:{type:"f",value:i},maxSize:{type:"f",value:o},octreeSize:{type:"f",value:0},bbSize:{type:"fv",value:[0,0,0]},heightMin:{type:"f",value:0},heightMax:{type:"f",value:1},intensityMin:{type:"f",value:0},intensityMax:{type:"f",value:1},clipBoxCount:{type:"f",value:0},visibleNodes:{type:"t",value:this.visibleNodesTexture},pcIndex:{type:"f",value:0},gradient:{type:"t",value:this.gradientTexture},classificationLUT:{type:"t",value:this.classificationTexture},clipBoxes:{type:"Matrix4fv",value:[]},clipBoxPositions:{type:"fv",value:null},depthMap:{type:"t",value:null},diffuse:{type:"fv",value:[1,1,1]},transition:{type:"f",value:.5},intensityRange:{type:"fv",value:[0,65e3]},intensityGamma:{type:"f",value:1},intensityContrast:{type:"f",value:0},intensityBrightness:{type:"f",value:0},rgbGamma:{type:"f",value:1},rgbContrast:{type:"f",value:0},rgbBrightness:{type:"f",value:0},wRGB:{type:"f",value:1},wIntensity:{type:"f",value:0},wElevation:{type:"f",value:0},wClassification:{type:"f",value:0},wReturnNumber:{type:"f",value:0},wSourceID:{type:"f",value:0}},this.defaultAttributeValues.normal=[0,0,0],this.defaultAttributeValues.classification=[0,0,0],this.vertexShader=this.getDefines()+Potree.Shaders["pointcloud.vs"],this.fragmentShader=this.getDefines()+Potree.Shaders["pointcloud.fs"],this.vertexColors=THREE.VertexColors},Potree.PointCloudMaterial.prototype=new THREE.RawShaderMaterial,Potree.PointCloudMaterial.prototype.updateShaderSource=function(){this.vertexShader=this.getDefines()+Potree.Shaders["pointcloud.vs"],this.fragmentShader=this.getDefines()+Potree.Shaders["pointcloud.fs"],this.depthMap&&(this.uniforms.depthMap.value=this.depthMap,this.depthMap=depthMap),1===this.opacity?(this.blending=THREE.NoBlending,this.transparent=!1,this.depthTest=!0,this.depthWrite=!0):(this.blending=THREE.AdditiveBlending,this.transparent=!0,this.depthTest=!1,this.depthWrite=!0),this.weighted&&(this.blending=THREE.AdditiveBlending,this.transparent=!0,this.depthTest=!0,this.depthWrite=!1),this.needsUpdate=!0},Potree.PointCloudMaterial.prototype.getDefines=function(){var e="";return this.pointSizeType===Potree.PointSizeType.FIXED?e+="#define fixed_point_size\n":this.pointSizeType===Potree.PointSizeType.ATTENUATED?e+="#define attenuated_point_size\n":this.pointSizeType===Potree.PointSizeType.ADAPTIVE&&(e+="#define adaptive_point_size\n"),this.pointShape===Potree.PointShape.SQUARE?e+="#define square_point_shape\n":this.pointShape===Potree.PointShape.CIRCLE&&(e+="#define circle_point_shape\n"),this._interpolate&&(e+="#define use_interpolation\n"),this._useEDL&&(e+="#define use_edl\n"),this._pointColorType===Potree.PointColorType.RGB?e+="#define color_type_rgb\n":this._pointColorType===Potree.PointColorType.COLOR?e+="#define color_type_color\n":this._pointColorType===Potree.PointColorType.DEPTH?e+="#define color_type_depth\n":this._pointColorType===Potree.PointColorType.HEIGHT?e+="#define color_type_height\n":this._pointColorType===Potree.PointColorType.INTENSITY?e+="#define color_type_intensity\n":this._pointColorType===Potree.PointColorType.INTENSITY_GRADIENT?e+="#define color_type_intensity_gradient\n":this._pointColorType===Potree.PointColorType.LOD?e+="#define color_type_lod\n":this._pointColorType===Potree.PointColorType.POINT_INDEX?e+="#define color_type_point_index\n":this._pointColorType===Potree.PointColorType.CLASSIFICATION?e+="#define color_type_classification\n":this._pointColorType===Potree.PointColorType.RETURN_NUMBER?e+="#define color_type_return_number\n":this._pointColorType===Potree.PointColorType.SOURCE?e+="#define color_type_source\n":this._pointColorType===Potree.PointColorType.NORMAL?e+="#define color_type_normal\n":this._pointColorType===Potree.PointColorType.PHONG?e+="#define color_type_phong\n":this._pointColorType===Potree.PointColorType.RGB_HEIGHT?e+="#define color_type_rgb_height\n":this._pointColorType===Potree.PointColorType.COMPOSITE&&(e+="#define color_type_composite\n"),this.clipMode===Potree.ClipMode.DISABLED?e+="#define clip_disabled\n":this.clipMode===Potree.ClipMode.CLIP_OUTSIDE?e+="#define clip_outside\n":this.clipMode===Potree.ClipMode.HIGHLIGHT_INSIDE&&(e+="#define clip_highlight_inside\n"),this._treeType===Potree.TreeType.OCTREE?e+="#define tree_type_octree\n":this._treeType===Potree.TreeType.KDTREE&&(e+="#define tree_type_kdtree\n"),this.weighted&&(e+="#define weighted_splats\n"),this.numClipBoxes>0&&(e+="#define use_clip_box\n"),e},Potree.PointCloudMaterial.prototype.setClipBoxes=function(e){if(e){this.clipBoxes=e;var t=this.numClipBoxes!=e.length&&(0===e.length||0===this.numClipBoxes);this.numClipBoxes=e.length,this.uniforms.clipBoxCount.value=this.numClipBoxes,t&&this.updateShaderSource(),this.uniforms.clipBoxes.value=new Float32Array(16*this.numClipBoxes),this.uniforms.clipBoxPositions.value=new Float32Array(3*this.numClipBoxes);for(var i=0;i<this.numClipBoxes;i++){var o=e[i];this.uniforms.clipBoxes.value.set(o.inverse.elements,16*i),this.uniforms.clipBoxPositions.value[3*i+0]=o.position.x,
this.uniforms.clipBoxPositions.value[3*i+1]=o.position.y,this.uniforms.clipBoxPositions.value[3*i+2]=o.position.z}}},Object.defineProperty(Potree.PointCloudMaterial.prototype,"gradient",{get:function(){return this._gradient},set:function(e){this._gradient!==e&&(this._gradient=e,this.gradientTexture=Potree.PointCloudMaterial.generateGradientTexture(this._gradient),this.uniforms.gradient.value=this.gradientTexture)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"classification",{get:function(){return this._classification},set:function(e){this._classification=e,this.classificationTexture=Potree.PointCloudMaterial.generateClassificationTexture(this._classification),this.uniforms.classificationLUT.value=this.classificationTexture}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"spacing",{get:function(){return this.uniforms.spacing.value},set:function(e){this.uniforms.spacing.value!==e&&(this.uniforms.spacing.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"useClipBox",{get:function(){return this._useClipBox},set:function(e){this._useClipBox!==e&&(this._useClipBox=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"weighted",{get:function(){return this._weighted},set:function(e){this._weighted!==e&&(this._weighted=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"fov",{get:function(){return this.uniforms.fov.value},set:function(e){this.uniforms.fov.value!==e&&(this.uniforms.fov.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"screenWidth",{get:function(){return this.uniforms.screenWidth.value},set:function(e){this.uniforms.screenWidth.value!==e&&(this.uniforms.screenWidth.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"screenHeight",{get:function(){return this.uniforms.screenHeight.value},set:function(e){this.uniforms.screenHeight.value!==e&&(this.uniforms.screenHeight.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"near",{get:function(){return this.uniforms.near.value},set:function(e){this.uniforms.near.value!==e&&(this.uniforms.near.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"far",{get:function(){return this.uniforms.far.value},set:function(e){this.uniforms.far.value!==e&&(this.uniforms.far.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"opacity",{get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity&&this.uniforms.opacity.value!==e&&(this.uniforms.opacity.value=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"pointColorType",{get:function(){return this._pointColorType},set:function(e){this._pointColorType!==e&&(this._pointColorType=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"depthMap",{get:function(){return this._depthMap},set:function(e){this._depthMap!==e&&(this._depthMap=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"pointSizeType",{get:function(){return this._pointSizeType},set:function(e){this._pointSizeType!==e&&(this._pointSizeType=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"clipMode",{get:function(){return this._clipMode},set:function(e){this._clipMode!==e&&(this._clipMode=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"interpolate",{get:function(){return this._interpolate},set:function(e){this._interpolate!==e&&(this._interpolate=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"useEDL",{get:function(){return this._useEDL},set:function(e){this._useEDL!==e&&(this._useEDL=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"color",{get:function(){return this.uniforms.uColor.value},set:function(e){this.uniforms.uColor.value!==e&&(this.uniforms.uColor.value.copy(e),this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"pointShape",{get:function(){return this._pointShape},set:function(e){this._pointShape!==e&&(this._pointShape=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"treeType",{get:function(){return this._treeType},set:function(e){this._treeType!=e&&(this._treeType=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"bbSize",{get:function(){return this.uniforms.bbSize.value},set:function(e){this.uniforms.bbSize.value=e}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"size",{get:function(){return this.uniforms.size.value},set:function(e){this.uniforms.size.value=e}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"heightMin",{get:function(){return this.uniforms.heightMin.value},set:function(e){this.uniforms.heightMin.value=e}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"heightMax",{get:function(){return this.uniforms.heightMax.value},set:function(e){this.uniforms.heightMax.value=e}}),Potree.PointCloudMaterial.generateGradientTexture=function(e){var t=64;canvas=document.createElement("canvas"),canvas.width=t,canvas.height=t;var i=canvas.getContext("2d");i.rect(0,0,t,t);for(var o=i.createLinearGradient(0,0,t,t),n=0;n<e.length;n++){var r=e[n];o.addColorStop(r[0],"#"+r[1].getHexString())}i.fillStyle=o,i.fill();var s=new THREE.Texture(canvas);return s.needsUpdate=!0,textureImage=s.image,s},Potree.PointCloudMaterial.generateClassificationTexture=function(e){for(var t=256,i=256,o=t*i,n=new Uint8Array(4*o),r=0;r<t;r++)for(var s=0;s<i;s++){var a,l=r+t*s;a=e[r]?e[r]:e.DEFAULT,n[4*l+0]=255*a.x,n[4*l+1]=255*a.y,n[4*l+2]=255*a.z,n[4*l+3]=255*a.w}var d=new THREE.DataTexture(n,t,i,THREE.RGBAFormat);return d.magFilter=THREE.NearestFilter,d.needsUpdate=!0,d},Potree.EyeDomeLightingMaterial=function(e){THREE.Material.call(this),e=e||{},this._neighbourCount=4,this.neighbours=new Float32Array(2*this.neighbourCount);for(var t=0;t<this.neighbourCount;t++)this.neighbours[2*t+0]=Math.cos(2*t*Math.PI/this.neighbourCount),this.neighbours[2*t+1]=Math.sin(2*t*Math.PI/this.neighbourCount);var i=(new THREE.Vector3(0,0,1).normalize(),{screenWidth:{type:"f",value:0},screenHeight:{type:"f",value:0},edlStrength:{type:"f",value:1},radius:{type:"f",value:1},neighbours:{type:"2fv",value:this.neighbours},depthMap:{type:"t",value:null},colorMap:{type:"t",value:null},opacity:{type:"f",value:1}});this.setValues({uniforms:i,vertexShader:this.getDefines()+Potree.Shaders["edl.vs"],fragmentShader:this.getDefines()+Potree.Shaders["edl.fs"],lights:!1})},Potree.EyeDomeLightingMaterial.prototype=new THREE.ShaderMaterial,Potree.EyeDomeLightingMaterial.prototype.getDefines=function(){var e="";return e+="#define NEIGHBOUR_COUNT "+this.neighbourCount+"\n"},Potree.EyeDomeLightingMaterial.prototype.updateShaderSource=function(){var e={};this.pointColorType===Potree.PointColorType.INTENSITY||this.pointColorType===Potree.PointColorType.INTENSITY_GRADIENT?e.intensity={type:"f",value:[]}:this.pointColorType===Potree.PointColorType.CLASSIFICATION||(this.pointColorType===Potree.PointColorType.RETURN_NUMBER?(e.returnNumber={type:"f",value:[]},e.numberOfReturns={type:"f",value:[]}):this.pointColorType===Potree.PointColorType.SOURCE?e.pointSourceID={type:"f",value:[]}:this.pointColorType!==Potree.PointColorType.NORMAL&&this.pointColorType!==Potree.PointColorType.PHONG||(e.normal={type:"f",value:[]})),e.classification={type:"f",value:0};var t=this.getDefines()+Potree.Shaders["edl.vs"],i=this.getDefines()+Potree.Shaders["edl.fs"];this.setValues({vertexShader:t,fragmentShader:i}),this.uniforms.neighbours.value=this.neighbours,this.needsUpdate=!0},Object.defineProperty(Potree.EyeDomeLightingMaterial.prototype,"neighbourCount",{get:function(){return this._neighbourCount},set:function(e){if(this._neighbourCount!==e){this._neighbourCount=e,this.neighbours=new Float32Array(2*this._neighbourCount);for(var t=0;t<this._neighbourCount;t++)this.neighbours[2*t+0]=Math.cos(2*t*Math.PI/this._neighbourCount),this.neighbours[2*t+1]=Math.sin(2*t*Math.PI/this._neighbourCount);this.updateShaderSource()}}}),Potree.BlurMaterial=function(e){THREE.Material.call(this),e=e||{};var t={near:{type:"f",value:0},far:{type:"f",value:0},screenWidth:{type:"f",value:0},screenHeight:{type:"f",value:0},map:{type:"t",value:null}};this.setValues({uniforms:t,vertexShader:Potree.Shaders["blur.vs"],fragmentShader:Potree.Shaders["blur.fs"]})},Potree.BlurMaterial.prototype=new THREE.ShaderMaterial,THREE.FirstPersonControls=function(e,t){function i(e){l.enabled!==!1&&(e.preventDefault(),0===e.button?(P=T.ROTATE,d.set(e.clientX,e.clientY)):2===e.button&&(P=T.PAN,h.set(e.clientX,e.clientY)),l.domElement.addEventListener("mousemove",o,!1),l.domElement.addEventListener("mouseup",n,!1),l.dispatchEvent(C))}function o(e){if(l.enabled!==!1){e.preventDefault();var t=l.domElement===document?l.domElement.body:l.domElement;P===T.ROTATE?(c.set(e.clientX,e.clientY),u.subVectors(c,d),l.rotateLeft(2*Math.PI*u.x/t.clientWidth*l.rotateSpeed),l.rotateUp(2*Math.PI*u.y/t.clientHeight*l.rotateSpeed),d.copy(c)):P===T.PAN&&(p.set(e.clientX,e.clientY),m.subVectors(p,h),m.multiplyScalar(5e-4).multiplyScalar(l.moveSpeed),l.pan(m.x,m.y),h.copy(p))}}function n(){l.enabled!==!1&&(l.domElement.removeEventListener("mousemove",o,!1),l.domElement.removeEventListener("mouseup",n,!1),l.dispatchEvent(w),P=T.NONE)}function r(e){if(l.enabled!==!1&&l.noZoom!==!0){e.preventDefault();var t=e.detail<0||e.wheelDelta>0?1:-1,i=l.moveSpeed+.1*l.moveSpeed*t;i=Math.max(.1,i),l.setMoveSpeed(i),l.dispatchEvent(C),l.dispatchEvent(w)}}function s(e){if(l.enabled!==!1)switch(e.keyCode){case l.keys.UP:l.moveForward=!0;break;case l.keys.BOTTOM:l.moveBackward=!0;break;case l.keys.LEFT:l.moveLeft=!0;break;case l.keys.RIGHT:l.moveRight=!0;break;case l.keys.W:l.moveForward=!0;break;case l.keys.S:l.moveBackward=!0;break;case l.keys.A:l.moveLeft=!0;break;case l.keys.D:l.moveRight=!0}}function a(e){switch(e.keyCode){case l.keys.W:l.moveForward=!1;break;case l.keys.S:l.moveBackward=!1;break;case l.keys.A:l.moveLeft=!1;break;case l.keys.D:l.moveRight=!1;break;case l.keys.UP:l.moveForward=!1;break;case l.keys.BOTTOM:l.moveBackward=!1;break;case l.keys.LEFT:l.moveLeft=!1;break;case l.keys.RIGHT:l.moveRight=!1}}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.rotateSpeed=1,this.moveSpeed=10,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40,A:"A".charCodeAt(0),S:"S".charCodeAt(0),D:"D".charCodeAt(0),W:"W".charCodeAt(0)};var l=this,d=new THREE.Vector2,c=new THREE.Vector2,u=new THREE.Vector2,h=new THREE.Vector2,p=new THREE.Vector2,m=new THREE.Vector2,f=new THREE.Vector3,v=(new THREE.Vector3,0),g=0,y=1,E=new THREE.Vector3,b=new THREE.Vector3,T={NONE:-1,ROTATE:0,SPEEDCHANGE:1,PAN:2},P=T.NONE;this.position0=this.object.position.clone();var R={type:"change"},C={type:"start"},w={type:"end"};this.rotateLeft=function(e){g-=e},this.rotateUp=function(e){v-=e},this.panLeft=function(e){var t=this.object.matrix.elements;f.set(t[0],t[1],t[2]),f.multiplyScalar(-e),E.add(f)},this.panUp=function(e){var t=this.object.matrix.elements;f.set(t[4],t[5],t[6]),f.multiplyScalar(e),E.add(f)},this.panForward=function(e){var t=this.object.matrix.elements;f.set(t[8],t[9],t[10]),f.multiplyScalar(e),E.add(f)},this.pan=function(e,t){var i=l.domElement===document?l.domElement.body:l.domElement;if(void 0!==l.object.fov){var o=l.object.position,n=o.clone(),r=n.length();r*=Math.tan(l.object.fov/2*Math.PI/180),l.panLeft(2*e*r/i.clientHeight),l.panUp(2*t*r/i.clientHeight)}else void 0!==l.object.top?(l.panLeft(e*(l.object.right-l.object.left)/i.clientWidth),l.panUp(t*(l.object.top-l.object.bottom)/i.clientHeight)):console.warn("WARNING: FirstPersonControls.js encountered an unknown camera type - pan disabled.")},this.update=function(e){this.object.rotation.order="ZYX";var t=this.object;this.object=new THREE.Object3D,this.object.position.copy(t.position),this.object.rotation.copy(t.rotation),this.object.updateMatrix(),this.object.updateMatrixWorld();var i=this.object.position;if(void 0!==e&&(this.moveRight&&this.panLeft(-e*this.moveSpeed),this.moveLeft&&this.panLeft(e*this.moveSpeed),this.moveForward&&this.panForward(-e*this.moveSpeed),this.moveBackward&&this.panForward(e*this.moveSpeed)),!E.equals(new THREE.Vector3(0,0,0))){var o={type:"move",translation:E.clone()};this.dispatchEvent(o)}if(i.add(E),0!==g||0!==v){var o={type:"rotate",thetaDelta:g,phiDelta:v};this.dispatchEvent(o)}this.object.updateMatrix();var n=(new THREE.Matrix4).makeRotationY(g),r=(new THREE.Matrix4).multiplyMatrices(n,this.object.matrix);this.object.quaternion.setFromRotationMatrix(r),this.object.rotation.x+=v,this.object.updateMatrixWorld();var s={type:"proposeTransform",oldPosition:t.position,newPosition:this.object.position,objections:0,counterProposals:[]};if(this.dispatchEvent(s),s.objections>0&&s.counterProposals.length>0){var a=s.counterProposals;this.object.position.copy(a[0]),s.objections=0,s.counterProposals=[]}s.objections>0||t.position.copy(this.object.position),t.rotation.copy(this.object.rotation),this.object=t,g=0,v=0,y=1,E.set(0,0,0),b.distanceTo(this.object.position)>0&&(this.dispatchEvent(R),b.copy(this.object.position))},this.reset=function(){P=T.NONE,this.object.position.copy(this.position0)},this.setMoveSpeed=function(e){l.moveSpeed!==e&&(l.moveSpeed=e,l.dispatchEvent({type:"move_speed_changed",controls:l}))},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",i,!1),this.domElement.addEventListener("mousewheel",r,!1),this.domElement.addEventListener("DOMMouseScroll",r,!1),this.domElement.tabIndex===-1&&(this.domElement.tabIndex=2222),this.domElement.addEventListener("keydown",s,!1),this.domElement.addEventListener("keyup",a,!1)},THREE.FirstPersonControls.prototype=Object.create(THREE.EventDispatcher.prototype),Potree.GeoControls=function(e,t){function i(e){l.enabled!==!1&&(e.preventDefault(),0===e.button?(P=T.ROTATE,d.set(e.clientX,e.clientY)):1===e.button?(P=T.PAN,h.set(e.clientX,e.clientY)):2===e.button&&(l.moveForwardMouse=!0),l.dispatchEvent(C))}function o(e){if(l.enabled!==!1){e.preventDefault();var t=l.domElement===document?l.domElement.body:l.domElement;P===T.ROTATE?(c.set(e.clientX,e.clientY),u.subVectors(c,d),l.rotateLeft(2*Math.PI*u.x/t.clientWidth*l.rotateSpeed),l.rotateUp(2*Math.PI*u.y/t.clientHeight*l.rotateSpeed),d.copy(c)):P===T.PAN&&(p.set(e.clientX,e.clientY),m.subVectors(p,h),m.multiplyScalar(.002).multiplyScalar(l.moveSpeed),l.pan(m.x,m.y),h.copy(p))}}function n(e){l.enabled!==!1&&(2===e.button?l.moveForwardMouse=!1:(l.dispatchEvent(w),P=T.NONE))}function r(e){if(l.enabled!==!1&&l.noZoom!==!0){e.preventDefault();var t=e.detail<0||e.wheelDelta>0?1:-1,i=l.moveSpeed+.1*l.moveSpeed*t;i=Math.max(.1,i),l.setMoveSpeed(i),l.dispatchEvent(C),l.dispatchEvent(w)}}function s(e){if(l.enabled!==!1)switch(l.shiftDown=e.shiftKey,e.keyCode){case l.keys.UP:l.moveForward=!0;break;case l.keys.BOTTOM:l.moveBackward=!0;break;case l.keys.LEFT:l.moveLeft=!0;break;case l.keys.RIGHT:l.moveRight=!0;break;case l.keys.W:l.moveForward=!0;break;case l.keys.S:l.moveBackward=!0;break;case l.keys.A:l.moveLeft=!0;break;case l.keys.D:l.moveRight=!0;break;case l.keys.Q:l.rotLeft=!0;break;case l.keys.E:l.rotRight=!0;break;case l.keys.R:l.raiseCamera=!0;break;case l.keys.F:l.lowerCamera=!0}}function a(e){switch(l.shiftDown=e.shiftKey,e.keyCode){case l.keys.W:l.moveForward=!1;break;case l.keys.S:l.moveBackward=!1;break;case l.keys.A:l.moveLeft=!1;break;case l.keys.D:l.moveRight=!1;break;case l.keys.UP:l.moveForward=!1;break;case l.keys.BOTTOM:l.moveBackward=!1;break;case l.keys.LEFT:l.moveLeft=!1;break;case l.keys.RIGHT:l.moveRight=!1;break;case l.keys.Q:l.rotLeft=!1;break;case l.keys.E:l.rotRight=!1;break;case l.keys.R:l.raiseCamera=!1;break;case l.keys.F:l.lowerCamera=!1}}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.track=null,this.trackPos=0,this.rotateSpeed=1,this.moveSpeed=10,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40,A:"A".charCodeAt(0),S:"S".charCodeAt(0),D:"D".charCodeAt(0),W:"W".charCodeAt(0),Q:"Q".charCodeAt(0),E:"E".charCodeAt(0),R:"R".charCodeAt(0),F:"F".charCodeAt(0)};var l=this,d=new THREE.Vector2,c=new THREE.Vector2,u=new THREE.Vector2,h=new THREE.Vector2,p=new THREE.Vector2,m=new THREE.Vector2,f=new THREE.Vector3,v=(new THREE.Vector3,0),g=0,y=1,E=new THREE.Vector3;this.shiftDown=!1;var b=new THREE.Vector3,T={NONE:-1,ROTATE:0,SPEEDCHANGE:1,PAN:2},P=T.NONE;this.position0=this.object.position.clone();var R={type:"change"},C={type:"start"},w={type:"end"};this.setTrack=function(e){this.track!==e&&(this.track=e,this.trackPos=null)},this.setTrackPos=function(e,t){var i=Math.max(0,Math.min(1,e)),o=this.trackPos||i,n=this.track.getTangentAt(i),r=this.track.getTangentAt(o);if(n.equals(r));else{var s=(new THREE.Vector3).crossVectors(r,n).normalize(),a=r.angleTo(n),d=(new THREE.Matrix4).makeRotationAxis(s,a),c=this.object.getWorldDirection().clone();c=c.applyMatrix4(d);var u=(new THREE.Vector3).addVectors(this.object.position,c);this.object.lookAt(u),this.object.updateMatrixWorld();var h={type:"path_relative_rotation",angle:a,axis:s,controls:l};this.dispatchEvent(h)}if(null===this.trackPos){var u=(new THREE.Vector3).addVectors(this.object.position,n);this.object.lookAt(u)}if(this.trackPos=i,i!==o){var h={type:"move",translation:E.clone()};this.dispatchEvent(h)}},this.getTrackPos=function(){return this.trackPos},this.rotateLeft=function(e){g-=e},this.rotateUp=function(e){v-=e},this.panLeft=function(e){var t=this.object.matrix.elements;f.set(t[0],t[1],t[2]),f.multiplyScalar(-e),E.add(f)},this.panUp=function(e){var t=this.object.matrix.elements;f.set(t[4],t[5],t[6]),f.multiplyScalar(e),E.add(f)},this.panForward=function(e){if(this.track)this.setTrackPos(this.getTrackPos()-e/this.track.getLength());else{var t=this.object.matrix.elements;f.set(t[8],t[9],t[10]),f.multiplyScalar(e),E.add(f)}},this.pan=function(e,t){var i=l.domElement===document?l.domElement.body:l.domElement;if(void 0!==l.object.fov){var o=l.object.position,n=o.clone(),r=n.length();r*=Math.tan(l.object.fov/2*Math.PI/180),l.panLeft(2*e*r/i.clientHeight),l.panUp(2*t*r/i.clientHeight)}else void 0!==l.object.top?(l.panLeft(e*(l.object.right-l.object.left)/i.clientWidth),l.panUp(t*(l.object.top-l.object.bottom)/i.clientHeight)):console.warn("WARNING: GeoControls.js encountered an unknown camera type - pan disabled.")},this.update=function(e){this.object.rotation.order="ZYX";var t=this.object;this.object=new THREE.Object3D,this.object.position.copy(t.position),this.object.rotation.copy(t.rotation),this.object.updateMatrix(),this.object.updateMatrixWorld();var i=this.object.position;if(void 0!==e){var o=l.shiftDown?4:1;this.moveRight&&this.panLeft(-e*this.moveSpeed*o),this.moveLeft&&this.panLeft(e*this.moveSpeed*o),(this.moveForward||this.moveForwardMouse)&&this.panForward(-e*this.moveSpeed*o),this.moveBackward&&this.panForward(e*this.moveSpeed*o),this.rotLeft&&l.rotateLeft(-.5*Math.PI*e/l.rotateSpeed),this.rotRight&&l.rotateLeft(.5*Math.PI*e/l.rotateSpeed),this.raiseCamera&&l.panUp(e*this.moveSpeed*o),this.lowerCamera&&l.panUp(-e*this.moveSpeed*o)}if(!E.equals(new THREE.Vector3(0,0,0))){var n={type:"move",translation:E.clone()};this.dispatchEvent(n)}if(i.add(E),0!==g||0!==v){var n={type:"rotate",thetaDelta:g,phiDelta:v};this.dispatchEvent(n)}this.object.updateMatrix();var r=(new THREE.Matrix4).makeRotationY(g),s=(new THREE.Matrix4).multiplyMatrices(r,this.object.matrix);this.object.quaternion.setFromRotationMatrix(s),this.object.rotation.x+=v,this.object.updateMatrixWorld();var a={type:"proposeTransform",oldPosition:t.position,newPosition:this.object.position,objections:0,counterProposals:[]};if(this.dispatchEvent(a),a.objections>0&&a.counterProposals.length>0){var d=a.counterProposals;this.object.position.copy(d[0]),a.objections=0,a.counterProposals=[]}if(a.objections>0||t.position.copy(this.object.position),t.rotation.copy(this.object.rotation),this.object=t,g=0,v=0,y=1,E.set(0,0,0),b.distanceTo(this.object.position)>0&&(this.dispatchEvent(R),b.copy(this.object.position)),this.track){var c=this.track.getPointAt(this.trackPos);t.position.copy(c)}},this.reset=function(){P=T.NONE,this.object.position.copy(this.position0)},this.setMoveSpeed=function(e){l.moveSpeed!==e&&(l.moveSpeed=e,l.dispatchEvent({type:"move_speed_changed",controls:l}))},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",i,!1),this.domElement.addEventListener("mousewheel",r,!1),this.domElement.addEventListener("DOMMouseScroll",r,!1),l.domElement.addEventListener("mousemove",o,!1),l.domElement.addEventListener("mouseup",n,!1),this.domElement.tabIndex===-1&&(this.domElement.tabIndex=2222),l.domElement.addEventListener("keydown",s,!1),l.domElement.addEventListener("keyup",a,!1)},Potree.GeoControls.prototype=Object.create(THREE.EventDispatcher.prototype),Potree.OrbitControls=function(e){function t(){return Math.pow(.95,a.zoomSpeed)}function i(e){a.enabled!==!1&&(e.preventDefault(),e.button===THREE.MOUSE.LEFT?(T=b.ROTATE,d.set(e.clientX,e.clientY)):e.button===THREE.MOUSE.MIDDLE?(T=b.DOLLY,f.set(e.clientX,e.clientY)):e.button===THREE.MOUSE.RIGHT&&(T=b.PAN,h.set(e.clientX,e.clientY)),a.domElement.addEventListener("mousemove",o,!1),a.domElement.addEventListener("mouseup",n,!1),a.dispatchEvent(R))}function o(e){if(a.enabled!==!1){e.preventDefault();var t=a.domElement===document?a.domElement.body:a.domElement;if(T===b.ROTATE)c.set(e.clientX,e.clientY),u.subVectors(c,d),a.rotateLeft(2*Math.PI*u.x/t.clientWidth*a.rotateSpeed),a.rotateUp(2*Math.PI*u.y/t.clientHeight*a.rotateSpeed),d.copy(c);else if(T===b.DOLLY)v.set(e.clientX,e.clientY),g.subVectors(v,f),g.y>0?a.dollyIn():a.dollyOut(),f.copy(v);else if(T===b.PAN){p.set(e.clientX,e.clientY);var i=(new THREE.Vector2).subVectors(p,h);a.panDelta.x-=i.x,a.panDelta.y+=i.y,h.copy(p)}}}function n(){a.enabled!==!1&&(a.domElement.removeEventListener("mousemove",o,!1),a.domElement.removeEventListener("mouseup",n,!1),a.dispatchEvent(C),T=b.NONE)}function r(e){if(a.enabled!==!1){e.preventDefault();var t=0;void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.detail&&(t=-e.detail),t>0?a.dollyOut():a.dollyIn(),a.dispatchEvent(R),a.dispatchEvent(C)}}function s(e){a.enabled!==!1&&(e.keyCode===a.keys.UP?a.panDelta.y+=a.keyPanSpeed:e.keyCode===a.keys.BOTTOM?a.panDelta.y-=a.keyPanSpeed:e.keyCode===a.keys.LEFT?a.panDelta.x-=a.keyPanSpeed:e.keyCode===a.keys.RIGHT&&(a.panDelta.x+=a.keyPanSpeed))}this.renderer=e,this.domElement=e.domElement,this.enabled=!0,this.scene=null,this.minDistance=0,this.maxDistance=1/0,this.zoomSpeed=1,this.rotateSpeed=1,this.keyPanSpeed=7,this.minimumJumpDistance=.2,this.jumpDistance=null,this.fadeFactor=10,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var a=this,l=1e-6,d=new THREE.Vector2,c=new THREE.Vector2,u=new THREE.Vector2,h=new THREE.Vector2,p=new THREE.Vector2,m=(new THREE.Vector3,new THREE.Vector3),f=new THREE.Vector2,v=new THREE.Vector2,g=new THREE.Vector2;this.yawDelta=0,this.pitchDelta=0,this.panDelta=new THREE.Vector3;var y=1,E=new THREE.Vector3,b={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},T=b.NONE,P={type:"change"},R={type:"start"},C={type:"end"};this.setScene=function(e){this.scene=e},this.rotateLeft=function(e){this.yawDelta-=e},this.rotateUp=function(e){this.pitchDelta-=e},this.dollyIn=function(e){void 0===e&&(e=t()),y/=e},this.dollyOut=function(e){void 0===e&&(e=t()),y*=e},this.update=function(e){var t=this.scene.view.position.clone();m.copy(t).sub(this.scene.view.target);var i=Math.atan2(m.x,m.y),o=Math.atan2(Math.sqrt(m.x*m.x+m.y*m.y),m.z),n=Math.min(1,this.fadeFactor*e);i-=n*this.yawDelta,o+=n*this.pitchDelta,o=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,o)),o=Math.max(l,Math.min(Math.PI-l,o));var r=m.length();r+=(y-1)*r*n,r=Math.max(this.minDistance,Math.min(this.maxDistance,r));var s=(new THREE.Vector3).subVectors(this.scene.view.target,this.scene.view.position).normalize(),a=new THREE.Vector3(0,0,1),d=(new THREE.Vector3).crossVectors(s,a),c=(new THREE.Vector3).crossVectors(d,s),u=(new THREE.Vector3).addVectors(d.multiplyScalar(2*this.panDelta.x/this.domElement.clientWidth),c.multiplyScalar(2*this.panDelta.y/this.domElement.clientHeight)),h=this.scene.view.target.clone().add(u.multiplyScalar(n*r));m.x=r*Math.sin(o)*Math.sin(i),m.z=r*Math.cos(o),m.y=r*Math.sin(o)*Math.cos(i),t.copy(h).add(m);var p={type:"proposeTransform",oldPosition:this.scene.view.position,newPosition:t,objections:0,counterProposals:[]};if(this.dispatchEvent(p),p.objections>0&&p.counterProposals.length>0){var f=p.counterProposals;t.copy(f[0]),p.objections=0,p.counterProposals=[]}if(p.objections>0)this.yawDelta=0,this.pitchDelta=0,y=1,this.panDelta.set(0,0,0);else{this.scene.view.position.copy(t),this.scene.view.target.copy(h);var v=Math.max(0,1-this.fadeFactor*e);this.yawDelta*=v,this.pitchDelta*=v,y=1+(y-1)*v,this.panDelta.multiplyScalar(v)}E.distanceTo(this.scene.view.position)>0&&(this.dispatchEvent(P),E.copy(this.scene.view.position))},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",i,!1),this.domElement.addEventListener("mousewheel",r,!1),this.domElement.addEventListener("DOMMouseScroll",r,!1),this.domElement.tabIndex===-1&&(this.domElement.tabIndex=2222),this.domElement.addEventListener("keydown",s,!1),this.domElement.addEventListener("dblclick",function(e){if(0!==a.scene.pointclouds.length){e.preventDefault();for(var t=a.domElement.getBoundingClientRect(),i={x:(e.clientX-t.left)/a.domElement.clientWidth*2-1,y:2*-((e.clientY-t.top)/a.domElement.clientHeight)+1},o=null,n=Number.POSITIVE_INFINITY,r=null,s=0;s<a.scene.pointclouds.length;s++){var l=Potree.utils.getMousePointCloudIntersection(i,a.scene.camera,a.renderer,[a.scene.pointclouds[s]]);if(l){var d=a.scene.camera.position.distanceTo(l);d<n&&(o=a.scene.pointclouds[s],n=d,r=l)}}if(null!=r){var c=0;if(a.jumpDistance)c=a.jumpDistance;else{var u=a.scene.camera.position.distanceTo(a.scene.view.target),h=new THREE.Vector3(i.x,i.y,.5);h.unproject(a.scene.camera);var p=h.sub(a.scene.camera.position).normalize(),m=new THREE.Ray(a.scene.camera.position,p),f=o.nodesOnRay(o.visibleNodes,m),v=f[f.length-1],g=v.getBoundingSphere().radius,c=Math.min(u,g),c=Math.max(a.minimumJumpDistance,c)}var y=a.scene.camera.getWorldDirection().multiplyScalar(-1),E=(new THREE.Vector3).addVectors(r,y.multiplyScalar(c)),b=600,T=TWEEN.Easing.Quartic.Out;a.enabled=!1;var P=new TWEEN.Tween(a.scene.view.position).to(E,b);P.easing(T),P.start();var P=new TWEEN.Tween(a.scene.view.target).to(r,b);P.easing(T),P.onComplete(function(){a.enabled=!0,a.moveSpeed&&(a.fpControls.moveSpeed=g/2,a.geoControls.moveSpeed=g/2)}.bind(this)),P.start()}}}.bind(this))},Potree.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.EarthControls=function(e,t,i){function o(e){if(a.enabled!==!1){e.preventDefault();var t=a.domElement.getBoundingClientRect(),i={x:(e.clientX-t.left)/a.domElement.clientWidth*2-1,y:2*-((e.clientY-t.top)/a.domElement.clientHeight)+1},o=getMousePointCloudIntersection(i,a.camera,a.renderer,a.pointclouds);if(o){var s=(new THREE.Plane).setFromNormalAndCoplanarPoint(new THREE.Vector3(0,1,0),o),h=new THREE.Vector3(i.x,i.y,.5);h.unproject(a.camera);var p=h.sub(a.camera.position).normalize(),m=new THREE.Ray(a.camera.position,p);v=m.intersectPlane(s),f=a.camera.clone(),f.rotation.copy(a.camera.rotation),c.set(e.clientX-t.left,e.clientY-t.top),u.set(e.clientX-t.left,e.clientY-t.top),a.scene.add(a.pivotNode),a.pivotNode.position.copy(v),e.button===THREE.MOUSE.LEFT?d=l.DRAG:e.button===THREE.MOUSE.RIGHT&&(d=l.ROTATE),a.domElement.addEventListener("mousemove",n,!1),a.domElement.addEventListener("mouseup",r,!1),a.dispatchEvent(g)}}}function n(e){if(a.enabled!==!1){e.preventDefault();var t=a.domElement.getBoundingClientRect();a.domElement===document?a.domElement.body:a.domElement;m.set(e.clientX-t.left-u.x,e.clientY-t.top-u.y),u.set(e.clientX-t.left,e.clientY-t.top)}}function r(){a.enabled!==!1&&(a.domElement.removeEventListener("mousemove",n,!1),a.domElement.removeEventListener("mouseup",r,!1),d=l.NONE,a.scene.remove(a.pivotNode),a.dispatchEvent(y))}function s(e){if(a.enabled!==!1&&a.noZoom!==!0){e.preventDefault();var t=a.domElement.getBoundingClientRect(),i=e.detail<0||e.wheelDelta>0?1:-1,o={x:(e.clientX-t.left)/a.domElement.clientWidth*2-1,y:2*-((e.clientY-t.top)/a.domElement.clientHeight)+1},n=getMousePointCloudIntersection(o,a.camera,a.renderer,a.pointclouds);if(n){var r=n.distanceTo(a.camera.position),s=(new THREE.Vector3).subVectors(n,a.camera.position).normalize();a.camera.position.add(s.multiplyScalar(.1*r*i))}a.dispatchEvent(g),a.dispatchEvent(y)}}this.camera=e,this.renderer=t,this.pointclouds=[],this.domElement=t.domElement,this.scene=i,this.enabled=!0;var a=this,l={NONE:-1,DRAG:0,ROTATE:1},d=l.NONE,c=new THREE.Vector2,u=new THREE.Vector2,h=new THREE.SphereGeometry(1,32,32),p=new THREE.MeshNormalMaterial({shading:THREE.SmoothShading,transparent:!0,opacity:.5});this.pivotNode=new THREE.Mesh(h,p);var m=new THREE.Vector2,f=null,v=null,g={type:"start"},y={type:"end"};this.minAngle=10/180*Math.PI,this.maxAngle=70/180*Math.PI,this.update=function(e){this.camera.position;this.camera.updateMatrixWorld();var t=new THREE.Object3D;if(t.position.copy(this.camera.position),t.rotation.copy(this.camera.rotation),t.updateMatrix(),t.updateMatrixWorld(),v){if(d===l.DRAG){var i=(new THREE.Plane).setFromNormalAndCoplanarPoint(new THREE.Vector3(0,1,0),v),o={x:u.x/this.domElement.clientWidth*2-1,y:2*-(u.y/this.domElement.clientHeight)+1},n=new THREE.Vector3(o.x,o.y,.5);n.unproject(f);var r=n.sub(f.position).normalize(),s=new THREE.Ray(f.position,r),a=s.distanceToPlane(i);if(a>0){var c=(new THREE.Vector3).subVectors(v,r.clone().multiplyScalar(a));t.position.copy(c)}}else if(d===l.ROTATE){var h=m.clone().multiplyScalar(e);h.x*=.3,h.y*=-.2;var p=new THREE.Object3D,g=new THREE.Object3D;p.add(g),p.position.copy(v),g.position.copy(this.camera.position).sub(v),g.rotation.copy(this.camera.rotation),p.rotation.y+=-h.x;var r=this.camera.getWorldDirection(),y=new THREE.Vector3(0,1,0),E=(new THREE.Vector3).crossVectors(y,r),b=g.position.clone();b.y=0,b.normalize();var T=b.dot(g.position.clone().normalize()),P=Math.acos(T);g.position.y<0&&(P=-P);var R=0;R=h.y>0?h.y-Math.max(0,this.minAngle-(P-h.y)):h.y+Math.max(0,P-h.y-this.maxAngle),p.rotateOnAxis(E,-R),p.updateMatrixWorld(),t.position.copy(g.getWorldPosition()),t.quaternion.copy(g.getWorldQuaternion())}var C={type:"proposeTransform",oldPosition:this.camera.position,newPosition:t.position,objections:0};this.dispatchEvent(C),C.objections>0||(this.camera.position.copy(t.position),this.camera.rotation.copy(t.rotation));var w=this.pivotNode.getWorldPosition().applyMatrix4(this.camera.matrixWorldInverse),x=Math.abs(w.z/30),S=this.pivotNode.scale.length();this.pivotNode.scale.multiplyScalar(x/S)}m.set(0,0)},this.reset=function(){d=l.NONE,this.camera.position.copy(this.position0)},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",o,!1),this.domElement.addEventListener("mousewheel",s,!1),this.domElement.addEventListener("DOMMouseScroll",s,!1)},THREE.EarthControls.prototype=Object.create(THREE.EventDispatcher.prototype),LRU.prototype.size=function(){return this.elements},LRU.prototype.contains=function(e){return null==this.items[e.id]},LRU.prototype.touch=function(e){if(e.loaded){var t;null==this.items[e.id]?(t=new LRUItem(e),t.previous=this.last,this.last=t,null!==t.previous&&(t.previous.next=t),this.items[e.id]=t,this.elements++,null===this.first&&(this.first=t),this.numPoints+=e.numPoints):(t=this.items[e.id],null===t.previous?null!==t.next&&(this.first=t.next,
this.first.previous=null,t.previous=this.last,t.next=null,this.last=t,t.previous.next=t):null===t.next||(t.previous.next=t.next,t.next.previous=t.previous,t.previous=this.last,t.next=null,this.last=t,t.previous.next=t))}},LRU.prototype.remove=function(e){var t=this.items[e.id];t&&(1===this.elements?(this.first=null,this.last=null):(t.previous||(this.first=t.next,this.first.previous=null),t.next||(this.last=t.previous,this.last.next=null),t.previous&&t.next&&(t.previous.next=t.next,t.next.previous=t.previous)),delete this.items[e.id],this.elements--,this.numPoints-=e.numPoints)},LRU.prototype.getLRUItem=function(){if(null===this.first)return null;var e=this.first;return e.node},LRU.prototype.toString=function(){for(var e="{ ",t=this.first;null!==t;)e+=t.node.id,null!==t.next&&(e+=", "),t=t.next;return e+="}",e+="("+this.size()+")"},LRU.prototype.freeMemory=function(){if(!(this.elements<=1))for(;this.numPoints>Potree.pointLoadLimit;){var e=this.first,t=e.node;this.disposeDescendants(t)}},LRU.prototype.disposeDescendants=function(e){var t=[];for(t.push(e);t.length>0;){var i=t.pop();i.dispose(),this.remove(i);for(var o in i.children)if(i.children.hasOwnProperty(o)){var n=i.children[o];n.loaded&&t.push(i.children[o])}}},Potree.Annotation=function(e,t){var i=this,o=this;if(Potree.Annotation.counter++,this.scene=e,this.ordinal=t.title||Potree.Annotation.counter,this.title=t.title||"No Title",this.description=t.description||"",this.position=t.position||new THREE.Vector3(0,0,0),this.cameraPosition=t.cameraPosition,this.cameraTarget=t.cameraTarget||this.position,this.view=t.view||null,this.keepOpen=!1,this.descriptionVisible=!1,this.actions=t.actions||null,this.appearance=t.appearance||null,this.domElement=document.createElement("div"),this.domElement.style.position="absolute",this.domElement.style.opacity="0.5",this.domElement.style.padding="10px",this.domElement.style.whiteSpace="nowrap",this.domElement.className="annotation",null!==this.appearance?(this.elOrdinal=document.createElement("div"),this.elOrdinal.style.position="relative",this.elOrdinal.style.zIndex="100",this.elOrdinal.style.width="fit-content",this.elOrdinal.innerHTML=this.appearance,this.domElement.appendChild(this.elOrdinal)):(this.elOrdinal=document.createElement("div"),this.elOrdinal.style.position="relative",this.elOrdinal.style.color="white",this.elOrdinal.style.backgroundColor="black",this.elOrdinal.style.borderRadius="1.5em",this.elOrdinal.style.fontSize="1em",this.elOrdinal.style.opacity="1",this.elOrdinal.style.margin="auto",this.elOrdinal.style.zIndex="100",this.elOrdinal.style.width="fit-content",this.domElement.appendChild(this.elOrdinal),this.elOrdinalText=document.createElement("span"),this.elOrdinalText.style.display="inline-block",this.elOrdinalText.style.verticalAlign="middle",this.elOrdinalText.style.lineHeight="1.5em",this.elOrdinalText.style.textAlign="center",this.elOrdinalText.style.fontFamily="Arial",this.elOrdinalText.style.fontWeight="bold",this.elOrdinalText.style.padding="1px 8px 0px 8px",this.elOrdinalText.style.cursor="default",this.elOrdinalText.innerHTML=this.ordinal,this.elOrdinalText.userSelect="none",this.elOrdinal.appendChild(this.elOrdinalText),this.elOrdinal.onmouseenter=function(){},this.elOrdinal.onmouseleave=function(){},this.elOrdinalText.onclick=function(){o.moveHere(o.scene.camera),o.dispatchEvent({type:"click",target:o})}),this.domDescription=document.createElement("div"),this.domDescription.style.position="relative",this.domDescription.style.color="white",this.domDescription.style.backgroundColor="black",this.domDescription.style.padding="10px",this.domDescription.style.margin="5px 0px 0px 0px",this.domDescription.style.borderRadius="4px",this.domDescription.style.display="none",this.domDescription.className="annotation",this.domElement.appendChild(this.domDescription),null!=this.actions){this.elOrdinalText.style.padding="1px 3px 0px 8px";var n=!0,r=!1,s=void 0;try{for(var a,l=function(){var e=a.value,t=document.createElement("img");t.src=Potree.scriptPath+e.icon,t.style.width="24px",t.style.height="24px",t.style.filter="invert(1)",t.style.display="inline-block",t.style.verticalAlign="middle",t.style.lineHeight="1.5em",t.style.textAlign="center",t.style.fontFamily="Arial",t.style.fontWeight="bold",t.style.padding="1px 3px 0px 3px",t.style.cursor="default",i.elOrdinal.appendChild(t),t.onclick=function(){e.onclick()}},d=this.actions[Symbol.iterator]();!(n=(a=d.next()).done);n=!0)l()}catch(e){r=!0,s=e}finally{try{!n&&d.return&&d.return()}finally{if(r)throw s}}}this.elDescriptionText=document.createElement("span"),this.elDescriptionText.style.color="#ffffff",this.elDescriptionText.innerHTML=this.description,this.domDescription.appendChild(this.elDescriptionText),this.domElement.onmouseenter=function(){o.domElement.style.opacity="0.8",o.domElement.style.zIndex="1000",o.description&&(o.descriptionVisible=!0,o.domDescription.style.display="block")},this.domElement.onmouseleave=function(){o.domElement.style.opacity="0.5",o.domElement.style.zIndex="100",o.descriptionVisible=!0,o.domDescription.style.display="none"},this.moveHere=function(e){var t=800,i=TWEEN.Easing.Quartic.Out,n=new TWEEN.Tween(o.scene.view.position).to(o.cameraPosition,t);n.easing(i),n.start();var r=e.position.distanceTo(o.cameraTarget),s=(new THREE.Vector3).addVectors(e.position,e.getWorldDirection().clone().multiplyScalar(r)),n=new TWEEN.Tween(s).to(o.cameraTarget,t);n.easing(i),n.onUpdate(function(){o.scene.view.target.copy(s)}),n.onComplete(function(){o.scene.view.target.copy(s),o.dispatchEvent({type:"focusing_finished",target:o})}),o.dispatchEvent({type:"focusing_started",target:o}),n.start()},this.dispose=function(){this.domElement.parentElement&&this.domElement.parentElement.removeChild(this.domElement)}},Potree.Annotation.prototype=Object.create(THREE.EventDispatcher.prototype),Potree.Annotation.counter=0,Potree.ProfileData=function(e){this.profile=e,this.segments=[],this.boundingBox=new THREE.Box3,this.projectedBoundingBox=new THREE.Box2;for(var t=new THREE.Vector3,i=0;i<e.points.length-1;i++){var o=e.points[i],n=e.points[i+1],r=new THREE.Vector3(o.x,o.y,0),s=new THREE.Vector3(n.x,n.y,0),a=(new THREE.Vector3).addVectors(s,r).multiplyScalar(.5),l=r.distanceTo(s),d=(new THREE.Vector3).subVectors(s,r).normalize(),c=new THREE.Vector3(0,0,1),u=(new THREE.Vector3).crossVectors(d,c).normalize(),h=u,p=(new THREE.Plane).setFromNormalAndCoplanarPoint(h,r),m=(new THREE.Plane).setFromNormalAndCoplanarPoint(d,a),f=function(e,t,i){var o=e,n=t,r=i,s=new THREE.Vector3(1,0,0),a=(new THREE.Vector3).subVectors(n,o);a.z=0,a.normalize();var l=Math.acos(s.dot(a));return a.y>0&&(l=-l),function(e){var t=(new THREE.Matrix4).makeTranslation(-o.x,-o.y,0),i=(new THREE.Matrix4).makeRotationZ(-l),n=(new THREE.Matrix4).makeTranslation(r.x,0,0),s=e.clone();return s.applyMatrix4(t),s.applyMatrix4(i),s.applyMatrix4(n),s}}(o,n,t.clone()),v={start:o,end:n,cutPlane:p,halfPlane:m,length:l,points:null,project:f};this.segments.push(v),t.x+=l,t.z+=n.z-o.z}this.projectedBoundingBox.min.x=0,this.projectedBoundingBox.min.z=Number.POSITIVE_INFINITY,this.projectedBoundingBox.max.x=t.x,this.projectedBoundingBox.max.z=Number.NEGATIVE_INFINITY,this.size=function(){for(var e=0,t=0;t<this.segments.length;t++)this.segments[t].points&&(e+=this.segments[t].points.numPoints);return e}},Potree.ProfileRequest=function(e,t,i,o){this.pointcloud=e,this.profile=t,this.maxDepth=i||Number.MAX_VALUE,this.callback=o,this.temporaryResult=new Potree.ProfileData(this.profile),this.pointsServed=0,this.priorityQueue=new BinaryHeap(function(e){return 1/e.weight}),this.initialize=function(){this.priorityQueue.push({node:e.pcoGeometry.root,weight:1}),this.traverse(e.pcoGeometry.root)},this.traverse=function(t){for(var i=[],o=0;o<8;o++){var n=t.children[o];n&&e.nodeIntersectsProfile(n,this.profile)&&i.push(n)}for(;i.length>0;){var t=i.pop(),r=t.boundingSphere.radius;if(this.priorityQueue.push({node:t,weight:r}),t.level<this.maxDepth)for(var o=0;o<8;o++){var n=t.children[o];n&&e.nodeIntersectsProfile(n,this.profile)&&i.push(n)}}},this.update=function(){for(var t=[],i=0;i<Math.min(2,this.priorityQueue.size());i++){var n=this.priorityQueue.pop(),r=n.node;r.loaded?(t.push(r),Potree.getLRU().touch(r),r.level%r.pcoGeometry.hierarchyStepSize===0&&r.hasChildren&&this.traverse(r)):(r.load(),this.priorityQueue.push(n))}if(t.length>0&&(this.getPointsInsideProfile(t,this.temporaryResult),this.temporaryResult.size()>100&&(this.pointsServed+=this.temporaryResult.size(),o.onProgress({request:this,points:this.temporaryResult}),this.temporaryResult=new Potree.ProfileData(this.profile))),0===this.priorityQueue.size()){this.temporaryResult.size()>0&&(this.pointsServed+=this.temporaryResult.size(),o.onProgress({request:this,points:this.temporaryResult}),this.temporaryResult=new Potree.ProfileData(this.profile)),o.onFinish({request:this});var s=e.profileRequests.indexOf(this);s>=0&&e.profileRequests.splice(s,1)}},this.getPointsInsideProfile=function(i,o){for(var n=0;n<o.segments.length;n++){for(var r=o.segments[n],s=0;s<i.length;s++){var a=i[s],l=a.geometry,d=l.attributes.position,c=d.array,u=a.numPoints;if(!r.points){r.points={},r.points.boundingBox=new THREE.Box3;for(var h in l.attributes)l.attributes.hasOwnProperty(h)&&("indices"===h||(r.points[h]=[]))}for(var p=0;p<u;p++){var m=new THREE.Vector3(c[3*p],c[3*p+1],c[3*p+2]);m.applyMatrix4(e.matrixWorld);var f=Math.abs(r.cutPlane.distanceToPoint(m)),v=Math.abs(r.halfPlane.distanceToPoint(m));if(f<t.width/2&&v<r.length/2){r.points.boundingBox.expandByPoint(m);for(var h in l.attributes)if(l.attributes.hasOwnProperty(h))if("position"===h)r.points[h].push(m);else if("indices"===h);else{var g=l.attributes[h];if(1===g.itemSize)r.points[h].push(g.array[p]);else{for(var y=[],E=0;E<g.itemSize;E++)y.push(g.array[p*g.itemSize+E]);r.points[h].push(y)}}}else;}}r.points.numPoints=r.points.position.length,r.points.numPoints>0&&(o.boundingBox.expandByPoint(r.points.boundingBox.min),o.boundingBox.expandByPoint(r.points.boundingBox.max),o.projectedBoundingBox.expandByPoint(new THREE.Vector2(0,o.boundingBox.min.y)),o.projectedBoundingBox.expandByPoint(new THREE.Vector2(0,o.boundingBox.max.y)))}},this.cancel=function(){o.onCancel(),this.priorityQueue=new BinaryHeap(function(e){return 1/e.weight});var t=e.profileRequests.indexOf(this);t>=0&&e.profileRequests.splice(t,1)},this.initialize()},Potree.PointCloudOctreeNode=function(){this.children={},this.sceneNode=null,this.octree=null,this.getNumPoints=function(){return this.geometryNode.numPoints},this.isLoaded=function(){return!0},this.isTreeNode=function(){return!0},this.isGeometryNode=function(){return!1},this.getLevel=function(){return this.geometryNode.level},this.getBoundingSphere=function(){return this.geometryNode.boundingSphere},this.getBoundingBox=function(){return this.geometryNode.boundingBox},this.getChildren=function(){for(var e=[],t=0;t<8;t++)this.children[t]&&e.push(this.children[t]);return e}},Potree.PointCloudOctreeNode.prototype=Object.create(Potree.PointCloudTreeNode.prototype),Potree.PointCloudOctree=function(e,t){Potree.PointCloudTree.call(this),this.pcoGeometry=e,this.boundingBox=this.pcoGeometry.tightBoundingBox,this.boundingSphere=this.boundingBox.getBoundingSphere(),this.material=t||new Potree.PointCloudMaterial,this.visiblePointsTarget=2e6,this.minimumNodePixelSize=150,this.level=0,this.position.sub(e.offset),this.updateMatrix(),this.showBoundingBox=!1,this.boundingBoxNodes=[],this.loadQueue=[],this.visibleBounds=new THREE.Box3,this.visibleNodes=[],this.visibleGeometry=[],this.pickTarget=null,this.generateDEM=!1,this.profileRequests=[],this.name="",this.projection=e.projection,this.root=this.pcoGeometry.root},Potree.PointCloudOctree.prototype=Object.create(Potree.PointCloudTree.prototype),Potree.PointCloudOctree.prototype.setName=function(e){this.name!==e&&(this.name=e,this.dispatchEvent({type:"name_changed",name:e,pointcloud:this}))},Potree.PointCloudOctree.prototype.getName=function(){return this.name},Potree.PointCloudOctree.prototype.toTreeNode=function(e,t){var i=new Potree.PointCloudOctreeNode,o=new THREE.Points(e.geometry,this.material);i.geometryNode=e,i.sceneNode=o,i.pointcloud=this,i.children={};for(var n in e.children)i.children[n]=e.children[n];if(t){var r=parseInt(e.name[e.name.length-1]);t.sceneNode.add(o),t.children[r]=i}else this.root=i,this.add(o);var s=function(){var o=parseInt(e.name[e.name.length-1]);t.sceneNode.remove(i.sceneNode),t.children[o]=e};return e.oneTimeDisposeHandlers.push(s),i},Potree.PointCloudOctree.prototype.updateVisibleBounds=function(){for(var e=[],t=0;t<this.visibleNodes.length;t++){for(var i=this.visibleNodes[t],o=!0,n=0;n<i.children.length;n++){var r=i.children[n];r instanceof Potree.PointCloudOctreeNode?o=o&&!r.sceneNode.visible:r instanceof Potree.PointCloudOctreeGeometryNode&&(o=!0)}o&&e.push(i)}this.visibleBounds.min=new THREE.Vector3(1/0,1/0,1/0),this.visibleBounds.max=new THREE.Vector3((-(1/0)),(-(1/0)),(-(1/0)));for(var t=0;t<e.length;t++){var i=e[t];this.visibleBounds.expandByPoint(i.getBoundingBox().min),this.visibleBounds.expandByPoint(i.getBoundingBox().max)}},Potree.PointCloudOctree.prototype.updateMaterial=function(e,t,i,o){e.fov=i.fov*(Math.PI/180),e.screenWidth=o.domElement.clientWidth,e.screenHeight=o.domElement.clientHeight,e.spacing=this.pcoGeometry.spacing,e.near=i.near,e.far=i.far,e.uniforms.octreeSize.value=this.pcoGeometry.boundingBox.getSize().x,e.pointSizeType>=0&&(e.pointSizeType!==Potree.PointSizeType.ADAPTIVE&&e.pointColorType!==Potree.PointColorType.LOD||this.updateVisibilityTexture(e,t))},Potree.PointCloudOctree.prototype.updateVisibilityTexture=function(e,t){if(e){var i=e.visibleNodesTexture,o=i.image.data;t=t.slice();var n=function(e,t){var i=e.geometryNode.name,o=t.geometryNode.name;return i.length!=o.length?i.length-o.length:i<o?-1:i>o?1:0};t.sort(n);for(var r=0;r<t.length;r++){for(var s=t[r],a=[],l=0;l<8;l++){var d=s.children[l];d instanceof Potree.PointCloudOctreeNode&&d.sceneNode.visible&&t.indexOf(d)>=0&&a.push(d)}a.sort(function(e,t){return e.geometryNode.name<t.geometryNode.name?-1:e.geometryNode.name>t.geometryNode.name?1:0}),o[3*r+0]=0,o[3*r+1]=0,o[3*r+2]=0;for(var l=0;l<a.length;l++){var d=a[l],c=parseInt(d.geometryNode.name.substr(-1));if(o[3*r+0]+=Math.pow(2,c),0===l){var u=t.indexOf(d);o[3*r+1]=u-r}}}i.needsUpdate=!0}},Potree.PointCloudOctree.prototype.nodeIntersectsProfile=function(e,t){for(var i=e.boundingBox.clone().applyMatrix4(this.matrixWorld),o=i.getBoundingSphere(),n=0;n<t.points.length-1;n++){var r=new THREE.Vector3(t.points[n].x,o.center.y,t.points[n].z),s=new THREE.Vector3(t.points[n+1].x,o.center.y,t.points[n+1].z),a=new THREE.Ray(r,(new THREE.Vector3).subVectors(s,r).normalize()),l=new THREE.Ray(s,(new THREE.Vector3).subVectors(r,s).normalize());if(a.intersectsSphere(o)&&l.intersectsSphere(o))return!0}return!1},Potree.PointCloudOctree.prototype.nodesOnRay=function(e,t){for(var i=[],o=t.clone(),n=0;n<e.length;n++){var r=e[n],s=r.getBoundingSphere().clone().applyMatrix4(r.sceneNode.matrixWorld);o.intersectsSphere(s)&&i.push(r)}return i},Potree.PointCloudOctree.prototype.updateMatrixWorld=function(e){this.matrixAutoUpdate===!0&&this.updateMatrix(),this.matrixWorldNeedsUpdate!==!0&&e!==!0||(void 0===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0)},Potree.PointCloudOctree.prototype.hideDescendants=function(e){for(var t=[],i=0;i<e.children.length;i++){var o=e.children[i];o.visible&&t.push(o)}for(;t.length>0;){var e=t.shift();e.visible=!1;for(var i=0;i<e.children.length;i++){var o=e.children[i];o.visible&&t.push(o)}}},Potree.PointCloudOctree.prototype.moveToOrigin=function(){this.position.set(0,0,0),this.updateMatrixWorld(!0);var e=this.boundingBox,t=this.matrixWorld,i=Potree.utils.computeTransformedBoundingBox(e,t);this.position.set(0,0,0).sub(i.getCenter())},Potree.PointCloudOctree.prototype.moveToGroundPlane=function(){this.updateMatrixWorld(!0);var e=this.boundingBox,t=this.matrixWorld,i=Potree.utils.computeTransformedBoundingBox(e,t);this.position.y+=-i.min.y},Potree.PointCloudOctree.prototype.getBoundingBoxWorld=function(){this.updateMatrixWorld(!0);var e=this.boundingBox,t=this.matrixWorld,i=Potree.utils.computeTransformedBoundingBox(e,t);return i},Potree.PointCloudOctree.prototype.getPointsInProfile=function(e,t,i){if(i){var o=new Potree.ProfileRequest(this,e,t,i);return this.profileRequests.push(o),o}for(var n={segments:[],boundingBox:new THREE.Box3,projectedBoundingBox:new THREE.Box2},r=0;r<e.points.length-1;r++){var s=e.points[r],a=e.points[r+1],l=this.getProfile(s,a,e.width,t),d={start:s,end:a,points:l,project:null};n.segments.push(d),n.boundingBox.expandByPoint(l.boundingBox.min),n.boundingBox.expandByPoint(l.boundingBox.max)}for(var c=new THREE.Vector3,r=0;r<n.segments.length;r++){var d=n.segments[r],s=d.start,a=d.end,u=function(e,t,i,o){var n=e,r=t,s=i,a=o,l=new THREE.Vector3(1,0,0),d=(new THREE.Vector3).subVectors(r,n);d.y=0,d.normalize();var c=Math.acos(l.dot(d));return d.z>0&&(c=-c),function(e){var t=(new THREE.Matrix4).makeTranslation(-n.x,-a.min.y,-n.z),i=(new THREE.Matrix4).makeRotationY(-c),o=(new THREE.Matrix4).makeTranslation(s.x,0,0),r=e.clone();return r.applyMatrix4(t),r.applyMatrix4(i),r.applyMatrix4(o),r}}(s,a,c.clone(),n.boundingBox.clone());d.project=u,c.x+=new THREE.Vector3(s.x,0,s.z).distanceTo(new THREE.Vector3(a.x,0,a.z)),c.y+=a.y-s.y}return n.projectedBoundingBox.min.x=0,n.projectedBoundingBox.min.y=n.boundingBox.min.y,n.projectedBoundingBox.max.x=c.x,n.projectedBoundingBox.max.y=n.boundingBox.max.y,n},Potree.PointCloudOctree.prototype.getProfile=function(e,t,i,o,n){if(void 0===n){var r=[];r.push(this);for(var s=(new THREE.Vector3).addVectors(t,e).multiplyScalar(.5),a=(new THREE.Vector3).subVectors(t,e).length(),l=(new THREE.Vector3).subVectors(t,e).normalize(),d=new THREE.Vector3(0,1,0),c=(new THREE.Vector3).crossVectors(l,d).normalize(),u=c,h=(new THREE.Plane).setFromNormalAndCoplanarPoint(u,e),p=(new THREE.Plane).setFromNormalAndCoplanarPoint(l,s),m=null,f=new THREE.Box3;r.length>0;){var v=r.shift(),g=0;if(v instanceof THREE.Points){var y=v.geometry,E=y.attributes.position,b=E.array,T=v.numPoints;if(!m){m={};for(var P in y.attributes)y.attributes.hasOwnProperty(P)&&("indices"===P||(m[P]=[]))}for(var R=0;R<T;R++){var C=new THREE.Vector3(b[3*R],b[3*R+1],b[3*R+2]);C.applyMatrix4(this.matrixWorld);var w=Math.abs(h.distanceToPoint(C)),x=Math.abs(p.distanceToPoint(C));if(w<i/2&&x<a/2){f.expandByPoint(C);for(var P in y.attributes)if(y.attributes.hasOwnProperty(P))if("position"===P)m[P].push(C);else if("indices"===P);else{var S=y.attributes[P];if(1===S.itemSize)m[P].push(S.array[R+B]);else{for(var H=[],B=0;B<S.itemSize;B++)H.push(S.array[R*S.itemSize+B]);m[P].push(H)}}g++}}}if(v==this||v.level<o)for(var R=0;R<v.children.length;R++){var V=v.children[R];if(V instanceof THREE.Points){var I=V.boundingSphere.clone().applyMatrix4(V.matrixWorld);h.distanceToSphere(I)<I.radius&&r.push(V)}}}m.numPoints=m.position.length;var A=function(e,t){var i=e,o=t,n=new THREE.Vector3(1,0,0),r=(new THREE.Vector3).subVectors(o,i);r.y=0,r.normalize();var s=Math.acos(n.dot(r));return r.z>0&&(s=-s),function(e){var t=(new THREE.Matrix4).makeTranslation(-i.x,-i.y,-i.z),o=(new THREE.Matrix4).makeRotationY(-s),n=e.clone();return n.applyMatrix4(t),n.applyMatrix4(o),n}}(e,t);return m.project=A,m.boundingBox=f,m}var M=new Potree.ProfileRequest(e,t,i,o,n);this.profileRequests.push(M)},Potree.PointCloudOctree.prototype.getVisibleExtent=function(){return this.visibleBounds.applyMatrix4(this.matrixWorld)},Potree.PointCloudOctree.prototype.pick=function(e,t,i,o){var n=e.context,r=function(e){void 0===e._glstate&&(e._glstate={});var t=e._glstate,i=n.createShader(n.VERTEX_SHADER);n.shaderSource(i,e.vertexShader),n.compileShader(i);var o=n.getShaderParameter(i,n.COMPILE_STATUS);if(!o){console.error("could not compile vertex shader:");var r=n.getShaderInfoLog(i);return void console.error(r,e.vertexShader)}var s=n.createShader(n.FRAGMENT_SHADER);n.shaderSource(s,e.fragmentShader),n.compileShader(s);var a=n.getShaderParameter(s,n.COMPILE_STATUS);if(!a)return console.error("could not compile fragment shader:"),void console.error(e.fragmentShader);var l=n.createProgram();n.attachShader(l,i),n.attachShader(l,s),n.linkProgram(l);var d=n.getProgramParameter(l,n.LINK_STATUS);if(!d)return console.error("could not compile shader:"),console.error(e.vertexShader),void console.error(e.fragmentShader);t.program=l,n.useProgram(l);for(var c={},u=n.getProgramParameter(l,n.ACTIVE_UNIFORMS),h=0;h<u;h++){var p=n.getActiveUniform(l,h),m=p.name,f=n.getUniformLocation(l,m);c[m]=f}t.uniforms=c,t.textures={}};void 0===Potree.PointCloudOctree.pickMaterial&&(Potree.PointCloudOctree.pickMaterial=new Potree.PointCloudMaterial,Potree.PointCloudOctree.pickMaterial.pointColorType=Potree.PointColorType.POINT_INDEX,r(Potree.PointCloudOctree.pickMaterial));var s=Potree.PointCloudOctree.pickMaterial,o=o||{},a=o.pickWindowSize||17,l=o.pickOutsideClipRegion||!1,d=this.nodesOnRay(this.visibleNodes,i);if(0===d.length)return null;var c=!1;s.pointSizeType!==this.material.pointSizeType&&(s.pointSizeType=this.material.pointSizeType,c=!0),s.pointShape!==this.material.pointShape&&(s.pointShape=this.material.pointShape,c=!0),s.interpolate!==this.material.interpolate&&(s.interpolate=this.material.interpolate,c=!0),s.size=this.material.size,s.minSize=this.material.minSize,s.maxSize=this.material.maxSize,s.classification=this.material.classification,l?s.clipMode=Potree.ClipMode.DISABLED:(s.clipMode=this.material.clipMode,this.material.clipMode===Potree.ClipMode.CLIP_OUTSIDE?s.setClipBoxes(this.material.clipBoxes):s.setClipBoxes([])),this.updateMaterial(s,d,t,e),c&&r(s);var u=Math.ceil(e.domElement.clientWidth),h=Math.ceil(e.domElement.clientHeight),p=(new THREE.Vector3).addVectors(t.position,i.direction).project(t);p.addScalar(1).multiplyScalar(.5),p.x*=u,p.y*=h,this.pickTarget?this.pickTarget.width==u&&this.pickTarget.height==h||(this.pickTarget.dispose(),this.pickTarget=new THREE.WebGLRenderTarget(1,1,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat})):this.pickTarget=new THREE.WebGLRenderTarget(1,1,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),this.pickTarget.setSize(u,h),n.enable(n.SCISSOR_TEST),n.scissor(p.x-(a-1)/2,p.y-(a-1)/2,a,a),n.disable(n.SCISSOR_TEST),e.setRenderTarget(this.pickTarget),e.state.setDepthTest(s.depthTest),e.state.setDepthWrite(s.depthWrite),e.state.setBlending(THREE.NoBlending),e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil);var m=s._glstate,f=m.program,v=m.uniforms;if(n.useProgram(f),n.uniformMatrix4fv(v.projectionMatrix,!1,new Float32Array(t.projectionMatrix.elements)),n.uniformMatrix4fv(v.viewMatrix,!1,new Float32Array(t.matrixWorldInverse.elements)),void 0===m.textures.visibleNodes){var g=s.visibleNodesTexture.image,y=n.createTexture();n.bindTexture(n.TEXTURE_2D,y),n.texImage2D(n.TEXTURE_2D,0,n.RGB,g.width,g.height,0,n.RGB,n.UNSIGNED_BYTE,g.data),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.bindTexture(n.TEXTURE_2D,null),m.textures.visibleNodes={id:y}}var E=m.textures.visibleNodes.id,b=s.visibleNodesTexture.image;n.uniform1i(v.visibleNodes,0),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,E),n.texImage2D(n.TEXTURE_2D,0,n.RGB,b.width,b.height,0,n.RGB,n.UNSIGNED_BYTE,b.data),n.uniform1f(v.fov,this.material.fov),n.uniform1f(v.screenWidth,this.material.screenWidth),n.uniform1f(v.screenHeight,this.material.screenHeight),n.uniform1f(v.spacing,this.material.spacing),n.uniform1f(v.near,this.material.near),n.uniform1f(v.far,this.material.far),n.uniform1f(v.size,this.material.size),n.uniform1f(v.minSize,this.material.minSize),n.uniform1f(v.maxSize,this.material.maxSize),n.uniform1f(v.octreeSize,this.pcoGeometry.boundingBox.getSize().x);var T=n.getAttribLocation(f,"position"),P=n.getAttribLocation(f,"normal"),R=n.getAttribLocation(f,"classification"),C=n.getAttribLocation(f,"indices");n.enableVertexAttribArray(T),n.enableVertexAttribArray(P),n.enableVertexAttribArray(R),n.enableVertexAttribArray(C);for(var w=0;w<d.length;w++){var x=d[w],S=x.sceneNode,H=S.geometry;s.pcIndex=w+1;var B=(new THREE.Matrix4).multiplyMatrices(t.matrixWorldInverse,S.matrixWorld);n.uniformMatrix4fv(v.modelMatrix,!1,new Float32Array(S.matrixWorld.elements)),n.uniformMatrix4fv(v.modelViewMatrix,!1,new Float32Array(B.elements));var V=n.getAttribLocation(f,"position"),I=n.getAttribLocation(f,"normal"),A=n.getAttribLocation(f,"classification"),M=n.getAttribLocation(f,"indices"),k=e.properties.get(H.attributes.position).__webglBuffer;if(void 0!==k){n.bindBuffer(n.ARRAY_BUFFER,k),n.vertexAttribPointer(V,3,n.FLOAT,!1,0,0);var W=e.properties.get(H.attributes.normal).__webglBuffer;n.bindBuffer(n.ARRAY_BUFFER,W),n.vertexAttribPointer(I,3,n.FLOAT,!0,0,0);var G=e.properties.get(H.attributes.classification).__webglBuffer;n.bindBuffer(n.ARRAY_BUFFER,G),n.vertexAttribPointer(A,1,n.UNSIGNED_BYTE,!1,0,0);var N=e.properties.get(H.attributes.indices).__webglBuffer;n.bindBuffer(n.ARRAY_BUFFER,N),n.vertexAttribPointer(M,4,n.UNSIGNED_BYTE,!0,0,0),n.uniform1f(v.pcIndex,s.pcIndex);var L=x.getNumPoints();L>0&&n.drawArrays(n.POINTS,0,x.getNumPoints())}}var D=a*a,O=new ArrayBuffer(4*D),X=new Uint8Array(O),J=new Uint32Array(O);e.context.readPixels(p.x-(a-1)/2,p.y-(a-1)/2,a,a,e.context.RGBA,e.context.UNSIGNED_BYTE,X);for(var _=Number.MAX_VALUE,U=null,Z=0;Z<a;Z++)for(var z=0;z<a;z++){var F=Z+z*a,Q=Math.pow(Z-(a-1)/2,2)+Math.pow(z-(a-1)/2,2),Y=X[4*F+3];X[4*F+3]=0;var K=J[F];(0!==K||0!==Y)&&Q<_&&(U={pIndex:K,pcIndex:Y-1},_=Q)}if(U){var j={},q=d[U.pcIndex].sceneNode,$=q.geometry.attributes;for(var ee in $)if($.hasOwnProperty(ee)){var te=q.geometry.attributes[ee];if("position"===ee){var ie=te.array,oe=ie[3*U.pIndex+0],ne=ie[3*U.pIndex+1],re=ie[3*U.pIndex+2],se=new THREE.Vector3(oe,ne,re);se.applyMatrix4(this.matrixWorld),j[ee]=se}else if("indices"===ee);else if(1===te.itemSize)j[ee]=te.array[U.pIndex];else{for(var ae=[],le=0;le<te.itemSize;le++)ae.push(te.array[te.itemSize*U.pIndex+le]);j[ee]=ae}}return j}return null};var demTime=0;Potree.PointCloudOctree.prototype.createDEM=function(e){for(var t=(new Date).getTime(),i=e.sceneNode,o=i.matrixWorld,n=i.boundingBox.clone().applyMatrix4(o),r=n.getSize(),s=i.geometry.attributes.position.array,a=64,l=new Array(a*a),d=new Float32Array(a*a),c=s.length/3,u=0;u<c;u++){var h=s[3*u+0],p=s[3*u+1],m=s[3*u+2],f=new THREE.Vector3(h,p,m).applyMatrix4(o),v=parseInt(a*(f.x-n.min.x)/r.x),g=parseInt(a*(f.z-n.min.z)/r.z);v=Math.min(v,a-1),g=Math.min(g,a-1);var y=v+g*a;l[y]||(l[y]=[]),l[y].push(f.y)}for(var u=0;u<l.length;u++){var E=l[u];if(E)if(0===E.length)d[u]=0;else{var b=parseInt((E.length-1)/2);d[u]=E[b]}else d[u]=0}var T=new THREE.Box2;T.expandByPoint(new THREE.Vector3(n.min.x,n.min.z)),T.expandByPoint(new THREE.Vector3(n.max.x,n.max.z));var P={boundingBox:n,boundingBox2D:T,dem:d,demSize:a},R=(new Date).getTime(),C=R-t;return demTime+=C,P},Potree.PointCloudOctree.prototype.getDEMHeight=function(e){var t=new THREE.Vector2(e.x,e.z),i=function e(i){var o=i.demSize,n=i.boundingBox2D;n.containsPoint(t);if(n.containsPoint(t)){var r=t.clone().sub(n.min).divide(n.getSize()),s=r.clone().multiplyScalar(o),e=0;if(s.x>.5&&s.x<o-.5&&s.y>.5&&s.y<o-.5){var a=Math.floor(s.x-.5),l=Math.floor(s.y-.5);a=a===o-1?o-2:a,l=l===o-1?o-2:l;var d=s.x-a-.5,c=s.y-l-.5,u=a+l*o,h=a+1+l*o,p=a+(l+1)*o,m=a+1+(l+1)*o,f=i.dem[u],v=i.dem[h],g=i.dem[p],y=i.dem[m];if(0===f||0===v||0===g||0===y)e=null;else{var E=f*(1-d)+v*d,b=g*(1-d)+y*d;e=E*(1-c)+b*c}}else{s.x=Math.min(parseInt(Math.min(s.x,o)),o-1),s.y=Math.min(parseInt(Math.min(s.y,o)),o-1);var T=s.x+s.y*o;e=i.dem[T]}return e}return null},o=null,n=[];for(this.root.dem&&n.push(this.root);n.length>0;){var r=n.shift(),s=r.dem,a=(s.demSize,s.boundingBox2D),l=a.containsPoint(t);if(l){var d=i(s);if(o?null!=d&&d>0&&(o=d):o=d,r.level<=6)for(var c=0;c<8;c++){var u=r.children[c];"undefined"!=typeof u&&"undefined"!=typeof u.dem&&n.push(u)}}}return o},Object.defineProperty(Potree.PointCloudOctree.prototype,"progress",{get:function(){return this.visibleNodes.length/this.visibleGeometry.length}});var nodesLoadTimes={};Potree.PointCloudOctreeGeometry=function(){this.url=null,this.octreeDir=null,this.spacing=0,this.boundingBox=null,this.root=null,this.numNodesLoading=0,this.nodes=null,this.pointAttributes=null,this.hierarchyStepSize=-1,this.loader=null},Potree.PointCloudOctreeGeometryNode=function(e,t,i){this.id=Potree.PointCloudOctreeGeometryNode.IDCount++,this.name=e,this.index=parseInt(e.charAt(e.length-1)),this.pcoGeometry=t,this.geometry=null,this.boundingBox=i,this.boundingSphere=i.getBoundingSphere(),this.children={},this.numPoints=0,this.level=null,this.loaded=!1,this.oneTimeDisposeHandlers=[]},Potree.PointCloudOctreeGeometryNode.IDCount=0,Potree.PointCloudOctreeGeometryNode.prototype=Object.create(Potree.PointCloudTreeNode.prototype),Potree.PointCloudOctreeGeometryNode.prototype.isGeometryNode=function(){return!0},Potree.PointCloudOctreeGeometryNode.prototype.getLevel=function(){return this.level},Potree.PointCloudOctreeGeometryNode.prototype.isTreeNode=function(){return!1},Potree.PointCloudOctreeGeometryNode.prototype.isLoaded=function(){return this.loaded},Potree.PointCloudOctreeGeometryNode.prototype.getBoundingSphere=function(){return this.boundingSphere},Potree.PointCloudOctreeGeometryNode.prototype.getBoundingBox=function(){return this.boundingBox},Potree.PointCloudOctreeGeometryNode.prototype.getChildren=function(){for(var e=[],t=0;t<8;t++)this.children[t]&&e.push(this.children[t]);return e},Potree.PointCloudOctreeGeometryNode.prototype.getBoundingBox=function(){return this.boundingBox},Potree.PointCloudOctreeGeometryNode.prototype.getURL=function(){var e="",t=this.pcoGeometry.loader.version;return t.equalOrHigher("1.5")?e=this.pcoGeometry.octreeDir+"/"+this.getHierarchyPath()+"/"+this.name:t.equalOrHigher("1.4")?e=this.pcoGeometry.octreeDir+"/"+this.name:t.upTo("1.3")&&(e=this.pcoGeometry.octreeDir+"/"+this.name),e},Potree.PointCloudOctreeGeometryNode.prototype.getHierarchyPath=function(){for(var e="r/",t=this.pcoGeometry.hierarchyStepSize,i=this.name.substr(1),o=Math.floor(i.length/t),n=0;n<o;n++)e+=i.substr(n*t,t)+"/";return e=e.slice(0,-1)},Potree.PointCloudOctreeGeometryNode.prototype.addChild=function(e){this.children[e.index]=e,e.parent=this},Potree.PointCloudOctreeGeometryNode.prototype.load=function(){this.loading===!0||this.loaded===!0||this.pcoGeometry.numNodesLoading>3||(this.loading=!0,this.pcoGeometry.numNodesLoading++,this.pcoGeometry.loader.version.equalOrHigher("1.5")&&this.level%this.pcoGeometry.hierarchyStepSize===0&&this.hasChildren?this.loadHierachyThenPoints():this.loadPoints())},Potree.PointCloudOctreeGeometryNode.prototype.loadPoints=function(){this.pcoGeometry.loader.load(this)},Potree.PointCloudOctreeGeometryNode.prototype.loadHierachyThenPoints=function(){var e=this,t=function(e,t){var i=(t.byteLength/5,new DataView(t)),o=[],n=i.getUint8(0),r=i.getUint32(1,!0);e.numPoints=r,o.push({children:n,numPoints:r,name:e.name});for(var s=[],a=5;o.length>0;){for(var l=o.shift(),d=1,c=0;c<8;c++){if(0!==(l.children&d)){var u=l.name+c,h=i.getUint8(a),p=i.getUint32(a+1,!0);o.push({children:h,numPoints:p,name:u}),s.push({children:h,numPoints:p,name:u}),a+=5}d=2*d}if(a===t.byteLength)break}var m={};m[e.name]=e;for(var f=e.pcoGeometry,c=0;c<s.length;c++){var v=s[c].name,r=s[c].numPoints,g=parseInt(v.charAt(v.length-1)),y=v.substring(0,v.length-1),E=m[y],b=v.length-1,T=Potree.POCLoader.createChildAABB(E.boundingBox,g),P=new Potree.PointCloudOctreeGeometryNode(v,f,T);P.level=b,P.numPoints=r,P.hasChildren=s[c].children>0,E.addChild(P),m[v]=P}e.loadPoints()};
if(e.level%e.pcoGeometry.hierarchyStepSize===0){var i=e.pcoGeometry.octreeDir+"/"+e.getHierarchyPath()+"/"+e.name+".hrc",o=new XMLHttpRequest;o.open("GET",i,!0),o.responseType="arraybuffer",o.overrideMimeType("text/plain; charset=x-user-defined"),o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status||0===o.status){var i=o.response;t(e,i)}else console.log("Failed to load file! HTTP status: "+o.status+", file: "+url)};try{o.send(null)}catch(e){console.log("fehler beim laden der punktwolke: "+e)}}},Potree.PointCloudOctreeGeometryNode.prototype.getNumPoints=function(){return this.numPoints},Potree.PointCloudOctreeGeometryNode.prototype.dispose=function(){if(this.geometry&&null!=this.parent){this.geometry.dispose(),this.geometry=null,this.loaded=!1;for(var e=0;e<this.oneTimeDisposeHandlers.length;e++){var t=this.oneTimeDisposeHandlers[e];t()}this.oneTimeDisposeHandlers=[]}},Object.assign(Potree.PointCloudOctreeGeometryNode.prototype,THREE.EventDispatcher.prototype);var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,i,o){return i&&e(t.prototype,i),o&&e(t,o),t}}();Potree.utils=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"toString",value:function(e){return e instanceof THREE.Vector3?e.x.toFixed(2)+", "+e.y.toFixed(2)+", "+e.z.toFixed(2):""+e}},{key:"normalizeURL",value:function(e){var t=new URL(e);return t.protocol+"//"+t.hostname+t.pathname.replace(/\/+/g,"/")}},{key:"pathExists",value:function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),200===t.status}},{key:"computeTransformedBoundingBox",value:function(e,t){var i=[new THREE.Vector3(e.min.x,e.min.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.min.x,e.min.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.max.x,e.min.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.min.x,e.max.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.min.x,e.min.y,e.max.z).applyMatrix4(t),new THREE.Vector3(e.min.x,e.max.y,e.max.z).applyMatrix4(t),new THREE.Vector3(e.max.x,e.max.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.max.x,e.min.y,e.max.z).applyMatrix4(t),new THREE.Vector3(e.max.x,e.max.y,e.max.z).applyMatrix4(t)],o=new THREE.Box3;return o.setFromPoints(i),o}},{key:"addCommas",value:function(e){e+="";for(var t=e.split("."),i=t[0],o=t.length>1?"."+t[1]:"",n=/(\d+)(\d{3})/;n.test(i);)i=i.replace(n,"$1,$2");return i+o}},{key:"createWorker",value:function(e){var t=new Blob([e],{type:"application/javascript"}),i=new Worker(URL.createObjectURL(t));return i}},{key:"loadSkybox",value:function(e){var t=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1e5),i=new THREE.Scene,o=".jpg",n=[e+"px"+o,e+"nx"+o,e+"py"+o,e+"ny"+o,e+"pz"+o,e+"nz"+o],r=THREE.ImageUtils.loadTextureCube(n,THREE.CubeRefractionMapping),s={uniforms:{tCube:{type:"t",value:r},tFlip:{type:"f",value:-1}},vertexShader:THREE.ShaderLib.cube.vertexShader,fragmentShader:THREE.ShaderLib.cube.fragmentShader},a=new THREE.ShaderMaterial({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:s.uniforms,depthWrite:!1,side:THREE.BackSide}),l=new THREE.Mesh(new THREE.BoxGeometry(100,100,100),a);return i.add(l),{camera:t,scene:i}}},{key:"createGrid",value:function(e,t,i,o){for(var n=new THREE.LineBasicMaterial({color:o||8947848}),r=new THREE.Geometry,s=0;s<=t;s++)r.vertices.push(new THREE.Vector3(-(i*e)/2,s*i-i*t/2,0)),r.vertices.push(new THREE.Vector3(+(i*e)/2,s*i-i*t/2,0));for(var a=0;a<=e;a++)r.vertices.push(new THREE.Vector3(a*i-i*e/2,-(i*t)/2,0)),r.vertices.push(new THREE.Vector3(a*i-i*e/2,+(i*t)/2,0));var l=new THREE.Line(r,n,THREE.LinePieces);return l.receiveShadow=!0,l}},{key:"createBackgroundTexture",value:function(e,t){function i(e,t){return 1/(2*Math.PI)*Math.exp(-(e*e+t*t)/2)}for(var o=e*t,n=new Uint8Array(3*o),r=[1,1.5,1.7],s=i(0,0),a=0;a<e;a++)for(var l=0;l<t;l++){var d=2*(a/e)-1,c=2*(l/t)-1,u=a+e*l,h=i(2*d,2*c)/s,p=(Math.random()+Math.random()+Math.random())/3;p=(.5*h+.5)*p*.03,p=.4*p,n[3*u+0]=255*(h/15+.05+p)*r[0],n[3*u+1]=255*(h/15+.05+p)*r[1],n[3*u+2]=255*(h/15+.05+p)*r[2]}var m=new THREE.DataTexture(n,e,t,THREE.RGBFormat);return m.needsUpdate=!0,m}},{key:"getMousePointCloudIntersection",value:function(e,t,i,o){var n=new THREE.Vector3(e.x,e.y,.5);n.unproject(t);for(var r=n.sub(t.position).normalize(),s=new THREE.Ray(t.position,r),a=null,l=null,d=0;d<o.length;d++){var c=o[d],u=c.pick(i,t,s);if(u){var h=t.position.distanceTo(u.position);(!a||h<l)&&(a=u,l=h)}}return a?a.position:null}},{key:"pixelsArrayToImage",value:function(e,t,i){var o=document.createElement("canvas");o.width=t,o.height=i;var n=o.getContext("2d");e=new e.constructor(e);for(var r=0;r<e.length;r++)e[4*r+3]=255;var s=n.createImageData(t,i);s.data.set(e),n.putImageData(s,0,0);var a=new Image;return a.src=o.toDataURL(),a}},{key:"projectedRadius",value:function(e,t,i,o){var n=1/Math.tan(t/2)/i;return n=n*o/2,e*n}},{key:"topView",value:function(e,t){e.position.set(0,1,0),e.rotation.set(-Math.PI/2,0,0),e.zoomTo(t,1)}},{key:"frontView",value:function(e,t){e.position.set(0,0,1),e.rotation.set(0,0,0),e.zoomTo(t,1)}},{key:"leftView",value:function(e,t){e.position.set(-1,0,0),e.rotation.set(0,-Math.PI/2,0),e.zoomTo(t,1)}},{key:"rightView",value:function(e,t){e.position.set(1,0,0),e.rotation.set(0,Math.PI/2,0),e.zoomTo(t,1)}},{key:"frustumSphereIntersection",value:function(e,t){for(var i=e.planes,o=t.center,n=-t.radius,r=Number.MAX_VALUE,s=0;s<6;s++){var a=i[s].distanceToPoint(o);if(a<n)return 0;r=Math.min(r,a)}return r>=t.radius?2:1}},{key:"generateDataTexture",value:function(e,t,i){for(var o=e*t,n=new Uint8Array(3*e*t),r=Math.floor(255*i.r),s=Math.floor(255*i.g),a=Math.floor(255*i.b),l=0;l<o;l++)n[3*l]=r,n[3*l+1]=s,n[3*l+2]=a;var d=new THREE.DataTexture(n,e,t,THREE.RGBFormat);return d.needsUpdate=!0,d.magFilter=THREE.NearestFilter,d}},{key:"getParameterByName",value:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),i=t.exec(location.search);return null===i?null:decodeURIComponent(i[1].replace(/\+/g," "))}}]),e}(),Potree.utils.screenPass=new function(){this.screenScene=new THREE.Scene,this.screenQuad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2,0)),this.screenQuad.material.depthTest=!0,this.screenQuad.material.depthWrite=!0,this.screenQuad.material.transparent=!0,this.screenScene.add(this.screenQuad),this.camera=new THREE.Camera,this.render=function(e,t,i){this.screenQuad.material=t,"undefined"==typeof i?e.render(this.screenScene,this.camera):e.render(this.screenScene,this.camera,i)}},Potree.Features=function(){var e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(null===t)return null;var i,o=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),n=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),r=(t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.LOW_FLOAT),t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT)),s=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),a=(t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.LOW_FLOAT),o.precision>0&&r.precision>0),l=n.precision>0&&s.precision>0;return i=a?"highp":l?"mediump":"lowp",{SHADER_INTERPOLATION:{isSupported:function(){var e=!0;return e=e&&t.getExtension("EXT_frag_depth"),e=e&&t.getParameter(t.MAX_VARYING_VECTORS)>=8}},SHADER_SPLATS:{isSupported:function(){var e=!0;return e=e&&t.getExtension("EXT_frag_depth"),e=e&&t.getExtension("OES_texture_float"),e=e&&t.getParameter(t.MAX_VARYING_VECTORS)>=8}},SHADER_EDL:{isSupported:function(){var e=!0;return e=e&&t.getExtension("EXT_frag_depth"),e=e&&t.getExtension("OES_texture_float"),e=e&&t.getParameter(t.MAX_VARYING_VECTORS)>=8}},precision:i}}(),Potree.TextSprite=function(e){THREE.Object3D.call(this);var t=new THREE.Texture;t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter;var i=new THREE.SpriteMaterial({map:t,depthTest:!1,depthWrite:!1});this.material=i,this.sprite=new THREE.Sprite(i),this.add(this.sprite),this.borderThickness=4,this.fontface="Arial",this.fontsize=28,this.borderColor={r:0,g:0,b:0,a:1},this.backgroundColor={r:255,g:255,b:255,a:1},this.textColor={r:255,g:255,b:255,a:1},this.text="",this.setText(e)},Potree.TextSprite.prototype=new THREE.Object3D,Potree.TextSprite.prototype.setText=function(e){this.text!==e&&(this.text=e,this.update())},Potree.TextSprite.prototype.setTextColor=function(e){this.textColor=e,this.update()},Potree.TextSprite.prototype.setBorderColor=function(e){this.borderColor=e,this.update()},Potree.TextSprite.prototype.setBackgroundColor=function(e){this.backgroundColor=e,this.update()},Potree.TextSprite.prototype.update=function(){var e=document.createElement("canvas"),t=e.getContext("2d");t.font="Bold "+this.fontsize+"px "+this.fontface;var i=t.measureText(this.text),o=i.width,n=5,r=2*n+o+2*this.borderThickness,s=1.4*this.fontsize+2*this.borderThickness,e=document.createElement("canvas"),t=e.getContext("2d");t.canvas.width=r,t.canvas.height=s,t.font="Bold "+this.fontsize+"px "+this.fontface,t.fillStyle="rgba("+this.backgroundColor.r+","+this.backgroundColor.g+","+this.backgroundColor.b+","+this.backgroundColor.a+")",t.strokeStyle="rgba("+this.borderColor.r+","+this.borderColor.g+","+this.borderColor.b+","+this.borderColor.a+")",t.lineWidth=this.borderThickness,this.roundRect(t,this.borderThickness/2,this.borderThickness/2,o+this.borderThickness+2*n,1.4*this.fontsize+this.borderThickness,6),t.strokeStyle="rgba(0, 0, 0, 1.0)",t.strokeText(this.text,this.borderThickness+n,this.fontsize+this.borderThickness),t.fillStyle="rgba("+this.textColor.r+","+this.textColor.g+","+this.textColor.b+","+this.textColor.a+")",t.fillText(this.text,this.borderThickness+n,this.fontsize+this.borderThickness);var a=new THREE.Texture(e);a.minFilter=THREE.LinearFilter,a.magFilter=THREE.LinearFilter,a.needsUpdate=!0,this.sprite.material.map=a,this.sprite.scale.set(.01*r,.01*s,1)},Potree.TextSprite.prototype.roundRect=function(e,t,i,o,n,r){e.beginPath(),e.moveTo(t+r,i),e.lineTo(t+o-r,i),e.quadraticCurveTo(t+o,i,t+o,i+r),e.lineTo(t+o,i+n-r),e.quadraticCurveTo(t+o,i+n,t+o-r,i+n),e.lineTo(t+r,i+n),e.quadraticCurveTo(t,i+n,t,i+n-r),e.lineTo(t,i+r),e.quadraticCurveTo(t,i,t+r,i),e.closePath(),e.fill(),e.stroke()};var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,i,o){return i&&e(t.prototype,i),o&&e(t,o),t}}();Potree.AnimationPath=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];_classCallCheck(this,e),this.points=t,this.spline=new THREE.Spline(t),this.spline.reparametrizeByArcLength(1/this.spline.getLength().total),this.tween=null}return _createClass(e,[{key:"get",value:function(e){return this.spline.getPoint(e)}},{key:"animate",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;stop();var i=this.spline.getLength().total,o=1e3*i/t,n={t:0};this.tween=new TWEEN.Tween(n).to({t:1},o),this.tween.easing(TWEEN.Easing.Linear.None),this.tween.onUpdate(function(t){viewer.scene.view.position.copy(e.spline.getPoint(n.t))}),this.tween.start()}},{key:"stop",value:function(){this.tween&&this.tween.stop()}},{key:"resume",value:function(){this.tween&&this.tween.start()}},{key:"getGeometry",value:function(){for(var e=new THREE.Geometry,t=100,i=0,o=0;o<=1;o+=1/t){var n=this.spline.getPoint(o);e.vertices[i]=new THREE.Vector3(n.x,n.y,n.z),i++}return e}}]),e}(),Potree.Version=function(e){this.version=e;var t=e.indexOf(".")===-1?e.length:e.indexOf(".");this.versionMajor=parseInt(e.substr(0,t)),this.versionMinor=parseInt(e.substr(t+1)),0===this.versionMinor.length&&(this.versionMinor=0)},Potree.Version.prototype.newerThan=function(e){var t=new Potree.Version(e);return this.versionMajor>t.versionMajor||this.versionMajor===t.versionMajor&&this.versionMinor>t.versionMinor},Potree.Version.prototype.equalOrHigher=function(e){var t=new Potree.Version(e);return this.versionMajor>t.versionMajor||this.versionMajor===t.versionMajor&&this.versionMinor>=t.versionMinor},Potree.Version.prototype.upTo=function(e){return!this.newerThan(e)};var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,i,o){return i&&e(t.prototype,i),o&&e(t,o),t}}();Potree.Measure=function(){function e(){_classCallCheck(this,e),this.sceneNode=new THREE.Object3D,this.dispatcher=new THREE.EventDispatcher,this.points=[],this._showDistances=!0,this._showCoordinates=!1,this._showArea=!1,this._closed=!0,this._showAngles=!1,this.maxMarkers=Number.MAX_SAFE_INTEGER,this.spheres=[],this.edges=[],this.sphereLabels=[],this.edgeLabels=[],this.angleLabels=[],this.coordinateLabels=[],this.areaLabel=new Potree.TextSprite(""),this.areaLabel.setBorderColor({r:0,g:0,b:0,a:.8}),this.areaLabel.setBackgroundColor({r:0,g:0,b:0,a:.3}),this.areaLabel.setTextColor({r:180,g:220,b:180,a:1}),this.areaLabel.material.depthTest=!1,this.areaLabel.material.opacity=1,this.areaLabel.visible=!1,this.sceneNode.add(this.areaLabel),this.sphereGeometry=new THREE.SphereGeometry(.4,10,10),this.color=new THREE.Color(16711680)}return _createClass(e,[{key:"createSphereMaterial",value:function(){var e=new THREE.MeshLambertMaterial({shading:THREE.SmoothShading,color:this.color,depthTest:!1,depthWrite:!1});return e}},{key:"addMarker",value:function(e){var t=this;e instanceof THREE.Vector3&&(e={position:e}),this.points.push(e);var i=new THREE.Mesh(this.sphereGeometry,this.createSphereMaterial()),o=function(e){e.target.material.emissive.setHex(8947848)},n=function(e){e.target.material.emissive.setHex(0)},r=function(e){var i=e.tool,o=(i.dragstart,i.mouse,i.getMousePointCloudIntersection.bind(i)());if(o){var n=t.spheres.indexOf(i.dragstart.object);t.setMarker(n,o)}e.event.stopImmediatePropagation()},s=function(e){};i.addEventListener("move",o),i.addEventListener("leave",n),i.addEventListener("drag",r),i.addEventListener("drop",s),this.sceneNode.add(i),this.spheres.push(i);var a=new THREE.Geometry;a.vertices.push(new THREE.Vector3,new THREE.Vector3),a.colors.push(this.color,this.color,this.color);var l=new THREE.LineBasicMaterial({linewidth:1});l.depthTest=!1;var d=new THREE.Line(a,l);d.visible=!0,this.sceneNode.add(d),this.edges.push(d);var c=new Potree.TextSprite;c.setBorderColor({r:0,g:0,b:0,a:.8}),c.setBackgroundColor({r:0,g:0,b:0,a:.3}),c.material.depthTest=!1,c.visible=!1,this.edgeLabels.push(c),this.sceneNode.add(c);var u=new Potree.TextSprite;u.setBorderColor({r:0,g:0,b:0,a:.8}),u.setBackgroundColor({r:0,g:0,b:0,a:.3}),u.material.depthTest=!1,u.material.opacity=1,u.visible=!1,this.angleLabels.push(u),this.sceneNode.add(u);var h=new Potree.TextSprite;h.setBorderColor({r:0,g:0,b:0,a:.8}),h.setBackgroundColor({r:0,g:0,b:0,a:.3}),h.material.depthTest=!1,h.material.opacity=1,h.visible=!1,this.coordinateLabels.push(h),this.sceneNode.add(h);var p={type:"marker_added",measurement:this};this.dispatcher.dispatchEvent(p),this.setMarker(this.points.length-1,e)}},{key:"removeMarker",value:function(e){this.points.splice(e,1),this.sceneNode.remove(this.spheres[e]);var t=0===e?0:e-1;this.sceneNode.remove(this.edges[t]),this.edges.splice(t,1),this.sceneNode.remove(this.edgeLabels[t]),this.edgeLabels.splice(t,1),this.coordinateLabels.splice(e,1),this.spheres.splice(e,1),this.update(),this.dispatcher.dispatchEvent({type:"marker_removed",measurement:this})}},{key:"setMarker",value:function(e,t){this.points[e]=t;var i={type:"marker_moved",measure:this,index:e,position:t.position.clone()};this.dispatcher.dispatchEvent(i),this.update()}},{key:"setPosition",value:function(e,t){var i=this.points[e];i.position.copy(t);var o={type:"marker_moved",measure:this,index:e,position:t.clone()};this.dispatcher.dispatchEvent(o),this.update()}},{key:"getArea",value:function(){for(var e=0,t=this.points.length-1,i=0;i<this.points.length;i++){var o=this.points[i].position,n=this.points[t].position;e+=(n.x+o.x)*(o.z-n.z),t=i}return Math.abs(e/2)}},{key:"getAngleBetweenLines",value:function(e,t,i){var o=(new THREE.Vector3).subVectors(t.position,e.position),n=(new THREE.Vector3).subVectors(i.position,e.position);return o.angleTo(n)}},{key:"getAngle",value:function(e){if(this.points.length<3||e>=this.points.length)return 0;var t=0===e?this.points[this.points.length-1]:this.points[e-1],i=this.points[e],o=this.points[(e+1)%this.points.length];return this.getAngleBetweenLines(i,t,o)}},{key:"update",value:function(){if(0!==this.points.length){if(1===this.points.length){var e=this.points[0],t=e.position;this.spheres[0].position.copy(t);var i=this.coordinateLabels[0],o=t.clone().add(new THREE.Vector3(0,1,0));i.position.copy(o);var n=Potree.utils.addCommas(t.x.toFixed(2))+" / "+Potree.utils.addCommas(t.y.toFixed(2))+" / "+Potree.utils.addCommas(t.z.toFixed(2));return void i.setText(n)}for(var r=this.points.length-1,s=new THREE.Vector3,a=0;a<=r;a++){var l=this.points[a];s.add(l.position)}s.divideScalar(this.points.length);for(var d=0;d<=r;d++){var c=d,u=d+1>r?0:d+1,h=0===d?r:d-1,p=this.points[c],m=this.points[u],f=this.points[h],v=this.spheres[c];v.position.copy(p.position),v.material.color=this.color;var g=this.edges[c];g.material.color=this.color,g.geometry.vertices[0].copy(p.position),g.geometry.vertices[1].copy(m.position),g.geometry.verticesNeedUpdate=!0,g.geometry.computeBoundingSphere(),g.visible=c<r||this.closed;var y=this.edgeLabels[d],E=(new THREE.Vector3).add(p.position);E.add(m.position),E=E.multiplyScalar(.5);var b=p.position.distanceTo(m.position);y.position.copy(E),y.setText(Potree.utils.addCommas(b.toFixed(2))),y.visible=this.showDistances&&(c<r||this.closed)&&this.points.length>=2&&b>0;var T=this.angleLabels[d],P=this.getAngleBetweenLines(p,f,m),R=m.position.clone().sub(f.position);R.multiplyScalar(.5),R=f.position.clone().add(R).sub(p.position).normalize();var C=Math.min(p.position.distanceTo(f.position),p.position.distanceTo(m.position));C/=9;var w=p.position.clone().add(R.multiplyScalar(C));T.position.copy(w);var x=Potree.utils.addCommas((P*(180/Math.PI)).toFixed(1))+"";T.setText(x),T.visible=this.showAngles&&(c<r||this.closed)&&this.points.length>=3&&P>0;var S=this.coordinateLabels[0],H=p.position.clone().add(new THREE.Vector3(0,1,0));S.position.copy(H);var B=Potree.utils.addCommas(p.position.x.toFixed(2))+" / "+Potree.utils.addCommas(p.position.y.toFixed(2))+" / "+Potree.utils.addCommas(p.position.z.toFixed(2));S.setText(B),S.visible=this.showCoordinates&&(c<r||this.closed)}this.areaLabel.position.copy(s),this.areaLabel.visible=this.showArea&&this.points.length>=3;var V=Potree.utils.addCommas(this.getArea().toFixed(1))+"";this.areaLabel.setText(V)}}},{key:"raycast",value:function(e,t){for(var i=0;i<this.points.length;i++){var o=this.spheres[i];o.raycast(e,t)}for(var n=0;n<t.length;n++){var r=t[n];r.distance=e.ray.origin.distanceTo(r.point)}t.sort(function(e,t){return e.distance-t.distance})}},{key:"showCoordinates",get:function(){return this._showCoordinates},set:function(e){this._showCoordinates=e,this.update()}},{key:"showAngles",get:function(){return this._showAngles},set:function(e){this._showAngles=e,this.update()}},{key:"showArea",get:function(){return this._showArea},set:function(e){this._showArea=e,this.update()}},{key:"closed",get:function(){return this._closed},set:function(e){this._closed=e,this.update()}},{key:"showDistances",get:function(){return this._showDistances},set:function(e){this._showDistances=e,this.update()}}]),e}();var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,i,o){return i&&e(t.prototype,i),o&&e(t,o),t}}();Potree.MeasuringTool=function(){function e(t){_classCallCheck(this,e),this.enabled=!1,this.scene=null,this.renderer=t,this.domElement=t.domElement,this.mouse={x:0,y:0},this.STATE={DEFAULT:0,INSERT:1},this.state=this.STATE.DEFAULT,this.activeMeasurement=null,this.sceneMeasurement=new THREE.Scene,this.sceneRoot=new THREE.Object3D,this.sceneMeasurement.add(this.sceneRoot),this.light=new THREE.DirectionalLight(16777215,1),this.light.position.set(0,0,10),this.light.lookAt(new THREE.Vector3(0,0,0)),this.sceneMeasurement.add(this.light),this.hoveredElement=null,this.dispatcher=new THREE.EventDispatcher;var i=function(e){if(this.state===this.STATE.INSERT){var t=this.getMousePointCloudIntersection();if(t){var i=t.position.clone();this.activeMeasurement.addMarker(i);var o={type:"newpoint",position:i.clone()};this.dispatcher.dispatchEvent(o),this.activeMeasurement.points.length>this.activeMeasurement.maxMarkers&&this.finishInsertion()}}}.bind(this),o=function(e){if(this.scene){var t=this.domElement.getBoundingClientRect();if(this.mouse.x=(e.clientX-t.left)/this.domElement.clientWidth*2-1,this.mouse.y=2*-((e.clientY-t.top)/this.domElement.clientHeight)+1,this.dragstart){var i={type:"drag",event:e,tool:this};this.dragstart.object.dispatchEvent(i)}else if(this.state==this.STATE.INSERT&&this.activeMeasurement){var o=this.getMousePointCloudIntersection();if(o){var n=this.activeMeasurement.points.length-1;this.activeMeasurement.setMarker(n,o)}}else{var r=this.getHoveredElement();r?(r.object.dispatchEvent({type:"move",target:r.object,event:e}),this.hoveredElement&&this.hoveredElement!==r.object&&this.hoveredElement.dispatchEvent({type:"leave",target:this.hoveredElement,event:e}),this.hoveredElement=r.object):(this.hoveredElement&&this.hoveredElement.dispatchEvent({type:"leave",target:this.hoveredElement,event:e}),this.hoveredElement=null)}}}.bind(this),n=function(e){this.state==this.STATE.INSERT&&this.finishInsertion()}.bind(this),r=function(e){if(1===e.which){this.state!==this.STATE.DEFAULT&&e.stopImmediatePropagation();var t=this.getHoveredElement();t&&(this.dragstart={object:t.object,sceneClickPos:t.point,sceneStartPos:this.sceneRoot.position.clone(),mousePos:{x:this.mouse.x,y:this.mouse.y}},e.stopImmediatePropagation())}else 3===e.which&&n(e)}.bind(this),s=function(e){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty(),this.activeMeasurement&&this.state===this.STATE.INSERT&&(this.activeMeasurement.removeMarker(this.activeMeasurement.points.length-1),this.finishInsertion(),e.stopImmediatePropagation())}.bind(this),a=function(e){this.dragstart&&(this.dragstart.object.dispatchEvent({type:"drop",event:e}),this.dragstart=null)}.bind(this);this.domElement.addEventListener("click",i,!1),this.domElement.addEventListener("dblclick",s,!1),this.domElement.addEventListener("mousemove",o,!1),this.domElement.addEventListener("mousedown",r,!1),this.domElement.addEventListener("mouseup",a,!0)}return _createClass(e,[{key:"setScene",value:function(e){var t=this;this.scene=e,this.measurements=this.scene.measurements,this.activeMeasurement=null,this.sceneMeasurement=new THREE.Scene,this.sceneRoot=new THREE.Object3D,this.sceneMeasurement.add(this.sceneRoot),this.light=new THREE.DirectionalLight(16777215,1),this.light.position.set(0,0,10),this.light.lookAt(new THREE.Vector3(0,0,0)),this.sceneMeasurement.add(this.light);var i=!0,o=!1,n=void 0;try{for(var r,s=this.scene.measurements[Symbol.iterator]();!(i=(r=s.next()).done);i=!0){var a=r.value;this.sceneMeasurement.add(a.sceneNode)}}catch(e){o=!0,n=e}finally{try{!i&&s.return&&s.return()}finally{if(o)throw n}}this.scene.addEventListener("measurement_added",function(e){t.scene===e.scene&&t.sceneMeasurement.add(e.measurement.sceneNode)}),this.scene.addEventListener("measurement_removed",function(e){t.scene===e.scene&&t.sceneMeasurement.remove(e.measurement.sceneNode)})}},{key:"addEventListener",value:function(e,t){this.dispatcher.addEventListener(e,t)}},{key:"getHoveredElement",value:function(){var e=new THREE.Vector3(this.mouse.x,this.mouse.y,.5);e.unproject(this.scene.camera);var t=new THREE.Raycaster;t.ray.set(this.scene.camera.position,e.sub(this.scene.camera.position).normalize());for(var i=[],o=0;o<this.measurements.length;o++)for(var n=this.measurements[o],r=0;r<n.spheres.length;r++)i.push(n.spheres[r]);var s=t.intersectObjects(i,!0);return s.length>0&&s[0]}},{key:"getMousePointCloudIntersection",value:function(){var e=new THREE.Vector3(this.mouse.x,this.mouse.y,.5);e.unproject(this.scene.camera);var t=e.sub(this.scene.camera.position).normalize(),i=new THREE.Ray(this.scene.camera.position,t),o=[];this.scene.scenePointCloud.traverse(function(e){(e instanceof Potree.PointCloudOctree||e instanceof Potree.PointCloudArena4D)&&o.push(e)});for(var n=null,r=null,s=0;s<o.length;s++){var a=o[s],l=a.pick(this.renderer,this.scene.camera,i);if(l){var d=this.scene.camera.position.distanceTo(l.position);(!n||d<r)&&(n=l,r=d)}}return n?n:null}},{key:"startInsertion",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.state=this.STATE.INSERT;var t="undefined"==typeof e.showDistances||e.showDistances,i="undefined"!=typeof e.showArea&&e.showArea,o="undefined"!=typeof e.showAngles&&e.showAngles,n="undefined"!=typeof e.closed&&e.closed,r="undefined"!=typeof e.showCoordinates&&e.showCoordinates,s=e.maxMarkers||Number.MAX_SAFE_INTEGER,a=new Potree.Measure;return a.showDistances=t,a.showArea=i,a.showAngles=o,a.closed=n,a.showCoordinates=r,a.maxMarkers=s,a.addMarker(new THREE.Vector3(1/0,1/0,1/0)),this.scene.addMeasurement(a),this.activeMeasurement=a,this.activeMeasurement}},{key:"finishInsertion",value:function(){this.activeMeasurement.removeMarker(this.activeMeasurement.points.length-1);var e={type:"insertion_finished",measurement:this.activeMeasurement};this.dispatcher.dispatchEvent(e),this.activeMeasurement=null,this.state=this.STATE.DEFAULT}},{key:"update",value:function(){if(this.scene){for(var e=[],t=0;t<this.measurements.length;t++)e.push(this.measurements[t]);this.activeMeasurement&&e.push(this.activeMeasurement);for(var i=0;i<e.length;i++){for(var o=e[i],n=0;n<o.spheres.length;n++){var r=o.spheres[n],s=this.scene.camera.position.distanceTo(r.getWorldPosition()),a=Potree.utils.projectedRadius(1,this.scene.camera.fov*Math.PI/180,s,this.renderer.domElement.clientHeight),l=15/a;r.scale.set(l,l,l)}for(var d=0;d<o.edgeLabels.length;d++){var c=o.edgeLabels[d],u=this.scene.camera.position.distanceTo(c.getWorldPosition()),h=Potree.utils.projectedRadius(1,this.scene.camera.fov*Math.PI/180,u,this.renderer.domElement.clientHeight),p=70/h;c.scale.set(p,p,p)}for(var m=0;m<o.edgeLabels.length;m++){var f=o.angleLabels[m],v=this.scene.camera.position.distanceTo(f.getWorldPosition()),g=Potree.utils.projectedRadius(1,this.scene.camera.fov*Math.PI/180,v,this.renderer.domElement.clientHeight),y=70/g;f.scale.set(y,y,y)}for(var E=0;E<o.coordinateLabels.length;E++){var b=o.coordinateLabels[E],T=o.spheres[E],P=(o.points[E],this.scene.camera.position.distanceTo(T.getWorldPosition())),R=T.getWorldPosition().clone().project(this.scene.camera);R.x=Math.round((R.x+1)*this.renderer.domElement.clientWidth/2),R.y=Math.round((-R.y+1)*this.renderer.domElement.clientHeight/2),R.z=0,R.y-=30;var C=new THREE.Vector3(R.x/this.renderer.domElement.clientWidth*2-1,2*-(R.y/this.renderer.domElement.clientHeight)+1,.5);C.unproject(this.scene.camera);var w=C.sub(this.scene.camera.position).normalize();C=(new THREE.Vector3).addVectors(this.scene.camera.position,w.multiplyScalar(P)),b.position.copy(C);var x=Potree.utils.projectedRadius(1,this.scene.camera.fov*Math.PI/180,P,this.renderer.domElement.clientHeight),S=70/x;b.scale.set(S,S,S)}var H=this.scene.camera.position.distanceTo(o.areaLabel.getWorldPosition()),B=Potree.utils.projectedRadius(1,this.scene.camera.fov*Math.PI/180,H,this.renderer.domElement.clientHeight),V=80/B;o.areaLabel.scale.set(V,V,V)}this.light.position.copy(this.scene.camera.position),this.light.lookAt(this.scene.camera.getWorldDirection().add(this.scene.camera.position))}}},{key:"render",value:function(){this.update(),this.renderer.render(this.sceneMeasurement,this.scene.camera)}}]),e}();var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,i,o){return i&&e(t.prototype,i),o&&e(t,o),t}}();Potree.Profile=function(){function e(){_classCallCheck(this,e),this.sceneNode=new THREE.Object3D,this.dispatcher=new THREE.EventDispatcher,this.points=[],this.spheres=[],this.edges=[],this.boxes=[],this.width=1,this.height=20,this._modifiable=!0,this.sphereGeometry=new THREE.SphereGeometry(.4,10,10),this.color=new THREE.Color(16711680),this.lineColor=new THREE.Color(16711680)}return _createClass(e,[{key:"createSphereMaterial",value:function(){var e=new THREE.MeshLambertMaterial({shading:THREE.SmoothShading,color:16711680,depthTest:!1,depthWrite:!1});return e}},{key:"addMarker",value:function(e){var t=this;this.points.push(e);var i=new THREE.Mesh(this.sphereGeometry,this.createSphereMaterial()),o=function(e){i.material.emissive.setHex(8947848)},n=function(e){e.target.material.emissive.setHex(0)},r=function(e){var i=e.tool,o=i.dragstart,n=i.mouse;if(e.event.ctrlKey){var r=new THREE.Vector3(o.mousePos.x,o.mousePos.y,0),s=new THREE.Vector3(n.x,n.y,0),a=o.widthStart,l=1-10*(r.y-s.y);l=Math.max(.01,l),a&&t.setWidth(a*l)}else{var d=i.getMousePointCloudIntersection.bind(i)();if(d){var c=t.spheres.indexOf(i.dragstart.object);t.setPosition(c,d)}}e.event.stopImmediatePropagation()},s=function(e){};if(i.addEventListener("mousemove",o),i.addEventListener("mouseleave",n),i.addEventListener("mousedrag",r),i.addEventListener("drop",s),this.sceneNode.add(i),this.spheres.push(i),this.points.length>1){var a=new THREE.Geometry;a.vertices.push(new THREE.Vector3,new THREE.Vector3),a.colors.push(this.lineColor,this.lineColor,this.lineColor);var l=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,linewidth:2,transparent:!0,opacity:.4});l.depthTest=!1;var d=new THREE.Line(a,l);d.visible=!1,this.sceneNode.add(d),this.edges.push(d);var c=new THREE.BoxGeometry(1,1,1),u=new THREE.MeshBasicMaterial({color:16711680,transparent:!0,opacity:.2}),h=new THREE.Mesh(c,u);h.visible=!1,this.sceneNode.add(h),this.boxes.push(h)}var p={type:"marker_added",profile:this};this.dispatcher.dispatchEvent(p),this.setPosition(this.points.length-1,e)}},{key:"removeMarker",value:function(e){this.points.splice(e,1),this.sceneNode.remove(this.spheres[e]);var t=0===e?0:e-1;this.sceneNode.remove(this.edges[t]),this.edges.splice(t,1),this.sceneNode.remove(this.boxes[t]),this.boxes.splice(t,1),this.spheres.splice(e,1),this.update(),this.dispatcher.dispatchEvent({type:"marker_removed",profile:this})}},{key:"setPosition",value:function(e,t){var i=this.points[e];i.copy(t);var o={type:"marker_moved",profile:this,index:e,position:i.clone()};this.dispatcher.dispatchEvent(o),this.update()}},{key:"setWidth",value:function(e){this.width=e;var t={type:"width_changed",profile:this,width:e};this.dispatcher.dispatchEvent(t),this.update()}},{key:"getWidth",value:function(){return this.width}},{key:"update",value:function(){if(0!==this.points.length){if(1===this.points.length){var e=this.points[0];return void this.spheres[0].position.copy(e)}for(var t=this.points[0].clone(),i=this.points[0].clone(),o=new THREE.Vector3,n=this.points.length-1,r=0;r<=n;r++){var s=this.points[r],a=this.spheres[r],l=0===r?n:r-1,d=r===n?0:r+1,c=this.points[l],u=this.points[d],h=this.edges[l],p=this.edges[r],m=this.boxes[l];this.boxes[r],s.distanceTo(c),s.distanceTo(u),(new THREE.Vector3).addVectors(c,s).multiplyScalar(.5),(new THREE.Vector3).addVectors(s,u).multiplyScalar(.5);if(a.position.copy(s),this._modifiable?a.visible=!0:a.visible=!1,h&&(h.geometry.vertices[1].copy(s),h.geometry.verticesNeedUpdate=!0,h.geometry.computeBoundingSphere()),p&&(p.geometry.vertices[0].copy(s),p.geometry.verticesNeedUpdate=!0,
p.geometry.computeBoundingSphere()),m){var f=c,v=s,g=f.clone().setZ(0).distanceTo(v.clone().setZ(0));m.scale.set(g,1e6,this.width),m.up.set(0,0,1);var y=(new THREE.Vector3).addVectors(f,v).multiplyScalar(.5),E=(new THREE.Vector3).subVectors(v,f),b=new THREE.Vector3(E.y,(-E.x),0);m.position.set(0,0,0),m.lookAt(b),m.position.copy(y)}o.add(s),t.min(s),i.max(s)}o.multiplyScalar(1/this.points.length);for(var r=0;r<this.boxes.length;r++){var T=this.boxes[r];T.position.z=t.z+(i.z-t.z)/2}}}},{key:"raycast",value:function(e,t){for(var i=0;i<this.points.length;i++){var o=this.spheres[i];o.raycast(e,t)}for(var n=0;n<t.length;n++){var r=t[n];r.distance=e.ray.origin.distanceTo(r.point)}t.sort(function(e,t){return e.distance-t.distance})}},{key:"modifiable",get:function(){return this._modifiable},set:function(e){this._modifiable=e,this.update()}}]),e}(),Potree.ProfileTool=function(e){function t(e){if(c===d.INSERT){var t=l.getMousePointCloudIntersection();if(t){var i=t.clone();1===l.activeProfile.points.length&&null===l.activeProfile.width&&l.activeProfile.setWidth(l.scene.camera.position.distanceTo(i)/50),l.activeProfile.addMarker(i);var e={type:"newpoint",position:i.clone()};l.dispatchEvent(e)}}}function i(e){if(l.scene){var t=l.domElement.getBoundingClientRect();if(l.mouse.x=(e.clientX-t.left)/l.domElement.clientWidth*2-1,l.mouse.y=2*-((e.clientY-t.top)/l.domElement.clientHeight)+1,l.dragstart){var i={type:"mousedrag",event:e,tool:l};l.dragstart.object.dispatchEvent(i)}else if(c==d.INSERT&&l.activeProfile){var o=l.getMousePointCloudIntersection();if(o){var n=l.activeProfile.points.length-1;l.activeProfile.setPosition(n,o)}}else{var o=a();o?(o.object.dispatchEvent({type:"mousemove",target:o.object,event:e}),l.hoveredElement&&l.hoveredElement!==o.object&&l.hoveredElement.dispatchEvent({type:"mouseleave",target:l.hoveredElement,event:e}),l.hoveredElement=o.object):(l.hoveredElement&&l.hoveredElement.dispatchEvent({type:"mouseleave",target:l.hoveredElement,event:e}),l.hoveredElement=null)}}}function o(e){c==d.INSERT&&l.finishInsertion()}function n(e){if(c!==d.DEFAULT&&e.stopImmediatePropagation(),1===e.which){var t=a();if(t){for(var i=null,n=0;n<l.profiles.length;n++)for(var r=l.profiles[n],s=0;s<r.spheres.length;s++){var u=r.spheres[s];u===t.object&&(i=r.width)}l.dragstart={object:t.object,sceneClickPos:t.point,sceneStartPos:l.sceneRoot.position.clone(),mousePos:{x:l.mouse.x,y:l.mouse.y},widthStart:i},e.stopImmediatePropagation()}}else 3===e.which&&o(e)}function r(e){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty(),l.activeProfile&&c===d.INSERT&&(l.activeProfile.removeMarker(l.activeProfile.points.length-1),l.finishInsertion(),e.stopImmediatePropagation())}function s(e){l.dragstart&&(l.dragstart.object.dispatchEvent({type:"drop",event:e}),l.dragstart=null)}function a(){var e=new THREE.Vector3(l.mouse.x,l.mouse.y,.5);e.unproject(l.scene.camera);var t=new THREE.Raycaster;t.ray.set(l.scene.camera.position,e.sub(l.scene.camera.position).normalize());var i=t.intersectObjects(l.profiles);return i.length>0&&i[0]}var l=this;this.enabled=!1,this.scene=null,this.renderer=e,this.domElement=e.domElement,this.mouse={x:0,y:0};var d={DEFAULT:0,INSERT:1},c=d.DEFAULT;new THREE.SphereGeometry(.4,10,10);this.activeProfile=null,this.profiles=[],this.sceneProfile=new THREE.Scene,this.sceneRoot=new THREE.Object3D,this.sceneProfile.add(this.sceneRoot),this.light=new THREE.DirectionalLight(16777215,1),this.light.position.set(0,0,10),this.light.lookAt(new THREE.Vector3(0,0,0)),this.sceneProfile.add(this.light),this.hoveredElement=null,this.setScene=function(e){var t=this;this.scene=e,this.profiles=this.scene.profiles,this.activeProfile=null,this.sceneProfile=new THREE.Scene,this.sceneRoot=new THREE.Object3D,this.sceneProfile.add(this.sceneRoot),this.light=new THREE.DirectionalLight(16777215,1),this.light.position.set(0,0,10),this.light.lookAt(new THREE.Vector3(0,0,0)),this.sceneProfile.add(this.light);var i=!0,o=!1,n=void 0;try{for(var r,s=this.scene.profiles[Symbol.iterator]();!(i=(r=s.next()).done);i=!0){var a=r.value;this.sceneProfile.add(a.sceneNode)}}catch(e){o=!0,n=e}finally{try{!i&&s.return&&s.return()}finally{if(o)throw n}}var l=function(e){t.scene===e.scene&&t.sceneProfile.add(e.profile.sceneNode)},d=function(e){t.scene===e.scene&&t.sceneProfile.remove(e.profile.sceneNode)};e.addEventListener("profile_added",l),e.addEventListener("profile_removed",d)},this.getMousePointCloudIntersection=function(){var e=new THREE.Vector3(l.mouse.x,l.mouse.y,.5);e.unproject(l.scene.camera);var t=e.sub(l.scene.camera.position).normalize(),i=new THREE.Ray(l.scene.camera.position,t),o=[];l.scene.scenePointCloud.traverse(function(e){(e instanceof Potree.PointCloudOctree||e instanceof Potree.PointCloudArena4D)&&o.push(e)});for(var n=null,r=null,s=0;s<o.length;s++){var a=o[s],d=a.pick(l.renderer,l.scene.camera,i,{pickOutsideClipRegion:!0});if(d){var c=l.scene.camera.position.distanceTo(d.position);(!n||c<r)&&(n=d,r=c)}}return n?n.position:null},this.startInsertion=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};c=d.INSERT;var t=e.clip||!1,i=e.width||null,o=new Potree.Profile;return o.clip=t,o.setWidth(i),o.addMarker(new THREE.Vector3(0,0,0)),this.scene.addProfile(o),this.activeProfile=o,this.activeProfile},this.finishInsertion=function(){this.activeProfile.removeMarker(this.activeProfile.points.length-1);var e={type:"insertion_finished",profile:this.activeProfile};this.dispatchEvent(e),this.activeProfile=null,c=d.DEFAULT},this.addProfile=function(e){this.profiles.push(e),this.sceneProfile.add(e),e.update(),this.dispatchEvent({type:"profile_added",profile:e}),e.addEventListener("marker_added",function(e){l.dispatchEvent(e)}),e.addEventListener("marker_removed",function(e){l.dispatchEvent(e)}),e.addEventListener("marker_moved",function(e){l.dispatchEvent(e)}),e.addEventListener("width_changed",function(e){l.dispatchEvent(e)})},this.reset=function(){for(var e=this.profiles.length-1;e>=0;e--){var t=this.profiles[e];this.removeProfile(t)}},this.update=function(){for(var t=0;t<this.profiles.length;t++)for(var i=this.profiles[t],o=0;o<i.spheres.length;o++){var n=i.spheres[o],r=l.scene.camera.position.distanceTo(n.getWorldPosition()),s=Potree.utils.projectedRadius(1,l.scene.camera.fov*Math.PI/180,r,e.domElement.clientHeight),a=15/s;n.scale.set(a,a,a)}this.light.position.copy(this.scene.camera.position),this.light.lookAt(this.scene.camera.getWorldDirection().add(this.scene.camera.position))},this.render=function(){this.update(),e.render(this.sceneProfile,this.scene.camera)},this.domElement.addEventListener("click",t,!1),this.domElement.addEventListener("dblclick",r,!1),this.domElement.addEventListener("mousemove",i,!1),this.domElement.addEventListener("mousedown",n,!1),this.domElement.addEventListener("mouseup",s,!0)},Potree.ProfileTool.prototype=Object.create(THREE.EventDispatcher.prototype);